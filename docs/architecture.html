<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickVote - Architecture</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
            --border: #475569;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle { color: var(--text-secondary); font-size: 1.1rem; }

        h2 {
            font-size: 1.5rem;
            margin: 2.5rem 0 1rem;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--accent-blue);
            border-radius: 2px;
        }

        h3 {
            font-size: 1.2rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--text-primary);
        }

        p { margin-bottom: 1rem; color: var(--text-secondary); }

        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        pre {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: var(--accent-cyan);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
        }

        td { color: var(--text-secondary); }

        ul, ol {
            margin: 0.5rem 0 1rem 1.5rem;
            color: var(--text-secondary);
        }

        li { margin-bottom: 0.5rem; }

        .diagram-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            overflow-x: auto;
        }

        .flow-diagram {
            display: inline-block;
            text-align: left;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre;
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .badge-green { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        footer a { color: var(--accent-blue); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        .nav-link {
            display: inline-block;
            margin-top: 1rem;
            color: var(--accent-blue);
            text-decoration: none;
        }
        .nav-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Architecture</h1>
            <p class="subtitle">Technical architecture of QuickVote</p>
            <a href="index.html" class="nav-link">← Back to Documentation</a>
        </header>

        <section class="section">
            <h2>System Overview</h2>
            <p>QuickVote is a client-side React application backed by Supabase for database, authentication, and real-time synchronization. The admin controls session flow from a dashboard while participants vote on their mobile devices.</p>

            <div class="diagram-box">
                <svg width="600" height="300" viewBox="0 0 600 300">
                    <!-- Admin Browser -->
                    <rect x="50" y="20" width="140" height="60" rx="8" fill="#1e293b" stroke="#a855f7" stroke-width="2"/>
                    <text x="120" y="45" text-anchor="middle" fill="#f1f5f9" font-size="12" font-weight="600">Admin Browser</text>
                    <text x="120" y="62" text-anchor="middle" fill="#94a3b8" font-size="10">(Dashboard)</text>

                    <!-- Participant Browser -->
                    <rect x="410" y="20" width="140" height="60" rx="8" fill="#1e293b" stroke="#06b6d4" stroke-width="2"/>
                    <text x="480" y="45" text-anchor="middle" fill="#f1f5f9" font-size="12" font-weight="600">Participant</text>
                    <text x="480" y="62" text-anchor="middle" fill="#94a3b8" font-size="10">(Mobile Browser)</text>

                    <!-- Arrows to Supabase -->
                    <path d="M 120 80 L 120 120 L 250 120 L 250 140" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M 480 80 L 480 120 L 350 120 L 350 140" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <text x="300" y="115" text-anchor="middle" fill="#eab308" font-size="10">Supabase Realtime (WebSocket)</text>

                    <!-- Supabase Box -->
                    <rect x="150" y="140" width="300" height="140" rx="8" fill="#1e293b" stroke="#22c55e" stroke-width="2"/>
                    <text x="300" y="165" text-anchor="middle" fill="#22c55e" font-size="14" font-weight="600">Supabase</text>

                    <!-- PostgreSQL -->
                    <rect x="170" y="180" width="100" height="40" rx="4" fill="#334155"/>
                    <text x="220" y="200" text-anchor="middle" fill="#f1f5f9" font-size="10" font-weight="600">PostgreSQL</text>
                    <text x="220" y="212" text-anchor="middle" fill="#94a3b8" font-size="9">(Database)</text>

                    <!-- Realtime -->
                    <rect x="290" y="180" width="100" height="40" rx="4" fill="#334155"/>
                    <text x="340" y="200" text-anchor="middle" fill="#f1f5f9" font-size="10" font-weight="600">Realtime</text>
                    <text x="340" y="212" text-anchor="middle" fill="#94a3b8" font-size="9">(Broadcast)</text>

                    <!-- Auth -->
                    <rect x="230" y="230" width="100" height="35" rx="4" fill="#334155"/>
                    <text x="280" y="252" text-anchor="middle" fill="#f1f5f9" font-size="10" font-weight="600">Anonymous Auth</text>

                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </section>

        <section class="section">
            <h2>Data Model</h2>

            <h3>Core Entities</h3>

            <table>
                <tr>
                    <th>Entity</th>
                    <th>Key Fields</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>sessions</code></td>
                    <td>id, session_id, admin_token, status</td>
                    <td>Voting session container</td>
                </tr>
                <tr>
                    <td><code>batches</code></td>
                    <td>id, session_id, name, position, status</td>
                    <td>Groups questions for batch voting</td>
                </tr>
                <tr>
                    <td><code>questions</code></td>
                    <td>id, session_id, batch_id, text, type, status</td>
                    <td>Individual poll questions</td>
                </tr>
                <tr>
                    <td><code>votes</code></td>
                    <td>id, question_id, participant_id, value, reason</td>
                    <td>Participant vote records</td>
                </tr>
            </table>

            <h3>Entity Relationships</h3>
            <ul>
                <li>A <strong>Session</strong> contains many <strong>Questions</strong> and <strong>Batches</strong></li>
                <li>A <strong>Batch</strong> groups multiple <strong>Questions</strong> for simultaneous voting</li>
                <li>A <strong>Question</strong> can belong to a Batch (batched) or stand alone (unbatched)</li>
                <li>A <strong>Question</strong> receives many <strong>Votes</strong> from participants</li>
                <li>Each participant can submit one <strong>Vote</strong> per Question (upsert on conflict)</li>
            </ul>
        </section>

        <section class="section">
            <h2>Application Structure</h2>

            <pre>src/
├── components/          # Reusable UI components
│   ├── BarChart.tsx        # Vote result visualization
│   ├── BatchVotingCarousel.tsx  # Participant batch voting UI
│   ├── VoteAgreeDisagree.tsx    # Agree/Disagree voting buttons
│   ├── VoteMultipleChoice.tsx   # Multiple choice voting cards
│   ├── QRCode.tsx          # Join QR code generator
│   └── ...
│
├── pages/               # Route components
│   ├── Home.tsx            # Landing page with join form
│   ├── AdminSession.tsx    # Main admin dashboard (~1400 LOC)
│   ├── ParticipantSession.tsx  # Participant voting view
│   └── SessionReview.tsx   # Post-session results review
│
├── hooks/               # Custom React hooks
│   ├── use-realtime-channel.ts  # Supabase realtime wrapper
│   ├── use-presence.ts     # Participant presence tracking
│   ├── use-countdown.ts    # Timer hook
│   └── use-haptic.ts       # Mobile haptic feedback
│
├── stores/              # Zustand state stores
│   └── session-store.ts    # Central session state
│
├── lib/                 # Utilities
│   ├── supabase.ts         # Supabase client instance
│   ├── session-import.ts   # JSON import logic
│   ├── session-export.ts   # JSON export logic
│   └── vote-aggregation.ts # Vote counting utilities
│
└── types/               # TypeScript definitions
    └── database.ts         # Entity type definitions</pre>
        </section>

        <section class="section">
            <h2>Key Workflows</h2>

            <h3>Session Lifecycle</h3>
            <div class="diagram-box">
                <div class="flow-diagram">draft ──► lobby ──► active ──► ended
  │         │          │
  │         │          └── Results viewable, no more votes
  │         └── Participants can join, see lobby
  └── Admin-only, editing questions</div>
            </div>

            <h3>Question Flow</h3>
            <ol>
                <li>Admin creates questions (draft status)</li>
                <li>Admin activates a question → status = <code>active</code></li>
                <li>Participants see the question and vote</li>
                <li>Votes stream in via Supabase Realtime</li>
                <li>Admin closes question → status = <code>closed</code></li>
                <li>Results display with bar chart and reasons</li>
            </ol>

            <h3>Batch Voting Flow</h3>
            <ol>
                <li>Admin groups questions into a batch</li>
                <li>Admin activates batch → all batch questions become <code>active</code></li>
                <li>Participants swipe through carousel, selecting answers</li>
                <li>On "Submit All", votes upsert in parallel</li>
                <li>Admin closes batch → all questions become <code>closed</code></li>
            </ol>
        </section>

        <section class="section">
            <h2>Real-time Architecture</h2>

            <h3>Communication Patterns</h3>
            <table>
                <tr>
                    <th>Pattern</th>
                    <th>Direction</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Broadcast</span></td>
                    <td>Admin → Participants</td>
                    <td>Commands: question_activated, question_closed, batch_activated, timer_started</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Presence</span></td>
                    <td>Bidirectional</td>
                    <td>Participant count tracking, connection status</td>
                </tr>
                <tr>
                    <td><span class="badge badge-yellow">Postgres Changes</span></td>
                    <td>Database → Clients</td>
                    <td>Live vote updates, question status changes</td>
                </tr>
            </table>

            <h3>State Synchronization</h3>
            <pre>Admin Action          Broadcast Event         Participant Response
─────────────────────────────────────────────────────────────────
Activate Question  →  question_activated   →  Show voting UI
Close Question     →  question_closed      →  Show waiting state
Start Timer        →  timer_started        →  Display countdown
Activate Batch     →  batch_activated      →  Show carousel
Close Batch        →  batch_closed         →  Return to lobby</pre>
        </section>

        <section class="section">
            <h2>State Management</h2>

            <p>The <code>useSessionStore</code> (Zustand) holds all session state:</p>

            <pre>interface SessionState {
  // Data
  session: Session | null;
  questions: Question[];
  batches: Batch[];

  // Voting
  currentVote: Vote | null;
  questionVotes: Vote[];
  submitting: boolean;

  // Realtime
  participantCount: number;
  connectionStatus: ConnectionStatus;
  activeQuestionId: string | null;
  activeBatchId: string | null;
  timerEndTime: number | null;
}</pre>
        </section>

        <section class="section">
            <h2>Security Model</h2>

            <h3>Row Level Security (RLS)</h3>
            <ul>
                <li><strong>Sessions:</strong> Anyone can read; only creator can update</li>
                <li><strong>Questions:</strong> Anyone can read session questions; only session creator can modify</li>
                <li><strong>Votes:</strong> Participants can only modify their own votes</li>
                <li><strong>Batches:</strong> Same as questions</li>
            </ul>

            <h3>Authentication</h3>
            <ul>
                <li>Anonymous auth for all users (no signup required)</li>
                <li>Admin access via <code>admin_token</code> in session record</li>
                <li>Optional password gate via <code>VITE_ADMIN_PASSWORD</code> env var</li>
            </ul>
        </section>

        <section class="section">
            <h2>Environment Variables</h2>

            <table>
                <tr>
                    <th>Variable</th>
                    <th>Required</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>VITE_SUPABASE_URL</code></td>
                    <td>Yes</td>
                    <td>Supabase project URL</td>
                </tr>
                <tr>
                    <td><code>VITE_SUPABASE_ANON_KEY</code></td>
                    <td>Yes</td>
                    <td>Supabase anon/public key</td>
                </tr>
                <tr>
                    <td><code>VITE_ADMIN_PASSWORD</code></td>
                    <td>No</td>
                    <td>Password for admin pages</td>
                </tr>
            </table>
        </section>

        <footer>
            <p>QuickVote Architecture Documentation</p>
            <p><a href="index.html">← Back to Documentation</a> · <a href="threat-model.html">Threat Model</a> · <a href="user-journeys.html">User Journeys</a></p>
        </footer>
    </div>
</body>
</html>

---
phase: 19-presenter-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/pages/PresentationView.tsx
  - src/pages/AdminSession.tsx
  - src/components/PresentationControls.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can click 'Open Presentation' to launch a separate browser window showing the projected content"
    - "Presentation window displays current slide or batch content full-screen on dark background with no admin controls"
    - "Admin control view shows sequence list, current + next preview, and navigation controls when session is active"
    - "Presentation window subscribes to Realtime Broadcast and stays synced with admin navigation"
  artifacts:
    - path: "src/pages/PresentationView.tsx"
      provides: "Standalone presentation window page component"
      min_lines: 80
    - path: "src/components/PresentationControls.tsx"
      provides: "Admin control view layout with sequence list, preview panels, navigation"
      min_lines: 100
    - path: "src/App.tsx"
      provides: "Route for /presentation/:sessionId"
      contains: "PresentationView"
  key_links:
    - from: "src/pages/PresentationView.tsx"
      to: "Supabase Realtime Broadcast"
      via: "useRealtimeChannel subscribing to session channel"
      pattern: "useRealtimeChannel"
    - from: "src/components/PresentationControls.tsx"
      to: "src/pages/PresentationView.tsx"
      via: "window.open() launching /presentation/:sessionId"
      pattern: "window\\.open"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/PresentationControls.tsx"
      via: "Conditional render when presentationMode is true"
      pattern: "PresentationControls"
---

<objective>
Create the two-window presenter architecture: a standalone PresentationView page that renders projected content (slides/batches) full-screen on a dark background, and an admin PresentationControls component that replaces the current active-session view with a control panel layout (sequence list, current+next preview, navigation).

Purpose: Establishes the structural foundation for the presenter view -- two windows that can operate independently, synced via existing Realtime Broadcast. This enables the admin to control the session from one window while projecting clean output on another (even on a different device).

Output: PresentationView route + page, PresentationControls component, AdminSession integration with "Open Presentation" button and mode switch.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-presenter-view/19-CONTEXT.md
@.planning/phases/19-presenter-view/19-RESEARCH.md
@.planning/phases/18-presentation-controller/18-01-SUMMARY.md
@.planning/phases/18-presentation-controller/18-02-SUMMARY.md

Key existing files:
@src/App.tsx
@src/pages/AdminSession.tsx
@src/components/SequenceManager.tsx
@src/components/SlideDisplay.tsx
@src/hooks/use-realtime-channel.ts
@src/hooks/use-sequence-navigation.ts
@src/stores/session-store.ts
@src/types/database.ts
@src/lib/vote-aggregation.ts
@src/components/BarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PresentationView route and page component</name>
  <files>src/pages/PresentationView.tsx, src/App.tsx</files>
  <action>
    **1. Add route in App.tsx:**
    Add a new route `<Route path="/presentation/:sessionId" element={<PresentationView />} />` before the participant route. Import PresentationView from `./pages/PresentationView`.

    **2. Create src/pages/PresentationView.tsx:**
    Build a standalone page component that:

    a) **Loads session data:** Extract `sessionId` from `useParams()`. Fetch session, batches, questions, and session_items from Supabase on mount (similar to AdminSession's load pattern but simpler -- just read data, no write operations). Store in useSessionStore.

    b) **Subscribes to Realtime Broadcast:** Use `useRealtimeChannel` to subscribe to `session:${sessionId}`. In the setup callback, listen for:
    - `slide_activated` event: call `useSessionStore.getState().setActiveSessionItemId(payload.itemId)` and `setNavigationDirection(payload.direction ?? 'forward')`
    - `batch_activated` event: call `useSessionStore.getState().setActiveBatchId(payload.batchId)` and find the corresponding session_item to set activeSessionItemId
    - `session_active` event: handle session going live
    - `session_ended` event: show ended state

    c) **Renders projected content:** Full-screen dark background (#1a1a1a). Use AnimatePresence with the same slide/crossfade transition variants from AdminSession (horizontal spring for slide-to-slide, crossfade for batch transitions).
    - When active item is a slide: render `<SlideDisplay imagePath={...} caption={...} />`
    - When active item is a batch: render batch name and question count centered (matching AdminSession's batch display for now -- Plan 19-02 will add the result reveal projection)
    - When no active item: show "Waiting for presentation to start..." centered text in gray

    d) **Sets page title:** `document.title = 'QuickVote Presentation'` in a useEffect.

    e) **Shows reconnecting indicator:** When `connectionStatus === 'reconnecting'`, show a subtle pulsing orange "Reconnecting..." pill in the top-right corner (fixed position, z-50).

    f) **First-time fullscreen hint:** Show a subtle "Press F for fullscreen" text that appears for 5 seconds on first load, then fades out. Use a useState + setTimeout. Position bottom-center, text-gray-500, text-sm.

    g) **No auth required:** The presentation view is read-only projection content -- no AdminPasswordGate. Anyone with the URL can view it (this is intentional for cross-device projection on TVs/projectors).

    h) **Refetch state on reconnect:** When connectionStatus transitions from 'reconnecting' to 'connected', re-fetch the current session state (activeSessionItemId) to ensure sync. Track previous connectionStatus with a useRef.

    Do NOT add keyboard shortcuts yet (Plan 19-02). Do NOT add QR overlay or black screen yet (Plan 19-02). Focus on rendering projected content synced via Broadcast.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Navigate to `/presentation/{any-session-id}` in browser -- shows dark background with "Waiting for presentation to start..." text
    - When admin navigates sequence in AdminSession, PresentationView updates to show corresponding slide or batch content
  </verify>
  <done>
    PresentationView page exists at /presentation/:sessionId, renders projected content (slides/batches) full-screen on dark background, syncs via Realtime Broadcast, shows reconnecting indicator and fullscreen hint
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PresentationControls and integrate into AdminSession</name>
  <files>src/components/PresentationControls.tsx, src/pages/AdminSession.tsx</files>
  <action>
    **1. Create src/components/PresentationControls.tsx:**
    Build the admin control view component that replaces the current active-session layout when presentation mode is enabled. Props:
    ```typescript
    interface PresentationControlsProps {
      sessionId: string;
      sessionTitle: string;
      participantCount: number;
      connectionStatus: ConnectionStatus;
      channelRef: React.RefObject<RealtimeChannel | null>;
      sessionVotes: Record<string, Vote[]>;
      onActivateSequenceItem: (item: SessionItem, direction: 'forward' | 'backward') => void;
      onEndSession: () => void;
    }
    ```

    Layout (3-column, full height `h-screen bg-white`):

    a) **Left sidebar (w-80):**
    - Session title at top
    - "Open Presentation" button (blue, full width) that calls `window.open(presentationUrl, 'QuickVotePresentation', 'width=1920,height=1080,menubar=no,toolbar=no,location=no,status=no')` where presentationUrl is `/presentation/${sessionId}`
    - Full scrollable SequenceManager in live mode (reuse existing component with `isLive={true}`, `activeSessionItemId`, `onActivateItem`)
    - "End Session" button at bottom (red text, small)

    b) **Center area (flex-1):**
    - Two side-by-side preview panels with headers "Current (Live)" and "Next":
    - Current panel: dark (#1a1a1a) rounded container showing a mini projection preview of the current active item. For slides, show `<SlideDisplay>`. For batches, show batch name + question count centered. For no item, show "No active item" in gray.
    - Next panel: gray-100 rounded container showing preview of the next item in sequence (same rendering as current but for `sessionItems[currentIndex + 1]`). If no next item, show "End of sequence" in gray.
    - Below previews: Navigation controls row with Previous/Next buttons and position indicator (reusing the goNext/goPrev/currentIndex from `useSequenceNavigation`)

    c) **Right sidebar (w-64):** Placeholder section headers for "QR Code" and "Presentation" controls (buttons will be wired in Plan 19-02). Include:
    - "QR Code" section with three buttons (Hidden/Corner/Full Screen) -- visually present but onClick does nothing yet (console.log placeholder)
    - "Presentation" section with "Black Screen" toggle button -- visually present but onClick does nothing yet
    - ParticipantCount display
    - "Keyboard Shortcuts (?)" link at bottom -- visually present but onClick does nothing yet

    Use `useSequenceNavigation` hook for navigation state and keyboard shortcuts (arrow keys, space already work from Phase 18).

    **2. Modify AdminSession.tsx to add presentation mode:**

    a) Add state: `const [presentationMode, setPresentationMode] = useState(false);`

    b) In the `isActive` view section, replace the current active layout with a conditional:
    - If `presentationMode` is true: render `<PresentationControls>` with all necessary props
    - If `presentationMode` is false: render existing active-session layout (current code, unchanged)

    c) Add a button to enter presentation mode. In the current active view's header bar (the border-b div with session title), add an "Enter Presentation" button (small, right-aligned next to the reasons toggle). `onClick={() => setPresentationMode(true)}`.

    d) Also add an "Exit Presentation Mode" option somewhere in PresentationControls (e.g., a small link/button in the left sidebar header area) that calls a callback to set `setPresentationMode(false)`.

    e) Pass `onExitPresentationMode={() => setPresentationMode(false)}` as a prop to PresentationControls.

    **Important:** The existing active layout (sidebar SequenceManager + hero projection area) MUST remain untouched and continue to work when presentationMode is false. The PresentationControls is an ALTERNATIVE layout, not a replacement of existing code.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - In AdminSession active view, "Enter Presentation" button appears in header
    - Clicking "Enter Presentation" switches to control view layout with sequence list, current+next previews, navigation controls
    - "Open Presentation" button in control view opens new window at /presentation/:sessionId
    - Navigating in control view updates both the preview panels and the PresentationView window
    - "Exit Presentation Mode" returns to normal active view
    - Existing admin flow (without presentation mode) works identically to before
  </verify>
  <done>
    PresentationControls component renders admin control view with sequence list, current+next preview, navigation. AdminSession toggles between normal active view and presentation control view. "Open Presentation" launches separate window.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Route /presentation/:sessionId loads PresentationView with dark background
3. Admin can enter presentation mode from active session view
4. Admin control view shows sequence list, current+next preview panels, navigation controls
5. "Open Presentation" opens separate browser window showing projected content
6. Navigating in admin control view updates PresentationView in real-time via Broadcast
7. Existing admin flow (draft, lobby, active without presentation mode, ended) works unchanged
8. PresentationView shows reconnecting indicator when Realtime disconnects
</verification>

<success_criteria>
- Two-window architecture functional: admin controls in one window, projection in another
- Navigation sync works across windows via existing Realtime Broadcast
- PresentationView works standalone (navigating to URL directly shows projected content)
- Admin can toggle between normal active view and presentation control view
- No regressions in existing admin or participant flows
</success_criteria>

<output>
After completion, create `.planning/phases/19-presenter-view/19-01-SUMMARY.md`
</output>

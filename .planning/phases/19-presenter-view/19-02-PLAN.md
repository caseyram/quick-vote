---
phase: 19-presenter-view
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/pages/PresentationView.tsx
  - src/components/PresentationControls.tsx
  - src/components/QROverlay.tsx
  - src/components/KeyboardShortcutHelp.tsx
  - src/components/BatchResultsProjection.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can toggle QR code overlay on presentation window (hidden, corner, fullscreen modes) from the control view"
    - "Admin can toggle black screen on presentation window from the control view using B key or button"
    - "Keyboard shortcuts work in both windows: Space/arrows advance, B blacks screen, F toggles fullscreen, ? shows help"
    - "Admin can reveal batch results one question at a time on the presentation window"
    - "Admin can click a reason to project it alongside the chart on the presentation window"
    - "Presentation window enters browser fullscreen via F key or Fullscreen API"
    - "QR overlay, black screen, and result reveal sync across devices via Realtime Broadcast"
  artifacts:
    - path: "src/components/QROverlay.tsx"
      provides: "QR code overlay with hidden/corner/fullscreen modes"
      min_lines: 40
    - path: "src/components/KeyboardShortcutHelp.tsx"
      provides: "Translucent overlay showing keyboard shortcuts"
      min_lines: 50
    - path: "src/components/BatchResultsProjection.tsx"
      provides: "Projected batch results with admin-controlled reveal and reason highlighting"
      min_lines: 80
  key_links:
    - from: "src/components/PresentationControls.tsx"
      to: "src/pages/PresentationView.tsx"
      via: "Realtime Broadcast events (presentation_qr_toggle, black_screen_toggle, result_reveal, reason_highlight)"
      pattern: "channel.*send.*broadcast"
    - from: "src/pages/PresentationView.tsx"
      to: "src/components/QROverlay.tsx"
      via: "QR mode state from broadcast events"
      pattern: "QROverlay"
    - from: "src/components/PresentationControls.tsx"
      to: "src/components/BatchResultsProjection.tsx"
      via: "Result reveal state broadcast to presentation view"
      pattern: "result_reveal"
---

<objective>
Add cross-device sync features to the presenter view: QR overlay control, black screen toggle, extended keyboard shortcuts with help overlay, fullscreen API, and admin-controlled batch result reveal with reason highlighting.

Purpose: Completes the presenter view with all interactive features that make it a professional presentation tool. The admin can control exactly what the audience sees -- QR codes for joining, black screen for pauses, progressive result reveal with reason spotlighting -- all synced via Realtime Broadcast for cross-device operation.

Output: QROverlay component, KeyboardShortcutHelp overlay, BatchResultsProjection component, keyboard shortcuts in both windows, fullscreen API integration, all broadcast-synced.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-presenter-view/19-CONTEXT.md
@.planning/phases/19-presenter-view/19-RESEARCH.md
@.planning/phases/19-presenter-view/19-01-SUMMARY.md

Key existing files:
@src/pages/PresentationView.tsx
@src/components/PresentationControls.tsx
@src/pages/AdminSession.tsx
@src/components/BarChart.tsx
@src/components/QRCode.tsx
@src/lib/vote-aggregation.ts
@src/hooks/use-realtime-channel.ts
@src/stores/session-store.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: QR overlay, black screen, keyboard shortcuts, fullscreen, and help overlay</name>
  <files>src/components/QROverlay.tsx, src/components/KeyboardShortcutHelp.tsx, src/pages/PresentationView.tsx, src/components/PresentationControls.tsx</files>
  <action>
    **1. Create src/components/QROverlay.tsx:**
    A reusable QR overlay component for the presentation window:
    ```typescript
    type QRMode = 'hidden' | 'corner' | 'fullscreen';
    interface QROverlayProps { mode: QRMode; sessionUrl: string; }
    ```
    - `hidden`: returns null
    - `corner`: Fixed bottom-right corner overlay (`fixed bottom-4 right-4 z-50`). White background, rounded, shadow. QRCodeSVG from qrcode.react at size 120. No URL text below (just QR graphic per CONTEXT.md).
    - `fullscreen`: Fixed inset-0 white background (z-[100]). Large centered QRCodeSVG at `Math.min(window.innerWidth, window.innerHeight) * 0.6`. "Scan to join" text below (text-4xl, text-gray-600, font-medium, mt-8).

    Export the `QRMode` type for use in other components.

    **2. Create src/components/KeyboardShortcutHelp.tsx:**
    A translucent overlay showing keyboard shortcuts:
    ```typescript
    interface KeyboardShortcutHelpProps { visible: boolean; onClose: () => void; }
    ```
    - Uses AnimatePresence + motion.div for fade in/out (opacity 0->1, scale 0.9->1).
    - Backdrop: `fixed inset-0 bg-black/60 backdrop-blur-sm z-[300]`, click to close.
    - Content: Centered white rounded-2xl card with grid of shortcuts:
      - Space / Right Arrow: "Next item"
      - Left Arrow: "Previous item"
      - F: "Toggle fullscreen"
      - Esc: "Exit fullscreen"
      - B: "Black screen"
      - ?: "Show/hide this help"
    - Each shortcut row: `<kbd>` styled keys (bg-gray-100, border, rounded, font-mono) + description text.
    - "Press Esc or ? to close" footer text.
    - Keyboard listener: when visible, Escape or ? key closes the overlay.

    **3. Update PresentationView.tsx -- add QR, black screen, keyboard shortcuts, fullscreen:**

    a) Add state:
    - `const [qrMode, setQrMode] = useState<QRMode>('hidden');`
    - `const [blackScreenActive, setBlackScreenActive] = useState(false);`
    - `const [showShortcutHelp, setShowShortcutHelp] = useState(false);`

    b) Add Broadcast listeners in the Realtime setup callback:
    - `presentation_qr_toggle` event: `setQrMode(payload.mode)`
    - `black_screen_toggle` event: `setBlackScreenActive(payload.active)`

    c) Add keyboard handler (useEffect):
    - Guard: `if (event.repeat) return;`
    - Guard: skip if target is input/textarea/select
    - `f` or `F`: toggle fullscreen via Fullscreen API (`document.documentElement.requestFullscreen()` / `document.exitFullscreen()`)
    - `Escape`: if `document.fullscreenElement` exists, exit fullscreen. If shortcut help is visible, close it.
    - `b` or `B`: toggle black screen locally AND don't broadcast (presentation window receives black screen state from control view's broadcast, not from its own B key -- wait, per CONTEXT.md keyboard shortcuts work in BOTH windows). So: toggle local blackScreenActive state. But also: if this PresentationView is being used standalone (not controlled by an admin control view), the local toggle should work. For cross-device sync, the control view broadcasts. For same-window usage, local state is sufficient. Do NOT broadcast from PresentationView -- only the control view broadcasts to avoid echo loops.
    - `?`: toggle showShortcutHelp
    - `ArrowRight` or `Space`: broadcast is not needed -- PresentationView is a receiver, not a sender. Navigation shortcuts should only work in the control view. Skip these in PresentationView.

    d) Render layers (in order, inside the fixed inset-0 container):
    - Main projection content (existing from Plan 19-01)
    - `<QROverlay mode={qrMode} sessionUrl={sessionUrl} />` (sessionUrl = `${window.location.origin}/session/${sessionId}` -- note: /session/ not /presentation/)
    - Black screen overlay: AnimatePresence wrapping a motion.div with `fixed inset-0 bg-black z-[200]`, opacity 0->1 on enter, 1->0 on exit, duration 0.5s ease-in-out
    - `<KeyboardShortcutHelp visible={showShortcutHelp} onClose={() => setShowShortcutHelp(false)} />`
    - Reconnecting indicator (existing)
    - Fullscreen hint (existing)

    **4. Update PresentationControls.tsx -- wire QR, black screen, keyboard shortcuts:**

    a) Add state:
    - `const [qrMode, setQrMode] = useState<QRMode>('hidden');`
    - `const [blackScreenActive, setBlackScreenActive] = useState(false);`
    - `const [showShortcutHelp, setShowShortcutHelp] = useState(false);`

    b) Wire the right sidebar QR buttons (which were placeholder in Plan 19-01):
    - Each QR mode button calls `handleQrToggle(mode)` which: sets local `qrMode` state AND broadcasts `presentation_qr_toggle` event via `channelRef.current?.send({ type: 'broadcast', event: 'presentation_qr_toggle', payload: { mode } })`
    - Highlight active mode button (bg-blue-600 text-white for active, bg-gray-100 for inactive)

    c) Wire the Black Screen button:
    - `handleBlackScreenToggle()`: toggles `blackScreenActive` AND broadcasts `black_screen_toggle` event via `channelRef.current?.send({ type: 'broadcast', event: 'black_screen_toggle', payload: { active: !blackScreenActive } })`
    - Button shows "Show Content" when black, "Black Screen" when not

    d) Wire keyboard shortcut link:
    - Opens `<KeyboardShortcutHelp>` overlay

    e) Add keyboard handler in PresentationControls:
    - Guard: `if (event.repeat) return;` and skip input/textarea/select
    - `b` or `B`: call handleBlackScreenToggle()
    - `f` or `F`: broadcast `presentation_fullscreen_toggle` event (the presentation window handles fullscreen locally since Fullscreen API can only affect the current window -- we can't fullscreen a different window remotely). Actually, per the Fullscreen API limitation, F key in the control view cannot fullscreen the presentation window. Instead: F in control view does nothing special (or shows a tooltip "Press F in presentation window for fullscreen"). Only F in the presentation window toggles fullscreen.
    - `?`: toggle showShortcutHelp
    - `Space` / `ArrowRight` / `ArrowLeft`: already handled by useSequenceNavigation hook from Plan 19-01
    - `Escape`: if shortcut help visible, close it. Otherwise do nothing (don't exit presentation mode on Escape -- that's browser fullscreen only per CONTEXT.md).

    f) Render `<KeyboardShortcutHelp>` in PresentationControls.

    **Important design note on F key:** The Fullscreen API requires a user gesture in the SAME document. The control view cannot trigger fullscreen in the presentation window. F key works only in the window where it's pressed. This is a browser security limitation, not a bug. The help overlay should note "F: Toggle fullscreen (presentation window)" to make this clear.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - QR overlay appears on presentation window when admin clicks QR mode buttons in control view
    - Corner QR shows small QR in bottom-right, fullscreen QR fills the screen with "Scan to join"
    - B key in control view blacks out the presentation window (0.5s fade)
    - F key in presentation window toggles browser fullscreen
    - ? key shows keyboard shortcut help overlay in both windows
    - Escape exits fullscreen in presentation window, closes help overlay
    - All sync works via Realtime Broadcast (test by opening presentation URL in a different browser/incognito)
  </verify>
  <done>
    QR overlay with 3 modes synced via Broadcast. Black screen toggle with fade animation synced via Broadcast. Fullscreen API in presentation window. Keyboard shortcuts in both windows. Help overlay. All cross-device compatible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin-controlled batch result reveal with reason highlighting</name>
  <files>src/components/BatchResultsProjection.tsx, src/pages/PresentationView.tsx, src/components/PresentationControls.tsx</files>
  <action>
    **1. Create src/components/BatchResultsProjection.tsx:**
    The projected display component for batch results on the presentation window:

    ```typescript
    interface BatchResultsProjectionProps {
      batchId: string;
      questions: Question[];
      sessionVotes: Record<string, Vote[]>;
      revealedQuestions: Set<string>;
      highlightedReason: { questionId: string; reasonId: string } | null;
    }
    ```

    Behavior:
    - Shows ONE question at a time -- the most recently revealed question (last item added to revealedQuestions set that belongs to this batch)
    - If no questions revealed: show batch name centered on dark background with "Results ready" subtitle (text-gray-400, text-2xl)
    - When a question IS revealed:
      - Full dark background projection layout
      - Question text as heading (text-3xl font-bold text-white mb-6)
      - BarChart below with chart data built from `aggregateVotes` and `buildConsistentBarData` (import from existing `vote-aggregation.ts`). Use dark theme if BarChart supports it, or style the container with white text on dark bg. Import AGREE_DISAGREE_COLORS and MULTI_CHOICE_COLORS from BarChart.
      - If a reason is highlighted (highlightedReason is not null and matches current question):
        - Side-by-side layout: chart on left (w-1/2), reason on right (w-1/2)
        - Reason card: white/10 bg with backdrop-blur, rounded-lg, p-6. Reason text in text-white text-xl. Color-coded left border (4px) matching the vote option color. Author display name below if available.
        - Use motion.div for enter animation (opacity 0->1, x: 50->0)
      - If no reason highlighted: chart fills full width
    - Use AnimatePresence for smooth transitions between revealed questions

    **2. Update PresentationView.tsx -- integrate BatchResultsProjection:**

    a) Add state:
    - `const [revealedQuestions, setRevealedQuestions] = useState<Set<string>>(new Set());`
    - `const [highlightedReason, setHighlightedReason] = useState<{ questionId: string; reasonId: string } | null>(null);`

    b) Add Broadcast listeners:
    - `result_reveal` event: `setRevealedQuestions(prev => { const next = new Set(prev); if (payload.revealed) next.add(payload.questionId); else next.delete(payload.questionId); return next; })`
    - `reason_highlight` event: `setHighlightedReason(payload.reasonId ? { questionId: payload.questionId, reasonId: payload.reasonId } : null)`
    - On `batch_activated` event (existing): reset revealedQuestions to empty Set and highlightedReason to null

    c) In the render, when the active item is a batch:
    - Instead of the simple batch name display, render `<BatchResultsProjection>` with the batch's questions, session votes, revealed questions, and highlighted reason
    - Need to also load/subscribe to votes in PresentationView. Add a vote polling mechanism similar to AdminSession (poll every 3s when session is active) OR subscribe to votes via Postgres Changes on the Realtime channel. The simpler approach: poll every 3s like AdminSession does. Add `sessionVotes` state and the same polling useEffect.

    **3. Update PresentationControls.tsx -- add result reveal controls:**

    a) Add state for reveal:
    - `const [revealedQuestions, setRevealedQuestions] = useState<Set<string>>(new Set());`
    - `const [highlightedReasonId, setHighlightedReasonId] = useState<string | null>(null);`
    - `const [currentBatchQuestionIndex, setCurrentBatchQuestionIndex] = useState(0);`

    b) When the current active item is a batch, show a **batch results control panel** in the center area (below or replacing the current+next preview when in batch mode):
    - Get batch questions: `questions.filter(q => q.batch_id === currentBatchId)` sorted by position
    - Show tabs or a stepper for each question in the batch (question text truncated, numbered Q1, Q2, etc.)
    - For the currently selected question:
      - Show the full BarChart with votes (same rendering as AdminSession's ActiveQuestionHero but in a compact format)
      - "Reveal to audience" toggle button -- calls `handleRevealQuestion(questionId)`:
        - Toggles the question in revealedQuestions Set
        - Broadcasts `result_reveal` event: `channelRef.current?.send({ type: 'broadcast', event: 'result_reveal', payload: { questionId, revealed: !isRevealed } })`
      - Below the chart: list of reasons grouped by vote option (similar to ActiveQuestionHero's reason columns but in a more compact scrollable format)
      - Each reason card is CLICKABLE:
        - Click highlights it (broadcasts `reason_highlight` event): `channelRef.current?.send({ type: 'broadcast', event: 'reason_highlight', payload: { questionId, reasonId } })`
        - Click again (same reason) unhighlights (toggle): `payload: { questionId, reasonId: null }`
        - Highlighted reason gets a visual indicator (ring or border) in the control view
      - Each reason card shows a color-coded left border matching the vote option color

    c) Reset reveal state when navigating away from a batch:
    - When activeSessionItemId changes and the new item is NOT the same batch, reset `revealedQuestions` to empty Set, `highlightedReasonId` to null, `currentBatchQuestionIndex` to 0

    d) Auto-navigate to next question in batch when admin clicks "Next question" within the batch stepper (this is within-batch navigation, separate from the sequence navigation)

    **Important anti-pattern:** Do NOT auto-reveal any questions. Admin must explicitly click "Reveal" for each one. All hidden by default when a batch activates (per CONTEXT.md decision).
  </action>
  <verify>
    - `npm run build` compiles without errors
    - When admin navigates to a batch item, control view shows batch result panel with questions listed
    - Clicking "Reveal to audience" on a question makes it appear on the presentation window
    - Chart displays correctly with vote data on the projection
    - Clicking a reason in control view shows it alongside the chart on the projection
    - Clicking the same reason again dismisses it from projection
    - Navigating to a different sequence item resets the reveal state
    - All reveal/highlight actions sync across devices via Broadcast
  </verify>
  <done>
    Admin-controlled batch result reveal with per-question reveal toggle, reason highlighting with toggle behavior, color-coded reason cards, all synced to presentation window via Broadcast. Chart + reason side-by-side layout on projection.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete presenter view with two-window architecture:
    1. PresentationView at /presentation/:sessionId -- standalone projection window
    2. Admin PresentationControls with sequence list, current+next preview, navigation
    3. QR overlay (hidden/corner/fullscreen) controlled from admin
    4. Black screen toggle with 0.5s fade animation
    5. Fullscreen API (F key in presentation window)
    6. Keyboard shortcuts (B, F, ?, Escape, Space, arrows) in both windows
    7. Keyboard shortcut help overlay (? key)
    8. Admin-controlled batch result reveal (per-question, with reason highlighting)
    9. All features synced cross-device via Realtime Broadcast
  </what-built>
  <how-to-verify>
    Full presenter flow test:

    1. **Setup:** Create or load a session with at least 2 batches (each with 2+ questions and some votes) and 1-2 slides between them.

    2. **Enter presentation mode:** Go to admin session, start session (lobby -> active). Click "Enter Presentation" in the header. Verify control view layout appears with sequence list, current+next panels.

    3. **Open presentation window:** Click "Open Presentation" in control view. Verify a new window opens with dark background showing the current item.

    4. **Test navigation:** Use arrow keys or Previous/Next buttons in control view. Verify:
       - Both control view previews and presentation window update
       - Slide transitions are smooth (horizontal spring)
       - Batch transitions crossfade
       - Presentation window follows control view navigation

    5. **Test QR overlay:** In control view right sidebar:
       - Click "Corner" -- verify small QR appears bottom-right in presentation window
       - Click "Full Screen" -- verify large centered QR fills presentation window
       - Click "Hidden" -- verify QR disappears

    6. **Test black screen:** Press B in control view -- verify presentation window fades to black (0.5s). Press B again -- fades back to content.

    7. **Test fullscreen:** In the presentation window, press F -- verify browser goes fullscreen. Press F again or Escape to exit.

    8. **Test keyboard help:** Press ? in either window -- verify help overlay appears with shortcut list. Press ? or Escape to dismiss.

    9. **Test batch result reveal:** Navigate to a batch item:
       - Control view should show batch questions list
       - Presentation window shows batch name with "Results ready"
       - Click "Reveal" on first question -- chart appears on presentation window
       - Click a reason -- it appears alongside the chart on projection (side-by-side)
       - Click same reason -- it disappears (toggle)
       - Click "Reveal" on second question -- projection switches to that question's chart
       - Navigate away from batch -- reveal state resets

    10. **Cross-device test:** Copy the /presentation/:sessionId URL and open it in a different browser (or incognito). Repeat steps 4-9 and verify the separate browser window stays in sync.

    11. **Regression check:** Exit presentation mode, verify normal admin active view works as before. Check participant side still works normally.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 19, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. QR overlay syncs from control view to presentation view in all 3 modes
3. Black screen toggle syncs with 0.5s fade animation
4. Fullscreen API works in presentation window (F key)
5. Keyboard shortcuts work in both windows (B, F, ?, Escape, Space, arrows)
6. Help overlay appears and dismisses correctly
7. Batch result reveal: admin controls what's projected one question at a time
8. Reason highlighting: click to project, click again to dismiss, color-coded borders
9. All sync works cross-device via Realtime Broadcast
10. No regressions in existing flows (draft, lobby, normal active view, participant, ended)
</verification>

<success_criteria>
- QR code overlay controllable from admin in 3 modes, synced to projection
- Black screen fade toggle synced across windows
- Fullscreen works in presentation window
- All keyboard shortcuts functional in both windows
- Batch results revealed one question at a time, admin-controlled
- Reason highlighting with toggle behavior projected alongside chart
- Cross-device sync verified via separate browser/incognito
- Existing flows unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/19-presenter-view/19-02-SUMMARY.md`
</output>

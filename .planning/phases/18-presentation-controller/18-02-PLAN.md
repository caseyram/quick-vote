---
phase: 18-presentation-controller
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/components/SlideDisplay.tsx
  - src/pages/AdminSession.tsx
  - src/pages/ParticipantSession.tsx
autonomous: false

must_haves:
  truths:
    - "When active item is a slide, admin projection area shows the image full-screen with letterboxing"
    - "When active item is a batch, admin projection area shows existing batch voting UI unchanged"
    - "Participants see 'Waiting for next question...' when admin is on a content slide"
    - "Smooth horizontal slide animation plays between consecutive slides"
    - "Crossfade animation plays when transitioning between a slide and a batch (or vice versa)"
    - "Slide images display with object-fit: contain on dark gray (#1a1a1a) background"
  artifacts:
    - path: "src/components/SlideDisplay.tsx"
      provides: "Full-screen slide image projection with letterboxing"
      min_lines: 20
    - path: "src/pages/AdminSession.tsx"
      provides: "Animated projection area switching between SlideDisplay and batch/voting content"
      contains: "AnimatePresence"
    - path: "src/pages/ParticipantSession.tsx"
      provides: "Handles slide_activated broadcast, shows waiting state"
      contains: "slide_activated"
  key_links:
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/SlideDisplay.tsx"
      via: "renders SlideDisplay when active item is a slide"
      pattern: "SlideDisplay"
    - from: "src/pages/AdminSession.tsx"
      to: "src/stores/session-store.ts"
      via: "reads activeSessionItemId and navigationDirection for animation"
      pattern: "activeSessionItemId"
    - from: "src/pages/ParticipantSession.tsx"
      to: "broadcast"
      via: "listens for slide_activated event to show waiting state"
      pattern: "slide_activated"
---

<objective>
Create the SlideDisplay projection component, integrate animated transitions into the admin projection area (horizontal slide for slides, crossfade for batch transitions), and handle the slide_activated broadcast on the participant side to show a waiting state.

Purpose: This plan makes the presentation controller visually functional. Plan 18-01 built the navigation state machine; this plan renders the correct content (slide image or batch UI) with smooth animations and ensures participants see appropriate feedback.

Output: SlideDisplay component, animated admin projection area with AnimatePresence, participant slide_activated broadcast handler.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-presentation-controller/18-CONTEXT.md
@.planning/phases/18-presentation-controller/18-RESEARCH.md
@.planning/phases/18-presentation-controller/18-01-SUMMARY.md
@src/pages/AdminSession.tsx
@src/pages/ParticipantSession.tsx
@src/components/SlideDisplay.tsx
@src/stores/session-store.ts
@src/lib/slide-api.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SlideDisplay component and integrate animated projection into AdminSession</name>
  <files>
    src/components/SlideDisplay.tsx
    src/pages/AdminSession.tsx
  </files>
  <action>
    **SlideDisplay.tsx (new file):**
    Create a simple full-screen slide image projection component.

    Props:
    ```ts
    interface SlideDisplayProps {
      imagePath: string;
      caption?: string | null;  // not displayed visually, available for accessibility
    }
    ```

    Implementation:
    - Import `getSlideImageUrl` from `../lib/slide-api`
    - Render a full container div with `bg-[#1a1a1a]` (dark gray letterbox background)
    - Inside, render an `<img>` with:
      - `src={getSlideImageUrl(imagePath)}`
      - `alt={caption || 'Slide'}`
      - `className="w-full h-full object-contain"` (letterbox, no crop)
    - Container: `className="w-full h-full flex items-center justify-center bg-[#1a1a1a]"`
    - The component fills its parent container completely — parent controls the sizing.

    **AdminSession.tsx changes:**
    Import `motion` and `AnimatePresence` from `motion/react` (same import pattern as ParticipantSession.tsx).
    Import `SlideDisplay` from `../components/SlideDisplay`.

    Read from store:
    - `activeSessionItemId` from useSessionStore
    - `navigationDirection` from useSessionStore
    - `sessionItems` from useSessionStore (already read)

    Derive the active session item:
    ```ts
    const activeItem = activeSessionItemId
      ? sessionItems.find(item => item.id === activeSessionItemId)
      : null;
    ```

    Determine the content type for the projection area:
    ```ts
    const isSlideActive = activeItem?.item_type === 'slide';
    const isBatchActive = activeItem?.item_type === 'batch';
    ```

    **Modify the active session main content area (the right side, after the sidebar added in 18-01):**

    Replace the existing conditional content rendering (the area that currently shows ActiveQuestionHero, ProgressDashboard summary, or waiting state) with an AnimatePresence-wrapped animated container.

    The animation logic (from CONTEXT.md and RESEARCH.md):
    - Slide-to-slide: horizontal slide animation (forward = slide left, back = slide right)
    - Any transition involving a batch: crossfade
    - Duration: ~350ms

    Define animation variants:
    ```ts
    // Determine if this is a slide-to-slide transition (horizontal) or involves batch (crossfade)
    const isSlideTransition = isSlideActive; // simplified: use slide animation when showing a slide

    const slideVariants = {
      enter: (direction: 'forward' | 'backward' | null) => ({
        x: direction === 'forward' ? '100%' : direction === 'backward' ? '-100%' : 0,
        opacity: direction ? 0 : 1,
      }),
      center: { x: 0, opacity: 1 },
      exit: (direction: 'forward' | 'backward' | null) => ({
        x: direction === 'forward' ? '-100%' : direction === 'backward' ? '100%' : 0,
        opacity: direction ? 0 : 1,
      }),
    };

    const crossfadeVariants = {
      enter: { opacity: 0 },
      center: { opacity: 1 },
      exit: { opacity: 0 },
    };
    ```

    Use conditional variants:
    - When `isSlideActive` (current item is a slide), use slideVariants with spring transition (stiffness 300, damping 30) — same as ParticipantSession questionTransition
    - When `isBatchActive` or no active item, use crossfadeVariants with tween 350ms easeInOut

    The projection area rendering:
    ```tsx
    <AnimatePresence mode="wait" custom={navigationDirection}>
      <motion.div
        key={activeSessionItemId ?? 'none'}
        custom={navigationDirection}
        variants={isSlideActive ? slideVariants : crossfadeVariants}
        initial="enter"
        animate="center"
        exit="exit"
        transition={isSlideActive
          ? { x: { type: 'spring', stiffness: 300, damping: 30 }, opacity: { duration: 0.2 } }
          : { duration: 0.35, ease: 'easeInOut' }
        }
        className="h-full"
      >
        {isSlideActive && activeItem?.slide_image_path ? (
          <SlideDisplay imagePath={activeItem.slide_image_path} caption={activeItem.slide_caption} />
        ) : (
          /* Existing content: ProgressDashboard summary, ActiveQuestionHero, results, or waiting state */
          /* Keep exactly the existing conditional rendering for batch/voting content */
        )}
      </motion.div>
    </AnimatePresence>
    ```

    The existing batch/voting rendering (ProgressDashboard, ActiveQuestionHero, results navigation, waiting state) goes INSIDE the else branch unchanged. It still works exactly as before when the active item is a batch or when there's no active item.

    **Important details:**
    - The animation wrapper goes around the main content area ONLY (not the sidebar, not the header bar, not the AdminControlBar)
    - The overflow-y-auto on the content div needs to move inside the motion.div children so it doesn't clip the animation
    - When activeSessionItemId is null (no item selected yet, like when session just went active), show the existing "Ready for questions" waiting state
    - When the active item is a slide, the SlideDisplay fills the entire projection area with the dark background and letterboxed image
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npx vitest run --reporter=verbose 2>&1 | tail -20` — no new test failures.
  </verify>
  <done>
    SlideDisplay component renders full-screen letterboxed image on #1a1a1a background.
    AdminSession active view shows SlideDisplay when navigating to a slide item.
    AdminSession active view shows existing batch/voting UI when navigating to a batch item.
    Horizontal slide animation plays between consecutive slides.
    Crossfade animation plays when transitioning to/from batch items.
    Animation direction matches navigation direction (forward/backward).
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle slide_activated broadcast on participant side</name>
  <files>
    src/pages/ParticipantSession.tsx
  </files>
  <action>
    In ParticipantSession.tsx, add a new broadcast listener in the `setupChannel` callback:

    ```ts
    // 9. slide_activated: admin navigated to a content slide
    channel.on('broadcast', { event: 'slide_activated' }, () => {
      // Clear any active voting state
      stopCountdown();
      setActiveQuestion(null);
      // Show waiting state — participants don't see slide images
      setView('waiting');
      setWaitingMessage('Waiting for next question...');
    });
    ```

    Place this after the existing batch_closed listener (item 8).

    Also update the `refetchState` function to handle the case where the admin is on a slide item during reconnection. Currently when the session is active and no batch/question is active, refetchState already falls through to the waiting state with "Waiting for next question..." message. This is correct behavior — no additional change needed for reconnection, since slide state is admin-local and not persisted in the database.

    **Note on participant behavior:**
    - When admin navigates to a slide: participant sees "Waiting for next question..."
    - When admin navigates from slide to batch: batch_activated broadcast fires, participant enters batch-voting
    - When admin navigates from slide to slide: slide_activated fires again, participant stays on waiting (no visible change)
    - This matches the CONTEXT.md spec: "Same waiting state for all participants regardless of when they joined"
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npx vitest run --reporter=verbose 2>&1 | tail -20` — no new test failures.
    Manually verify: ParticipantSession.tsx contains a 'slide_activated' broadcast listener that sets view to 'waiting'.
  </verify>
  <done>
    ParticipantSession handles slide_activated broadcast by showing "Waiting for next question..." text.
    Existing voting/batch state is properly cleared when slide_activated is received.
    Participants who join mid-slide see the standard waiting state (reconnection falls through to waiting when no active batch/question).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete presentation controller: admin sidebar navigation through unified sequence with slide projection, batch activation, participant waiting state, and transition animations.

    Full flow:
    1. Create a session with at least 2 slides and 1 batch (with questions)
    2. Start session, begin voting
    3. First item auto-activates
    4. Use Next/Previous buttons or arrow keys to navigate
    5. Slides show full-screen letterboxed on dark background
    6. Batches activate normally with voting
    7. Participant sees "Waiting for next question..." on slides
    8. Smooth animations between items
  </what-built>
  <how-to-verify>
    1. Open existing session in draft view, ensure it has slides and batches in the sequence
    2. Start session (lobby), then Begin Voting
    3. Verify: left sidebar shows the sequence list with first item highlighted (blue background, blue border)
    4. Verify: if first item is a slide, projection area shows the image full-screen on dark background
    5. Click Next button or press ArrowRight — verify smooth animation to next item
    6. Click Previous or press ArrowLeft — verify animation back
    7. Click any item in the sidebar — verify it jumps directly with animation
    8. When on a slide: check participant tab shows "Waiting for next question..."
    9. When on a batch: check participant tab enters batch voting mode
    10. Verify Space key also advances forward
    11. Verify Next is disabled on last item, Previous on first
    12. Verify keyboard doesn't navigate when typing in the control bar quick question input
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `npx vitest run` — no NEW test failures beyond pre-existing ones
3. Full presentation flow: slides display full-screen, batches activate normally, participants see waiting state on slides
4. Animations: horizontal slide between slides, crossfade to/from batches
5. Keyboard navigation works (ArrowLeft, ArrowRight, Space) with repeat prevention
6. Click-to-jump in sidebar works
7. Navigation controls (Previous/Next) properly disable at boundaries
</verification>

<success_criteria>
- SlideDisplay renders letterboxed image on #1a1a1a background
- AdminSession active view switches between SlideDisplay and batch content based on active item type
- Horizontal slide animations between slides, crossfade for batch transitions
- Participants receive slide_activated broadcast and show "Waiting for next question..."
- Latecomers joining during a slide see the same waiting state
- Complete presentation flow: admin can navigate the full sequence projecting slides and activating batches
</success_criteria>

<output>
After completion, create `.planning/phases/18-presentation-controller/18-02-SUMMARY.md`
</output>

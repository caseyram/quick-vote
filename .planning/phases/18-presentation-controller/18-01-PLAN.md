---
phase: 18-presentation-controller
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/session-store.ts
  - src/hooks/use-sequence-navigation.ts
  - src/components/SequenceManager.tsx
  - src/components/SequenceItemCard.tsx
  - src/pages/AdminSession.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can advance forward through the sequence using Next button or arrow keys"
    - "Admin can go backward through the sequence using Previous button or left arrow"
    - "Clicking a sequence item in the sidebar jumps directly to it"
    - "Next button is disabled on the last item; Previous disabled on first"
    - "Active item is visually highlighted in the sequence list"
    - "When navigating to a batch item, the batch is activated via existing handleActivateBatch"
    - "When navigating to a slide item, a slide_activated broadcast is sent to participants"
  artifacts:
    - path: "src/hooks/use-sequence-navigation.ts"
      provides: "Keyboard navigation hook with repeat prevention"
      min_lines: 40
    - path: "src/stores/session-store.ts"
      provides: "activeSessionItemId and navigationDirection state"
      contains: "activeSessionItemId"
    - path: "src/components/SequenceManager.tsx"
      provides: "Active item highlight, click-to-jump, navigation controls"
      contains: "NavigationControls"
  key_links:
    - from: "src/hooks/use-sequence-navigation.ts"
      to: "src/stores/session-store.ts"
      via: "reads sessionItems and activeSessionItemId from store"
      pattern: "useSessionStore"
    - from: "src/components/SequenceManager.tsx"
      to: "src/hooks/use-sequence-navigation.ts"
      via: "uses hook for keyboard navigation"
      pattern: "useSequenceNavigation"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/SequenceManager.tsx"
      via: "passes onActivateItem callback for batch/slide activation"
      pattern: "onActivateItem"
---

<objective>
Add presentation state (activeSessionItemId, navigationDirection) to the session store, create a keyboard navigation hook with repeat prevention, and build navigation controls into the SequenceManager sidebar. Admin can advance forward/backward through the sequence or click any item to jump to it.

Purpose: This is the core navigation infrastructure for Phase 18. Without it, the admin has no way to advance through slides and batches as a presentation. This plan establishes the state machine and controls; Plan 18-02 adds the visual projection and animations.

Output: Extended session store, useSequenceNavigation hook, NavigationControls in SequenceManager, active item highlighting, and wiring into AdminSession for batch activation and slide broadcast dispatch.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-presentation-controller/18-CONTEXT.md
@.planning/phases/18-presentation-controller/18-RESEARCH.md
@src/stores/session-store.ts
@src/components/SequenceManager.tsx
@src/components/SequenceItemCard.tsx
@src/pages/AdminSession.tsx
@src/types/database.ts
@src/lib/sequence-api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend session store and create useSequenceNavigation hook</name>
  <files>
    src/stores/session-store.ts
    src/hooks/use-sequence-navigation.ts
  </files>
  <action>
    **session-store.ts changes:**
    Add to SessionState interface and implementation:
    - `activeSessionItemId: string | null` (initially null) — the session_item.id currently being presented
    - `navigationDirection: 'forward' | 'backward' | null` (initially null) — used for animation direction in Plan 18-02
    - `setActiveSessionItemId: (id: string | null) => void`
    - `setNavigationDirection: (dir: 'forward' | 'backward' | null) => void`
    Add both to the `reset()` function (reset to null).

    **useSequenceNavigation hook (new file):**
    Create `src/hooks/use-sequence-navigation.ts` exporting `useSequenceNavigation(options)`.

    Options interface:
    ```ts
    interface UseSequenceNavigationOptions {
      enabled: boolean;  // only active during live (active) session
      onActivateItem: (item: SessionItem, direction: 'forward' | 'backward') => void;
    }
    ```

    Returns:
    ```ts
    interface SequenceNavigationResult {
      currentIndex: number;  // -1 if no active item
      canGoNext: boolean;
      canGoPrev: boolean;
      goNext: () => void;
      goPrev: () => void;
      jumpTo: (itemId: string) => void;
    }
    ```

    Implementation:
    - Read `sessionItems` and `activeSessionItemId` from useSessionStore
    - Compute `currentIndex` from activeSessionItemId
    - `canGoNext`: currentIndex < sessionItems.length - 1
    - `canGoPrev`: currentIndex > 0
    - `goNext`: if canGoNext, compute direction='forward', call onActivateItem with next item
    - `goPrev`: if canGoPrev, compute direction='backward', call onActivateItem with prev item
    - `jumpTo(itemId)`: find item, compute direction based on index comparison, call onActivateItem
    - Add window-level `keydown` event listener (in useEffect):
      - Skip if `!enabled`
      - Skip if `event.repeat` (prevent key-hold rapid fire)
      - Skip if active element is INPUT, TEXTAREA, or SELECT (user is typing)
      - ArrowRight or Space: goNext
      - ArrowLeft: goPrev
      - Cleanup listener on unmount/disable
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors in new/modified files.
    Confirm session-store.ts exports activeSessionItemId and navigationDirection.
    Confirm use-sequence-navigation.ts exports useSequenceNavigation.
  </verify>
  <done>
    Session store has activeSessionItemId and navigationDirection state.
    useSequenceNavigation hook handles keyboard events (ArrowLeft, ArrowRight, Space) with repeat prevention and input-focus skip, exposes goNext/goPrev/jumpTo/canGoNext/canGoPrev.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation controls and active highlight to SequenceManager, wire into AdminSession</name>
  <files>
    src/components/SequenceManager.tsx
    src/components/SequenceItemCard.tsx
    src/pages/AdminSession.tsx
  </files>
  <action>
    **SequenceItemCard.tsx changes:**
    - Add `isActive?: boolean` prop and `onClick?: () => void` prop to SequenceItemCardProps
    - When `isActive` is true, apply highlight styling: `bg-blue-100 border-blue-500` (override the default color classes). This replaces the normal bg-blue-50/bg-purple-50 colors.
    - Make the entire card clickable (except drag handle and delete button): wrap the content area in a clickable div or add onClick to the outer div. The onClick should call the `onClick` prop (for jump-to-item). Only attach onClick when the prop is provided.

    **SequenceManager.tsx changes:**
    - Add new props to SequenceManagerProps:
      - `isLive?: boolean` — true when session is active (controls show only when live)
      - `activeSessionItemId?: string | null` — currently active item
      - `onActivateItem?: (item: SessionItem, direction: 'forward' | 'backward') => void` — called when navigating to an item
    - Import and use `useSequenceNavigation` hook, passing `enabled: isLive ?? false` and `onActivateItem`
    - Pass `isActive={item.id === activeSessionItemId}` to each SequenceItemCard
    - Pass `onClick={() => jumpTo(item.id)}` to each SequenceItemCard (only when isLive)
    - Add NavigationControls below the sequence list (inline, not a separate component — keep it simple):
      ```tsx
      {isLive && (
        <div className="flex items-center justify-between pt-3 border-t border-gray-200">
          <button
            onClick={goPrev}
            disabled={!canGoPrev}
            className="px-4 py-2 bg-gray-100 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed text-gray-700 text-sm font-medium rounded-lg transition-colors"
          >
            Previous
          </button>
          <span className="text-sm text-gray-500">
            {currentIndex >= 0 ? `${currentIndex + 1} / ${sessionItems.length}` : '--'}
          </span>
          <button
            onClick={goNext}
            disabled={!canGoNext}
            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-30 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors"
          >
            Next
          </button>
        </div>
      )}
      ```
    - Note: In draft view, `isLive` is false, so navigation controls and click-to-jump don't appear. The SequenceManager remains a pure reorder tool in draft mode.
    - When `isLive` is true, hide the DnD reordering (no drag handles), the "New Batch" button, and delete buttons. The list becomes read-only navigation. Conditionally skip the DndContext/SortableContext wrapping when isLive — just render plain cards.

    **AdminSession.tsx changes:**
    - Create `handleActivateSequenceItem(item: SessionItem, direction: 'forward' | 'backward')` function:
      - Set `activeSessionItemId` in store: `useSessionStore.getState().setActiveSessionItemId(item.id)`
      - Set `navigationDirection` in store: `useSessionStore.getState().setNavigationDirection(direction)`
      - If `item.item_type === 'batch'` and `item.batch_id`:
        - Call existing `handleActivateBatch(item.batch_id, null)` (no timer for sequence navigation)
      - If `item.item_type === 'slide'`:
        - Clear any active batch: if activeBatchId, call `handleCloseBatch(activeBatchId)` first
        - Close any active individual question (same pattern as handleActivateBatch does)
        - Send broadcast: `channelRef.current?.send({ type: 'broadcast', event: 'slide_activated', payload: { itemId: item.id } })`
    - In the active session view (isActive), add a sidebar panel on the left that contains the SequenceManager in live mode. Restructure the active view layout:
      - Use a flex row: left sidebar (w-80 shrink-0) with SequenceManager + right main area (flex-1) with existing content
      - The sidebar has: session title, SequenceManager with `isLive={true}`, `activeSessionItemId={activeSessionItemId}`, `onActivateItem={handleActivateSequenceItem}`
      - Read `activeSessionItemId` from store: `const activeSessionItemId = useSessionStore(state => state.activeSessionItemId);`
    - On initial transition to active (handleBeginVoting), auto-activate the first sequence item if sessionItems exist:
      After `setSession({ ...session, status: 'active' })` and broadcast, check `sessionItems.length > 0` and call `handleActivateSequenceItem(sessionItems[0], 'forward')`.
      Read sessionItems from store: `useSessionStore.getState().sessionItems`
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npx vitest run --reporter=verbose 2>&1 | tail -20` — check that existing tests still pass (test failures unrelated to this phase are acceptable per project memory: ~16 pre-existing failures).
  </verify>
  <done>
    SequenceManager shows active item highlight (bg-blue-100 border-blue-500) during live session.
    Click on any sequence item jumps to it.
    Previous/Next buttons appear at the bottom of the sequence list during live sessions.
    Arrow keys and Space navigate the sequence (with repeat prevention, input skip).
    Navigating to a batch item triggers handleActivateBatch.
    Navigating to a slide item broadcasts slide_activated event.
    AdminSession active view has a left sidebar with the live SequenceManager.
    DnD reordering, delete buttons, and "New Batch" are hidden during live sessions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `npx vitest run` — no NEW test failures beyond the ~16 pre-existing ones
3. Manual check: In a live session, the SequenceManager sidebar shows items with an active highlight on the current item
4. Manual check: Pressing ArrowRight/Space advances to next item; ArrowLeft goes back; clicking an item jumps to it
5. Manual check: Navigating to a batch triggers batch activation broadcast; navigating to a slide triggers slide_activated broadcast
</verification>

<success_criteria>
- Session store has activeSessionItemId and navigationDirection fields
- useSequenceNavigation hook handles keyboard navigation with repeat prevention
- SequenceManager renders navigation controls and active highlight in live mode
- SequenceManager is read-only (no DnD, no delete) in live mode
- AdminSession has sidebar layout with SequenceManager during active session
- Batch items trigger handleActivateBatch; slide items broadcast slide_activated
- Auto-activate first item when session begins voting
</success_criteria>

<output>
After completion, create `.planning/phases/18-presentation-controller/18-01-SUMMARY.md`
</output>

---
phase: 24-presentation-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/color-contrast.ts
  - src/lib/chart-colors.ts
  - src/types/database.ts
  - src/stores/template-editor-store.ts
  - src/pages/PresentationView.tsx
  - src/components/editor/PreviewProjection.tsx
  - src/components/PresentationControls.tsx
autonomous: true

must_haves:
  truths:
    - "Slides transition with directional animation (right for next, left for previous) with no visible gap"
    - "All sequence item types (slides and batches) use the same directional slide animation"
    - "Transition duration is ~400ms with cubic-bezier easing"
    - "Navigation Previous/Next buttons are fully visible and not overlapped by batch controls"
    - "Projection view renders background color from session data (defaulting to #1a1a2e)"
    - "Text on projection switches between light and dark based on background luminance"
  artifacts:
    - path: "src/lib/color-contrast.ts"
      provides: "WCAG luminance calculation, getTextColor, getContrastRatio"
      exports: ["getRelativeLuminance", "getTextColor", "getContrastRatio", "hexToRgb"]
    - path: "src/lib/chart-colors.ts"
      provides: "Adaptive chart color generation for custom backgrounds"
      exports: ["getAdaptiveChartColor"]
    - path: "src/types/database.ts"
      provides: "backgroundColor field in SessionBlueprint"
      contains: "backgroundColor"
    - path: "src/stores/template-editor-store.ts"
      provides: "backgroundColor state field with load/save in blueprint"
      contains: "backgroundColor"
    - path: "src/pages/PresentationView.tsx"
      provides: "Unified directional transitions, dynamic background, auto-contrast text"
      contains: "slideVariants"
    - path: "src/components/PresentationControls.tsx"
      provides: "Fixed layout so nav buttons are not hidden behind batch control panel"
  key_links:
    - from: "src/pages/PresentationView.tsx"
      to: "src/lib/color-contrast.ts"
      via: "getTextColor import for auto-contrast"
      pattern: "getTextColor"
    - from: "src/stores/template-editor-store.ts"
      to: "src/types/database.ts"
      via: "SessionBlueprint.backgroundColor in toBlueprint/loadFromBlueprint"
      pattern: "backgroundColor"
---

<objective>
Establish directional slide transitions for all sequence items, create color contrast utilities, add background color infrastructure to the type system and editor store, and fix the nav button overlap layout issue.

Purpose: This is the foundation plan for Phase 24. It creates the color science utilities needed by later plans, updates all transition animations to use consistent directional slides (PRES-01), applies dynamic background color to projection views (partial PRES-02), and fixes the navigation button layout issue (PRES-06).

Output: Unified directional transitions in PresentationView and PreviewProjection, color utility library, backgroundColor field in blueprint types and store, fixed nav button layout.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-presentation-polish/24-RESEARCH.md
@src/pages/PresentationView.tsx
@src/components/editor/PreviewProjection.tsx
@src/components/PresentationControls.tsx
@src/types/database.ts
@src/stores/template-editor-store.ts
@src/lib/color-contrast.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create color utilities, update types and store for background color</name>
  <files>
    src/lib/color-contrast.ts
    src/lib/chart-colors.ts
    src/types/database.ts
    src/stores/template-editor-store.ts
    package.json
  </files>
  <action>
1. Install react-colorful: `npm install react-colorful`

2. Create `src/lib/color-contrast.ts` with the following exports:
   - `hexToRgb(hex: string): { r: number; g: number; b: number }` — parse hex (with or without #) to RGB using regex `/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i`
   - `sRGBtoLinear(channel: number): number` — gamma correction: `c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)` where c = channel/255
   - `getRelativeLuminance(hex: string): number` — WCAG formula: `0.2126 * R + 0.7152 * G + 0.0722 * B` with linearized RGB
   - `getTextColor(backgroundHex: string): 'light' | 'dark'` — luminance > 0.5 returns 'dark' (need dark text), else 'light' (need light text)
   - `getContrastRatio(hex1: string, hex2: string): number` — `(lighter + 0.05) / (darker + 0.05)`

3. Create `src/lib/chart-colors.ts` with:
   - `getAdaptiveChartColor(originalColor: string, backgroundColor: string, minContrast?: number): string` — if contrast ratio >= minContrast (default 3.0), return original. Otherwise, adjust lightness: convert hex to HSL, if bg is dark (luminance < 0.5) increase lightness by 30%, if bg is light decrease by 30%. Return adjusted hex.
   - Helper functions `hexToHsl`, `hslToHex` for color space conversion.
   - Import `getRelativeLuminance`, `getContrastRatio` from `./color-contrast`.

4. Update `src/types/database.ts`:
   - Add `backgroundColor?: string | null;` to `SessionBlueprint` interface (after `globalTemplateId`)

5. Update `src/stores/template-editor-store.ts`:
   - Add `backgroundColor: string | null` to `TemplateEditorState` interface (initial value: `null`)
   - Add `setBackgroundColor: (color: string | null) => void` action
   - Implement `setBackgroundColor` as: `set({ backgroundColor: color, isDirty: true })`
   - In `loadFromBlueprint`: read `blueprint.backgroundColor ?? null` and set it
   - In `toBlueprint`: include `backgroundColor: state.backgroundColor ?? null` in returned object
   - In `reset`: set `backgroundColor: null`
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Verify react-colorful is in package.json dependencies.
    Verify color-contrast.ts and chart-colors.ts exist with expected exports.
  </verify>
  <done>
    color-contrast.ts exports getRelativeLuminance, getTextColor, getContrastRatio, hexToRgb.
    chart-colors.ts exports getAdaptiveChartColor.
    SessionBlueprint has backgroundColor field.
    Template editor store has backgroundColor state with load/save/reset.
    react-colorful installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unify transitions, apply background color, fix nav layout</name>
  <files>
    src/pages/PresentationView.tsx
    src/components/editor/PreviewProjection.tsx
    src/components/PresentationControls.tsx
  </files>
  <action>
1. Update `src/pages/PresentationView.tsx`:
   - REMOVE `crossfadeVariants` entirely (lines 319-323). All items use `slideVariants`.
   - Keep existing `slideVariants` (direction-aware, lines 307-317) — these already match the user requirement.
   - CRITICAL: Change `AnimatePresence mode="wait"` to `AnimatePresence` with NO mode prop (remove mode="wait"). This allows entering and exiting elements to overlap, preventing visible gaps. Add `initial={false}` to suppress initial animation on mount.
   - Change the `motion.div` className from `"w-full h-full"` to `"w-full h-full absolute inset-0"` — absolute positioning for overlap during transitions.
   - Wrap the AnimatePresence in a `<div className="relative w-full h-full overflow-hidden">` container.
   - Remove the conditional `isSlideActive ? slideVariants : crossfadeVariants` — always use `slideVariants`.
   - Change transition to fixed duration: `{ duration: 0.4, ease: [0.4, 0.0, 0.2, 1] }` for ALL items (remove the spring-based transition).
   - Apply dynamic background color: The outer container `div.fixed.inset-0` should use inline `style={{ backgroundColor }}` where backgroundColor comes from a new state or defaults to `'#1a1a2e'`. For now, use a hardcoded default `'#1a1a2e'` since the live session doesn't yet have a mechanism to receive the template background color. Replace the Tailwind class `bg-[#1a1a1a]` with the inline style.
   - Import `getTextColor` from `../lib/color-contrast`. Compute `const textMode = getTextColor(backgroundColor)` and apply `text-white` when 'light' or `text-gray-900` when 'dark' to the outer container. This propagates to children via CSS inheritance.

2. Update `src/components/editor/PreviewProjection.tsx`:
   - Replace existing `crossfadeVariants` with direction-aware `slideVariants` matching PresentationView's pattern:
     ```
     const slideVariants = {
       enter: (direction: 'forward' | 'backward' | null) => ({
         x: direction === 'forward' ? '100%' : direction === 'backward' ? '-100%' : 0,
         opacity: direction ? 0 : 1,
       }),
       center: { x: 0, opacity: 1 },
       exit: (direction: 'forward' | 'backward' | null) => ({
         x: direction === 'forward' ? '-100%' : direction === 'backward' ? '100%' : 0,
         opacity: direction ? 0 : 1,
       }),
     };
     ```
   - Accept a `direction` prop (type: `'forward' | 'backward' | null`) in PreviewProjectionProps. Default to `null`.
   - Accept a `backgroundColor` prop (type: `string`, default `'#1a1a2e'`).
   - Change `AnimatePresence mode="wait"` to `AnimatePresence initial={false}` (no mode).
   - Use `custom={direction}` on AnimatePresence and the motion.div.
   - Change motion.div to absolute positioning within a relative container.
   - Apply `style={{ backgroundColor }}` instead of the current `bg-white` class on the content container.
   - Import `getTextColor` from `../../lib/color-contrast` and apply auto-contrast text color classes.
   - Update transition to `{ duration: 0.4, ease: [0.4, 0.0, 0.2, 1] }`.
   - Update the parent component (SessionPreviewOverlay or wherever PreviewProjection is rendered) to pass `direction` and `backgroundColor` from the template editor store.

3. Fix `src/components/PresentationControls.tsx` (PRES-06):
   - The issue: When a batch is active, `BatchControlPanel` renders as `flex-1` and the navigation controls sit below it. If batch content is tall, nav buttons can be pushed off-screen or overlap with the batch control scrollable area.
   - Fix: Ensure the center area layout uses `flex flex-col` with `min-h-0` on the parent, and the `BatchControlPanel` gets `flex-1 min-h-0 overflow-hidden` so it shrinks to fit, while navigation controls (`pt-4 border-t`) stay pinned at the bottom with `shrink-0`.
   - Specifically: The navigation controls div (around line 249) should have `shrink-0` added to ensure it never gets pushed off-screen.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npm run build` to confirm build succeeds.
    Visual: Open the template editor, go to preview mode, navigate forward/backward — slides should animate directionally (right-to-left for forward, left-to-right for backward) with no visible gap.
  </verify>
  <done>
    PresentationView uses unified directional slide transitions for ALL item types (slides and batches).
    No visible gap during transitions (absolute positioning + no mode="wait").
    Transition duration is ~400ms with cubic-bezier easing.
    PreviewProjection uses matching directional transitions with background color support.
    PresentationControls nav buttons are always visible (shrink-0) and not hidden behind batch controls.
    Projection view background defaults to #1a1a2e with auto-contrast text.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Color utility functions exist and export correctly
4. PresentationView uses single slideVariants for all item types
5. No mode="wait" on the main AnimatePresence in PresentationView
6. Navigation buttons visible in PresentationControls when batch is active
</verification>

<success_criteria>
- PRES-01: Directional slide transitions with no visible gap between full-screen images
- PRES-06: Navigation buttons not hidden behind batch controls
- Color infrastructure (utilities, types, store) ready for Plans 02 and 03
- Background color applied to projection with auto-contrast text
</success_criteria>

<output>
After completion, create `.planning/phases/24-presentation-polish/24-01-SUMMARY.md`
</output>

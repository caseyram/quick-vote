---
phase: 24-presentation-polish
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/components/editor/EditorToolbar.tsx
  - src/components/BatchResultsProjection.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can open a color picker in the template editor toolbar to select background color"
    - "Color picker includes both a visual wheel/slider and a hex text input"
    - "Color picker closes when clicking outside of it"
    - "Changing background color immediately updates the editor preview (live preview)"
    - "Result bar charts adapt their colors to maintain contrast against the chosen background"
    - "Participant view is not affected by background color changes"
  artifacts:
    - path: "src/components/editor/EditorToolbar.tsx"
      provides: "Color picker with HexColorPicker + HexColorInput from react-colorful"
      contains: "HexColorPicker"
    - path: "src/components/BatchResultsProjection.tsx"
      provides: "Chart color adaptation using getAdaptiveChartColor"
      contains: "getAdaptiveChartColor"
  key_links:
    - from: "src/components/editor/EditorToolbar.tsx"
      to: "src/stores/template-editor-store.ts"
      via: "setBackgroundColor action from store"
      pattern: "setBackgroundColor"
    - from: "src/components/BatchResultsProjection.tsx"
      to: "src/lib/chart-colors.ts"
      via: "getAdaptiveChartColor import for chart contrast"
      pattern: "getAdaptiveChartColor"
    - from: "src/components/BatchResultsProjection.tsx"
      to: "src/lib/color-contrast.ts"
      via: "getTextColor for text contrast in results"
      pattern: "getTextColor"
---

<objective>
Add the background color picker UI to the template editor toolbar and adapt chart colors for contrast against custom backgrounds.

Purpose: Completes PRES-02 (admin can set background color via color picker) and PRES-03 (text and charts adapt for contrast). The color utilities and store infrastructure were set up in Plan 01; this plan adds the UI and chart adaptation logic.

Output: Color picker in EditorToolbar, auto-contrast chart rendering in BatchResultsProjection.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-presentation-polish/24-RESEARCH.md
@.planning/phases/24-presentation-polish/24-01-SUMMARY.md
@src/components/editor/EditorToolbar.tsx
@src/components/BatchResultsProjection.tsx
@src/lib/color-contrast.ts
@src/lib/chart-colors.ts
@src/stores/template-editor-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add color picker to EditorToolbar with click-outside handling</name>
  <files>src/components/editor/EditorToolbar.tsx</files>
  <action>
1. Add imports at top of EditorToolbar.tsx:
   - `import { HexColorPicker, HexColorInput } from 'react-colorful';`
   - Add `useRef` to the existing React import if not already there.

2. Destructure `backgroundColor` and `setBackgroundColor` from `useTemplateEditorStore()` in the component body.

3. Add local state for color picker visibility:
   - `const [showColorPicker, setShowColorPicker] = useState(false);`
   - `const colorPickerRef = useRef<HTMLDivElement>(null);`

4. Add click-outside detection effect:
   ```typescript
   useEffect(() => {
     function handleClickOutside(event: MouseEvent) {
       if (colorPickerRef.current && !colorPickerRef.current.contains(event.target as Node)) {
         setShowColorPicker(false);
       }
     }
     if (showColorPicker) {
       document.addEventListener('mousedown', handleClickOutside);
       return () => document.removeEventListener('mousedown', handleClickOutside);
     }
   }, [showColorPicker]);
   ```

5. Add color picker section in the center toolbar area, AFTER the global response template selector section (after the closing `</>` of the responseTemplates conditional). Add a new section:
   ```
   {/* Background color */}
   <div className="w-px h-6 bg-gray-300" />
   <span className="text-xs text-gray-500">Background</span>
   <div className="relative" ref={colorPickerRef}>
     <button
       onClick={() => setShowColorPicker(!showColorPicker)}
       className="w-8 h-8 rounded border-2 border-gray-300 shadow-sm cursor-pointer"
       style={{ backgroundColor: backgroundColor || '#1a1a2e' }}
       title="Projection background color"
     />
     {showColorPicker && (
       <div className="absolute top-10 left-0 z-50 bg-white p-3 rounded-lg shadow-xl border border-gray-200">
         <HexColorPicker
           color={backgroundColor || '#1a1a2e'}
           onChange={setBackgroundColor}
         />
         <HexColorInput
           color={backgroundColor || '#1a1a2e'}
           onChange={setBackgroundColor}
           prefixed
           className="w-full mt-2 px-2 py-1 border border-gray-300 rounded text-sm font-mono text-gray-900"
         />
       </div>
     )}
   </div>
   ```

6. Position the color picker section in the center flex area alongside the existing "Add Batch", "Add Slide", and response template controls. This keeps all template-level settings together in the toolbar.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Visual: Open template editor, see a colored square button in the toolbar. Click it to open color picker. Pick a color — the square updates. Click outside — picker closes. The editor preview (PreviewProjection) should reflect the chosen background color (wired via store in Plan 01).
  </verify>
  <done>
    Color picker button visible in toolbar with current background color swatch.
    Clicking opens HexColorPicker wheel + HexColorInput field.
    Changing color updates store (setBackgroundColor) immediately.
    Clicking outside the picker closes it.
    Default color is #1a1a2e (dark blue-gray).
  </done>
</task>

<task type="auto">
  <name>Task 2: Adapt BatchResultsProjection for auto-contrast charts and text</name>
  <files>src/components/BatchResultsProjection.tsx</files>
  <action>
1. Add new imports:
   - `import { getTextColor } from '../lib/color-contrast';`
   - `import { getAdaptiveChartColor } from '../lib/chart-colors';`

2. Add `backgroundColor` prop to `BatchResultsProjectionProps`:
   - `backgroundColor?: string;`
   - Default to `'#1a1a2e'` when not provided.

3. In the component body, compute text color mode:
   ```typescript
   const bgColor = backgroundColor || '#1a1a2e';
   const textMode = getTextColor(bgColor);
   const headingColor = textMode === 'light' ? 'text-white' : 'text-gray-900';
   const subTextColor = textMode === 'light' ? 'text-gray-400' : 'text-gray-600';
   ```

4. Replace hardcoded text color classes:
   - `text-white` on heading (line 43, line 101) → `${headingColor}`
   - `text-gray-400` on "Results ready" (line 45) → `${subTextColor}`
   - `text-white` on reason text (line 139) → `${headingColor}`
   - `text-gray-300` on reason attribution (line 143) → `${subTextColor}`

5. Adapt chart colors for contrast. After building `chartData` (around line 56-75), map through and adjust colors:
   ```typescript
   const adaptedChartData = chartData.map((item) => ({
     ...item,
     color: getAdaptiveChartColor(item.color, bgColor),
   }));
   ```
   Pass `adaptedChartData` to `<BarChart>` instead of `chartData`.

6. Update the caller in `PresentationView.tsx` to pass `backgroundColor` prop to `BatchResultsProjection`. Read background color from session store or default. Since sessions don't yet store backgroundColor directly (only templates do), for now pass the default `'#1a1a2e'`. The connection to the actual session background will be completed when the full session data flow is wired (the projection view already applies the background color to the container via Plan 01).

7. Also update the reason card background: `bg-white/10` works well on dark backgrounds but poorly on light ones. Make it dynamic:
   ```typescript
   const cardBg = textMode === 'light' ? 'bg-white/10' : 'bg-black/10';
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npm run build` to confirm build succeeds.
  </verify>
  <done>
    BatchResultsProjection accepts backgroundColor prop.
    Text colors (headings, subtitles, reason text) auto-switch based on background luminance.
    Chart bar colors adapt to maintain contrast against custom backgrounds.
    Reason cards use appropriate backdrop for light/dark backgrounds.
    Default behavior (dark background with white text) is preserved when no custom color set.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Color picker opens/closes correctly in toolbar
4. Picking a color updates the preview background in real time
5. Chart colors remain readable against both light and dark backgrounds
6. Text adapts to light/dark based on background luminance
</verification>

<success_criteria>
- PRES-02: Admin can set session background color via full color picker (wheel + hex input) in template editor toolbar
- PRES-03: Text and chart colors adapt for contrast when background changes
- Color picker has click-outside-to-close behavior
- Live preview reflects color changes immediately
</success_criteria>

<output>
After completion, create `.planning/phases/24-presentation-polish/24-02-SUMMARY.md`
</output>

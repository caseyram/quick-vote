---
phase: 24-presentation-polish
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/types/database.ts
  - src/stores/template-editor-store.ts
  - src/components/editor/BatchEditor.tsx
  - src/pages/PresentationView.tsx
  - src/lib/session-template-api.ts
  - supabase/migrations/20260213_070_batch_cover_images.sql
autonomous: true

must_haves:
  truths:
    - "Admin can select an existing slide image as a batch cover image"
    - "Admin can upload a new image as a batch cover image"
    - "Batch cover image choice persists in the template blueprint"
    - "Projection displays batch cover image full-screen while participants answer questions"
    - "Cover image transitions away when results are revealed"
    - "Batches without cover images display existing behavior (batch name + Results ready)"
  artifacts:
    - path: "src/types/database.ts"
      provides: "cover_image_path field in Batch type and SessionBlueprintItem batch"
      contains: "cover_image_path"
    - path: "src/stores/template-editor-store.ts"
      provides: "cover_image_path in EditorItem batch interface, serialized to/from blueprint"
      contains: "cover_image_path"
    - path: "src/components/editor/BatchEditor.tsx"
      provides: "Cover image selector UI (dropdown + upload button)"
      contains: "cover_image_path"
    - path: "src/pages/PresentationView.tsx"
      provides: "Cover image rendering during active batch before results reveal"
      contains: "cover_image_path"
    - path: "supabase/migrations/20260213_070_batch_cover_images.sql"
      provides: "Database column for batch cover images"
      contains: "cover_image_path"
  key_links:
    - from: "src/components/editor/BatchEditor.tsx"
      to: "src/stores/template-editor-store.ts"
      via: "updateItem sets cover_image_path in batch"
      pattern: "cover_image_path"
    - from: "src/pages/PresentationView.tsx"
      to: "src/types/database.ts"
      via: "Batch.cover_image_path read for display"
      pattern: "cover_image_path"
    - from: "src/stores/template-editor-store.ts"
      to: "src/types/database.ts"
      via: "SessionBlueprintItem.batch.cover_image_path serialization"
      pattern: "cover_image_path"
---

<objective>
Add batch cover image support: admin can associate images with batches, and projection displays cover images during voting.

Purpose: Completes PRES-04 (admin can associate slide image with batch as cover) and PRES-05 (projection displays batch cover image during voting). Cover images transform the voting experience from a text-only "Results ready" screen to an immersive branded display.

Output: Cover image selector in BatchEditor, cover image rendering on projection, database migration, blueprint persistence.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-presentation-polish/24-RESEARCH.md
@.planning/phases/24-presentation-polish/24-01-SUMMARY.md
@src/types/database.ts
@src/stores/template-editor-store.ts
@src/components/editor/BatchEditor.tsx
@src/pages/PresentationView.tsx
@src/lib/session-template-api.ts
@src/components/SlideDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cover_image_path to types, store, blueprint, and migration</name>
  <files>
    src/types/database.ts
    src/stores/template-editor-store.ts
    src/lib/session-template-api.ts
    supabase/migrations/20260213_070_batch_cover_images.sql
  </files>
  <action>
1. Create database migration `supabase/migrations/20260213_070_batch_cover_images.sql`:
   ```sql
   -- Add cover image path to batches table
   ALTER TABLE batches ADD COLUMN cover_image_path TEXT NULL;
   ```

2. Update `src/types/database.ts`:
   - Add `cover_image_path: string | null;` to the `Batch` interface (after `status`)
   - Add `cover_image_path?: string | null;` to the `batch` property within `SessionBlueprintItem` (after `template_id`)

3. Update `src/stores/template-editor-store.ts`:
   - Add `cover_image_path: string | null;` to the `batch` object within `EditorItem` interface (after `template_id`)
   - In `loadFromBlueprint`, when creating EditorItem from blueprint batch items, read `cover_image_path: blueprintItem.batch.cover_image_path ?? null`
   - In `toBlueprint`, when creating SessionBlueprintItem from EditorItem batch items, include `cover_image_path: item.batch.cover_image_path ?? null`
   - In `addItem` (the handleAddBatch path in EditorToolbar), the new batch already gets its shape from the caller — no change needed in the store, just ensure BatchEditor and EditorToolbar set `cover_image_path: null` when creating new batches. Check if `addItem` or the callers need updating.
   - IMPORTANT: Also check the `handleAddBatch` function in EditorToolbar.tsx — the `newBatch` object must include `cover_image_path: null` in the batch property.

4. Update `src/lib/session-template-api.ts`:
   - In `loadTemplateIntoSession`, when creating a batch via supabase insert, include `cover_image_path: item.batch.cover_image_path ?? null` in the insert payload.
   - In `serializeSession`, when mapping batch data to blueprint format, include `cover_image_path: batch?.cover_image_path ?? null` (read from the Batch object, not the question).

5. Run the migration against local Supabase: `npx supabase db push` or apply via Supabase dashboard.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Check that the migration file exists and has valid SQL.
    Verify blueprint round-trip: the cover_image_path field should appear in both loadFromBlueprint and toBlueprint paths.
  </verify>
  <done>
    Batch type has cover_image_path field.
    SessionBlueprintItem batch has cover_image_path field.
    EditorItem batch has cover_image_path field.
    loadFromBlueprint reads cover_image_path from blueprint.
    toBlueprint writes cover_image_path to blueprint.
    loadTemplateIntoSession creates batches with cover_image_path.
    serializeSession includes cover_image_path in blueprint output.
    Database migration adds column to batches table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cover image selector UI and projection display</name>
  <files>
    src/components/editor/BatchEditor.tsx
    src/components/editor/EditorToolbar.tsx
    src/pages/PresentationView.tsx
  </files>
  <action>
1. Update `src/components/editor/EditorToolbar.tsx`:
   - In the `handleAddBatch` function, add `cover_image_path: null` to the `batch` object of `newBatch`.

2. Update `src/components/editor/BatchEditor.tsx` — add cover image selector in the batch toolbar:
   - Import `useTemplateEditorStore` items selector: `const allItems = useTemplateEditorStore((s) => s.items);`
   - Import `{ useState, useRef }` (useRef for file input).
   - Import `imageCompression from 'browser-image-compression'` and `{ uploadSlideImage } from '../../lib/slide-api'`.
   - Import `{ getSlideImageUrl } from '../../lib/slide-api'` for thumbnail display.
   - Add state: `const [uploadingCover, setUploadingCover] = useState(false);`
   - Add ref: `const coverFileInputRef = useRef<HTMLInputElement>(null);`
   - Compute available slides: `const availableSlides = allItems.filter((i) => i.item_type === 'slide' && i.slide?.image_path);`
   - In the batch toolbar (the `<div className="bg-white rounded-lg border...">` around line 182), add a cover image section between the question count badge and the spacer `<div className="flex-1" />`:

   After the question count badge and BEFORE `<div className="flex-1" />`, add:
   ```jsx
   {/* Cover image selector */}
   <div className="flex items-center gap-1.5 flex-shrink-0">
     <label className="text-xs text-gray-500">Cover</label>
     {item.batch.cover_image_path && (
       <img
         src={getSlideImageUrl(item.batch.cover_image_path)}
         alt="Cover"
         className="w-6 h-6 rounded object-cover"
       />
     )}
     <select
       value={item.batch.cover_image_path || ''}
       onChange={(e) => {
         updateItem(item.id, {
           batch: { ...item.batch!, cover_image_path: e.target.value || null },
         });
       }}
       className="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm text-gray-700 max-w-[140px]"
     >
       <option value="">None</option>
       {availableSlides.map((slide) => (
         <option key={slide.id} value={slide.slide!.image_path}>
           {slide.slide!.caption || 'Slide'}
         </option>
       ))}
     </select>
     <button
       onClick={() => coverFileInputRef.current?.click()}
       disabled={uploadingCover}
       className="px-2 py-1 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-600 rounded transition-colors disabled:opacity-50"
       title="Upload new cover image"
     >
       {uploadingCover ? '...' : 'Upload'}
     </button>
     <input
       ref={coverFileInputRef}
       type="file"
       accept="image/jpeg,image/png,image/webp,image/gif"
       onChange={handleCoverUpload}
       className="hidden"
     />
   </div>
   ```

   - Implement `handleCoverUpload`:
   ```typescript
   const handleCoverUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
     const file = e.target.files?.[0];
     if (!file) return;
     setUploadingCover(true);
     try {
       const compressed = await imageCompression(file, {
         maxSizeMB: 1,
         maxWidthOrHeight: 1920,
         useWebWorker: true,
         fileType: 'image/webp',
         initialQuality: 0.85,
         preserveExif: false,
       });
       const imagePath = await uploadSlideImage('templates', compressed);
       updateItem(item.id, {
         batch: { ...item.batch!, cover_image_path: imagePath },
       });
     } catch (err) {
       console.error('Failed to upload cover image:', err);
       alert('Failed to upload image. Please try again.');
     } finally {
       setUploadingCover(false);
       if (coverFileInputRef.current) coverFileInputRef.current.value = '';
     }
   };
   ```

3. Update `src/pages/PresentationView.tsx` — display cover image during batch voting:
   - In the batch rendering section (around line 352, where `currentItem?.item_type === 'batch'`):
   - Before rendering `BatchResultsProjection`, check if the batch has a cover_image_path AND no questions have been revealed yet.
   - Look up the batch: `const currentBatch = currentItem.batch_id ? batches.find((b) => b.id === currentItem.batch_id) : null;`
   - Check if any questions are revealed: look at the `revealedQuestions` set — if empty, show the cover image.
   - If `currentBatch?.cover_image_path && revealedQuestions.size === 0`, render a full-screen cover image using the `SlideDisplay` component (already imported):
     ```jsx
     <SlideDisplay imagePath={currentBatch.cover_image_path} caption={null} />
     ```
   - Otherwise, render `BatchResultsProjection` as before.
   - The cover image will naturally transition away (via the directional animation already set up in Plan 01) when results are revealed, because the key changes when the content switches.
   - IMPORTANT: The `revealedQuestions` state already exists in PresentationView. Use an AnimatePresence wrapper around the cover image / results content within the batch section so the cover image fades/slides out smoothly when the first result is revealed. Use a simple crossfade (opacity 0 -> 1 -> 0) for this inner transition since the directional slide is for item-to-item navigation, not within-item state changes.

   Implementation pattern for the batch section:
   ```jsx
   currentItem?.item_type === 'batch' && currentItem.batch_id ? (
     (() => {
       const currentBatch = batches.find((b) => b.id === currentItem.batch_id);
       const showCover = currentBatch?.cover_image_path && revealedQuestions.size === 0;
       return (
         <AnimatePresence mode="wait">
           {showCover ? (
             <motion.div
               key="batch-cover"
               initial={{ opacity: 0 }}
               animate={{ opacity: 1 }}
               exit={{ opacity: 0 }}
               transition={{ duration: 0.4 }}
               className="w-full h-full"
             >
               <SlideDisplay imagePath={currentBatch!.cover_image_path!} caption={null} />
             </motion.div>
           ) : (
             <motion.div
               key="batch-results"
               initial={{ opacity: 0 }}
               animate={{ opacity: 1 }}
               exit={{ opacity: 0 }}
               transition={{ duration: 0.4 }}
               className="w-full h-full"
             >
               <BatchResultsProjection
                 batchId={currentItem.batch_id!}
                 batchName={currentBatch?.name ?? 'Untitled Batch'}
                 questions={useSessionStore.getState().questions}
                 sessionVotes={sessionVotes}
                 revealedQuestions={revealedQuestions}
                 highlightedReason={highlightedReason}
               />
             </motion.div>
           )}
         </AnimatePresence>
       );
     })()
   )
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Run `npm run build` to confirm build succeeds.
    Visual: In the template editor, create a batch and select a slide as cover image from the dropdown. The selection persists. Save template, reload — cover image is still set.
  </verify>
  <done>
    BatchEditor shows cover image selector (dropdown of existing slides + upload button).
    Selecting a slide sets cover_image_path on the batch.
    Uploading a new image compresses and uploads it, then sets as cover.
    Cover image persists through blueprint save/load cycle.
    PresentationView displays cover image full-screen when batch is active and no results revealed.
    Cover image fades out when first result is revealed.
    Batches without cover images show existing "Results ready" behavior.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. BatchEditor cover image dropdown shows available slides
4. Upload button works for new cover images
5. Cover image appears in projection during batch voting
6. Cover transitions away when results are revealed
7. Blueprint save/load preserves cover image path
</verification>

<success_criteria>
- PRES-04: Admin can associate slide image with batch as cover image (from existing slides or upload new)
- PRES-05: Projection displays batch cover image while participants answer batch questions
- Cover image transitions away cleanly when results are revealed
- Cover image persists in template blueprint through save/load
</success_criteria>

<output>
After completion, create `.planning/phases/24-presentation-polish/24-03-SUMMARY.md`
</output>

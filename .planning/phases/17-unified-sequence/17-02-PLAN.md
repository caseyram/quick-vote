---
phase: 17-unified-sequence
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/components/SequenceItemCard.tsx
  - src/components/SequenceManager.tsx
  - src/pages/AdminSession.tsx
autonomous: false

must_haves:
  truths:
    - "Admin sees slides and batches in a single ordered, numbered list on the session edit view"
    - "Batch cards show blue tint with batch icon and question count"
    - "Slide cards show purple tint with image icon and thumbnail"
    - "Admin can drag-and-drop to reorder any item, with order persisted to database on drop"
    - "Admin can delete items from the sequence list with confirmation"
    - "Empty sequence shows prompt with action buttons"
    - "Drag handles are always visible with DragOverlay preview during drag"
  artifacts:
    - path: "src/components/SequenceItemCard.tsx"
      provides: "Color-coded card component for batch or slide items"
      min_lines: 60
    - path: "src/components/SequenceManager.tsx"
      provides: "DnD-enabled unified sequence list with reordering"
      min_lines: 120
    - path: "src/pages/AdminSession.tsx"
      provides: "SequenceManager replaces separate BatchList and SlideManager in draft view"
      contains: "SequenceManager"
  key_links:
    - from: "src/components/SequenceManager.tsx"
      to: "src/stores/session-store.ts"
      via: "useSessionStore for sessionItems, batches, questions"
      pattern: "useSessionStore"
    - from: "src/components/SequenceManager.tsx"
      to: "src/lib/sequence-api.ts"
      via: "reorderSessionItems on drag end"
      pattern: "reorderSessionItems"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/SequenceManager.tsx"
      via: "SequenceManager component in draft view"
      pattern: "<SequenceManager"
    - from: "src/components/SequenceItemCard.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook for drag behavior"
      pattern: "useSortable"
---

<objective>
Build the SequenceManager UI that displays slides and batches in a single drag-and-drop list, replacing the separate BatchList and SlideManager in the admin draft view.

Purpose: Delivers the user-facing unified sequence experience -- the core of Phase 17's requirement (SEQ-01).
Output: SequenceItemCard.tsx (color-coded cards), SequenceManager.tsx (DnD list), and AdminSession.tsx updated to use SequenceManager.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-unified-sequence/17-CONTEXT.md
@.planning/phases/17-unified-sequence/17-RESEARCH.md
@.planning/phases/17-unified-sequence/17-01-SUMMARY.md

Key source files:
@src/components/BatchList.tsx
@src/components/SlideManager.tsx
@src/lib/sequence-api.ts
@src/lib/slide-api.ts
@src/stores/session-store.ts
@src/pages/AdminSession.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SequenceItemCard and SequenceManager components</name>
  <files>src/components/SequenceItemCard.tsx, src/components/SequenceManager.tsx</files>
  <action>
**SequenceItemCard.tsx:**

A sortable card that renders either a batch or slide item with visual distinction.

Props interface:
```typescript
interface SequenceItemCardProps {
  item: SessionItem;
  index: number;          // 0-based position for display (shows as index+1)
  batch?: Batch;          // Populated for batch items (looked up by parent)
  questionCount?: number; // Number of questions in the batch
  onDelete: (item: SessionItem) => void;
  onExpandBatch?: (batchId: string) => void;  // Click to expand batch details
}
```

Import `SessionItem` from `../types/database` for the props type. Import `Batch` from `../types/database` (or from wherever Batch type is defined -- check existing imports in BatchList.tsx for the correct path).

Implementation:
- Use `useSortable({ id: item.id })` from @dnd-kit/sortable. Use the session_item UUID directly as the sortable ID (NOT type-prefixed -- the session_item.id is already unique).
- Apply `CSS.Transform.toString(transform)` and `transition` to the wrapper div.
- Set `opacity: 0.5` when `isDragging`.
- Color coding (Tailwind classes):
  - Batch: `bg-blue-50 border-blue-200 hover:border-blue-300` with blue-600 icon
  - Slide: `bg-purple-50 border-purple-200 hover:border-purple-300` with purple-600 icon
- Layout (flex row):
  - Drag handle (left): 6-dot grip icon using `{...attributes} {...listeners}` on the handle div. Use `cursor-grab active:cursor-grabbing` classes. Icon color: `text-gray-400 hover:text-gray-600`.
  - Position number: Show `index + 1` in a small circle/badge (`w-6 h-6 rounded-full bg-gray-200 text-gray-600 text-xs font-medium flex items-center justify-center`).
  - Type icon: Inline SVG batch icon (grid/list) for batches, image icon for slides. Use the same inline SVG pattern as the rest of the codebase (NOT lucide-react).
  - Content area (flex-1):
    - For batches: batch name (bold) + "{N} questions" subtitle
    - For slides: caption or "Untitled Slide" + small thumbnail (32x32, rounded, object-cover) from `getSlideImageUrl(item.slide_image_path!)`
  - Delete button (right): Small trash icon button with `text-gray-400 hover:text-red-500` transition. On click, call `onDelete(item)`.
- For batch cards: Make the content area clickable to expand batch details (call `onExpandBatch`).
- Use LIGHT theme colors throughout (bg-white base, text-gray-900 text) -- this is the admin draft view.

**SequenceManager.tsx:**

The main unified sequence list with drag-and-drop.

Props interface:
```typescript
interface SequenceManagerProps {
  sessionId: string;
  onExpandBatch: (batchId: string) => void;
  onCreateBatch: () => Promise<string | undefined>;
  onDeleteBatch: (batchId: string) => void;
  onDeleteSlide: (item: SessionItem) => void;
}
```

Import `SessionItem` from `../types/database` for the props type and for the `onDeleteSlide` callback parameter.

Implementation:
1. Read from Zustand store: `const { sessionItems, batches, questions } = useSessionStore()`.
2. Compute a lookup for batch question counts: `const batchQuestionCounts = useMemo(...)` -- map batch_id to count of questions with that batch_id.
3. Compute a lookup for batch objects: `const batchMap = useMemo(...)` -- map batch id to Batch object.
4. Sortable IDs: `const sortableIds = useMemo(() => sessionItems.map(item => item.id), [sessionItems])`.
5. DnD setup:
   - Use `useSensors` with `PointerSensor` (distance: 8) and `KeyboardSensor` (sortableKeyboardCoordinates).
   - Use `useId()` for DndContext id (prevents conflicts with any nested DndContexts in BatchCard).
   - `closestCenter` collision detection.
6. `handleDragStart`: Set `activeId` state for DragOverlay.
7. `handleDragEnd`:
   - Get old and new index from sortableIds.
   - Compute new order using array splice (same pattern as BatchList.tsx).
   - Optimistic update: Call `useSessionStore.getState().updateSessionItemPositions(newOrder.map((id, idx) => ({ id, position: idx })))`.
   - Persist: Call `reorderSessionItems(newOrder.map((id, idx) => ({ id, position: idx })))` from sequence-api.ts.
   - Reset activeId to null.
8. `handleDeleteItem`: Delegate to parent callbacks based on item type.
   - For batch items (`item.item_type === 'batch'` and `item.batch_id`): call `onDeleteBatch(item.batch_id)`.
   - For slide items: call `onDeleteSlide(item)`.
   - Note: `deleteSessionItem` is NOT used here. Batch deletion cascades to session_items via FK CASCADE. Slide deletion uses `deleteSlide` from slide-api.ts which deletes the session_item row directly.

9. Render:
   ```
   <DndContext id={dndId} sensors={sensors} collisionDetection={closestCenter} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>
     <SortableContext items={sortableIds} strategy={verticalListSortingStrategy}>
       <div className="space-y-2">
         {sessionItems.map((item, index) => (
           <SequenceItemCard
             key={item.id}
             item={item}
             index={index}
             batch={item.item_type === 'batch' && item.batch_id ? batchMap[item.batch_id] : undefined}
             questionCount={item.item_type === 'batch' && item.batch_id ? batchQuestionCounts[item.batch_id] ?? 0 : undefined}
             onDelete={(item) => item.item_type === 'batch' && item.batch_id ? onDeleteBatch(item.batch_id) : onDeleteSlide(item)}
             onExpandBatch={onExpandBatch}
           />
         ))}
       </div>
     </SortableContext>
     <DragOverlay>
       {activeItem && (
         <div className="bg-white border-2 border-indigo-400 rounded-lg p-3 shadow-lg opacity-90">
           <div className="flex items-center gap-2">
             {activeItem.item_type === 'batch' ? (
               <>
                 <span className="text-blue-600 font-medium">{batchMap[activeItem.batch_id!]?.name ?? 'Batch'}</span>
                 <span className="text-gray-400 text-sm">{batchQuestionCounts[activeItem.batch_id!] ?? 0} questions</span>
               </>
             ) : (
               <span className="text-purple-600 font-medium">{activeItem.slide_caption || 'Slide'}</span>
             )}
           </div>
         </div>
       )}
     </DragOverlay>
   </DndContext>
   ```

10. Empty state: When sessionItems.length === 0, show:
    ```
    <div className="text-center py-8">
      <p className="text-gray-500 mb-4">No items yet. Add a batch or slide to get started.</p>
      <div className="flex gap-3 justify-center">
        <button onClick={onCreateBatch} className="px-4 py-2 border border-dashed border-gray-300 hover:border-blue-400 text-gray-500 hover:text-blue-600 rounded-lg transition-colors">
          + New Batch
        </button>
      </div>
    </div>
    ```

11. Bottom action buttons (always visible below the list when items exist):
    ```
    <div className="flex gap-3 mt-3">
      <button onClick={onCreateBatch}>+ New Batch</button>
    </div>
    ```
    Note: Slide creation stays in the ImageUploader/SlideManager component which will remain accessible. The "+ New Batch" button is the primary action here. Slide upload can be triggered from the existing SlideManager section or integrated in a future iteration.

Import DnD dependencies from @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities (same imports as BatchList.tsx).
Import `reorderSessionItems` from `../lib/sequence-api`.
Import `deleteSlide` from `../lib/slide-api`.
Import `getSlideImageUrl` from `../lib/slide-api` (for thumbnails).
Import `useSessionStore` from `../stores/session-store`.

Use inline SVG icons throughout -- do NOT use lucide-react (not installed).
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors.
Verify both components export correctly: `grep "export" src/components/SequenceItemCard.tsx src/components/SequenceManager.tsx`.
  </verify>
  <done>
SequenceItemCard.tsx renders color-coded sortable cards with drag handles, position numbers, type icons, content, and delete buttons. SequenceManager.tsx renders a DnD-enabled list from sessionItems store, handles reorder with optimistic update + DB persist, shows empty state, and delegates delete to parent. No type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace BatchList + SlideManager with SequenceManager in AdminSession draft view</name>
  <files>src/pages/AdminSession.tsx</files>
  <action>
In AdminSession.tsx, update the draft view section to use SequenceManager instead of the separate BatchList and SlideManager.

**COMPLEXITY NOTE:** This task has 8 numbered steps touching multiple integration points in AdminSession.tsx. Follow each step carefully in order. Read the existing code around each integration point before making changes.

1. **Import SequenceManager and SessionItem:** Add:
   - `import { SequenceManager } from '../components/SequenceManager';`
   - `import { SessionItem } from '../types/database';` (if not already imported -- check existing imports first)
   - `import { deleteSlide } from '../lib/slide-api';` (if not already imported)
   - `import { ImageUploader } from '../components/ImageUploader';` (if not already imported)
   - `import { createSlide } from '../lib/slide-api';` (if not already imported)

2. **Remove BatchList from draft view:** In the draft view JSX (the `{isDraft && (...)}` block), find the "Questions & Batches" section (around line 1044-1090). Replace the `<BatchList ... />` usage with `<SequenceManager ... />`.

   The new JSX should look like:
   ```tsx
   <div className="bg-white rounded-lg p-6 space-y-4">
     <h2 className="text-lg font-semibold text-gray-900 mb-4">Session Sequence</h2>
     <SequenceManager
       sessionId={session.session_id}
       onExpandBatch={(batchId) => setExpandedBatchId(batchId)}
       onCreateBatch={handleCreateBatch}
       onDeleteBatch={handleDeleteBatch}
       onDeleteSlide={handleDeleteSlide}
     />
     <div className="pt-4 border-t border-gray-200">
       <SessionImportExport ... />
     </div>
   </div>
   ```

3. **Create handleDeleteSlide handler:** Add a new handler in AdminSession:
   ```typescript
   async function handleDeleteSlide(item: SessionItem) {
     if (!window.confirm('Delete this slide? The image will be permanently removed.')) return;
     try {
       await deleteSlide(item.id, item.slide_image_path!);
       useSessionStore.getState().removeSessionItem(item.id);
     } catch (err) {
       console.error('Failed to delete slide:', err);
     }
   }
   ```
   Note: The `item` parameter is typed as `SessionItem` (imported in step 1). The `deleteSlide` function is imported from `../lib/slide-api` (also in step 1).

4. **Keep ImageUploader accessible:** Use APPROACH B: Render `<ImageUploader sessionId={session.session_id} onUploaded={handleSlideUploaded} />` inside the sequence section (below the SequenceManager list, above the action buttons or in its own subsection). Create handler:
   ```typescript
   async function handleSlideUploaded(imagePath: string) {
     try {
       const newSlide = await createSlide(session.session_id, imagePath, null);
       useSessionStore.getState().addSessionItem(newSlide);
     } catch (err) {
       console.error('Failed to create slide:', err);
     }
   }
   ```

5. **Remove standalone SlideManager:** Remove `<SlideManager sessionId={session.session_id} />` from the draft view (around line 1097). Slides are now shown inline in the sequence.

6. **Keep BatchList for non-draft views:** BatchList is still used in the active view for batch management. Do NOT remove the BatchList import or its usage in non-draft views. Only replace it in the draft view section.

   IMPORTANT: Actually, review the code -- BatchList may only be rendered in the draft view (inside `{isDraft && ...}`). The active view uses separate batch handling. So removing BatchList from draft is safe. Keep the import if it's used elsewhere; remove it if only used in draft.

7. **Handle onExpandBatch with expandedBatchId state:** When a batch card in the sequence is clicked, render the existing `<BatchCard>` component below the sequence list for the selected batch. This preserves all batch editing functionality without complicating the sortable list.

   Add state: `const [expandedBatchId, setExpandedBatchId] = useState<string | null>(null);`
   Add state: `const [addingToBatchId, setAddingToBatchId] = useState<string | null>(null);`
   (These may already exist -- check before adding duplicates. The `_addingQuestionToBatchId` state exists but is prefixed with underscore. Rename or reuse as needed.)

   Below the SequenceManager, conditionally render a BatchCard for the expanded batch:
   ```tsx
   {expandedBatchId && (() => {
     const batch = batches.find(b => b.id === expandedBatchId);
     if (!batch) return null;
     return (
       <div className="bg-white rounded-lg p-4 border border-blue-200">
         <div className="flex items-center justify-between mb-3">
           <h3 className="text-sm font-medium text-gray-500">Editing Batch</h3>
           <button onClick={() => setExpandedBatchId(null)} className="text-gray-400 hover:text-gray-600 text-sm">Close</button>
         </div>
         <BatchCard
           sessionId={session.session_id}
           batch={batch}
           questions={questions.filter(q => q.batch_id === batch.id)}
           isExpanded={true}
           isAddingQuestion={addingToBatchId === batch.id}
           isActive={false}
           canActivate={false}
           showActivateButton={false}
           onToggle={() => setExpandedBatchId(null)}
           onNameChange={(name) => handleBatchNameChange(batch.id, name)}
           onQuestionReorder={(ids) => handleQuestionReorder(batch.id, ids)}
           onEditQuestion={setEditingQuestion}
           onDeleteQuestion={handleDelete}
           onAddQuestion={() => setAddingToBatchId(batch.id)}
           onAddQuestionDone={() => setAddingToBatchId(null)}
           onDeleteBatch={() => handleDeleteBatch(batch.id)}
           onActivate={handleActivateBatch}
           onClose={handleCloseBatch}
         />
       </div>
     );
   })()}
   ```

   Import `BatchCard` from `../components/BatchCard`.

8. **Ensure handleReorderItems in AdminSession is updated or replaced:** The existing `handleReorderItems` updates batch.position and question.position. In the new unified sequence, reordering should update session_items.position instead. The SequenceManager handles this internally via `reorderSessionItems` from sequence-api.ts. The existing `handleReorderItems` in AdminSession can remain for backward compatibility but is no longer called from the draft view.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors.
Run `npm test` and confirm no regressions.
Open the app in browser, navigate to a session in draft mode. Verify:
1. The "Session Sequence" section shows all batches and slides in a single numbered list
2. Batch cards have blue tint, slide cards have purple tint
3. Drag and drop works -- items can be reordered
4. After reorder, refresh the page -- order persists
5. Delete a slide from the sequence -- it is removed
6. Delete a batch from the sequence -- it is removed with confirmation
7. Click a batch card -- batch detail panel opens below for editing
8. Image upload still works (ImageUploader visible)
  </verify>
  <done>
AdminSession draft view shows SequenceManager with unified sequence of batches and slides. Drag-and-drop reorders items with database persistence. Batch expansion works for editing questions. Slide upload works via ImageUploader. SlideManager removed from draft view. No type errors, no test regressions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Unified sequence UI replacing separate BatchList and SlideManager in the admin draft view. Color-coded cards (blue batches, purple slides) with drag-and-drop reordering, position numbers, delete buttons, and batch expansion for editing.</what-built>
  <how-to-verify>
1. Open the app and navigate to an existing session with batches (and optionally slides) in draft mode.
2. Verify the "Session Sequence" section shows all items in a single numbered list.
3. Verify batch cards have blue tint and show question count; slide cards have purple tint and show thumbnail.
4. Drag an item to a new position. Verify the order updates visually.
5. Refresh the page. Verify the new order persists.
6. Click a batch card to expand it. Verify you can see and edit its questions.
7. Delete a slide from the sequence. Verify it is removed.
8. Delete a batch from the sequence. Verify confirmation dialog appears and batch is removed.
9. Upload a new image via the ImageUploader. Verify it appears in the sequence as a new slide.
10. Create a new batch. Verify it appears at the end of the sequence.
11. Open a session that previously had NO session_items (only batches). Verify backfill works -- items appear correctly.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm test` shows no new failures
3. Session edit view shows unified sequence with color-coded, numbered cards
4. Drag-and-drop reorders items with immediate visual feedback and database persistence
5. Existing sessions are backfilled on first load (batches get session_items)
6. Batch expansion works for question editing within the sequence
7. Slide creation via ImageUploader adds to sequence
8. Batch/slide deletion removes from sequence
9. DragOverlay shows preview during drag
10. Empty state shows helpful prompt
</verification>

<success_criteria>
- Admin sees slides and batches in a single ordered list on session edit view (SC-1)
- Admin can drag-and-drop to reorder with order persisted to database (SC-2)
- Existing sessions are backfilled from batch ordering (SC-3)
- Color-coded cards distinguish batches (blue) from slides (purple)
- Position numbers show explicit order (1, 2, 3...)
- Batch expansion preserves question editing capability
- No type errors, no test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-unified-sequence/17-02-SUMMARY.md`
</output>

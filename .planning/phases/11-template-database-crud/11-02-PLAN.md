---
phase: 11-template-database-crud
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/ResponseTemplatePanel.tsx
  - src/components/TemplateEditor.tsx
  - src/pages/AdminSession.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees a 'Response Templates' section in the draft session view"
    - "Admin can create a new template by entering a name and adding options"
    - "Admin can edit an existing template (rename, add/remove/reorder options via drag-and-drop)"
    - "Admin can delete a template with confirmation dialog showing usage count"
    - "Template editor enforces: min 2 options, no empty options, no duplicate option text, unique name"
    - "If linked questions have votes, option edits are blocked with explanation"
    - "If linked questions exist (no votes), edit confirmation shows count before saving"
    - "Template list shows each template name with preview of option labels"
  artifacts:
    - path: "src/components/ResponseTemplatePanel.tsx"
      provides: "Template list with create/edit/delete actions"
      exports: ["ResponseTemplatePanel"]
      min_lines: 80
    - path: "src/components/TemplateEditor.tsx"
      provides: "Modal editor with name input, drag-drop option list, validation"
      exports: ["TemplateEditor"]
      min_lines: 100
    - path: "src/pages/AdminSession.tsx"
      provides: "Integrates ResponseTemplatePanel replacing old TemplatePanel"
      contains: "ResponseTemplatePanel"
  key_links:
    - from: "src/components/ResponseTemplatePanel.tsx"
      to: "src/lib/template-api.ts"
      via: "fetchTemplates, createTemplate, updateTemplate, deleteTemplate imports"
      pattern: "from.*template-api"
    - from: "src/components/ResponseTemplatePanel.tsx"
      to: "src/stores/template-store.ts"
      via: "useTemplateStore for reading template state"
      pattern: "useTemplateStore"
    - from: "src/components/TemplateEditor.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext, SortableContext for option reordering"
      pattern: "@dnd-kit"
    - from: "src/components/ResponseTemplatePanel.tsx"
      to: "src/components/ConfirmDialog.tsx"
      via: "Delete and edit propagation confirmation dialogs"
      pattern: "ConfirmDialog"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/ResponseTemplatePanel.tsx"
      via: "import and render in draft view"
      pattern: "ResponseTemplatePanel"
---

<objective>
Build the complete template management UI: a panel listing templates with create/edit/delete actions, a modal editor with drag-and-drop option reordering, and integration into the AdminSession draft view.

Purpose: Gives admins the ability to visually manage response templates with the same tactile feel as the rest of the app (drag-and-drop, confirmation dialogs, consistent option input patterns).
Output: ResponseTemplatePanel.tsx, TemplateEditor.tsx, updated AdminSession.tsx
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-database-crud/11-CONTEXT.md
@.planning/phases/11-template-database-crud/11-RESEARCH.md
@.planning/phases/11-template-database-crud/11-01-SUMMARY.md
@src/components/ConfirmDialog.tsx
@src/components/QuestionForm.tsx
@src/components/BatchList.tsx
@src/components/TemplatePanel.tsx
@src/pages/AdminSession.tsx
@src/stores/template-store.ts
@src/lib/template-api.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TemplateEditor component with drag-and-drop options</name>
  <files>src/components/TemplateEditor.tsx</files>
  <action>
Create `src/components/TemplateEditor.tsx` — a modal dialog for creating and editing response templates.

**Props interface:**
```typescript
interface TemplateEditorProps {
  template?: ResponseTemplate | null;  // null = create mode, object = edit mode
  onSave: (name: string, options: string[]) => Promise<void>;
  onCancel: () => void;
  saving?: boolean;
  error?: string | null;
}
```

**Layout (modal overlay — matches ConfirmDialog's overlay pattern):**
- Fixed overlay `bg-black/50` with centered content card
- Card: `bg-white rounded-xl p-6 w-full max-w-lg space-y-4`
- Title: "Create Template" or "Edit Template" based on mode

**Name input:**
- Text input matching QuestionForm style adapted for light theme (admin uses light theme):
  `px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500`
- Placeholder: "Template name"
- Label: "Name" (text-sm font-medium text-gray-700)

**Options list with drag-and-drop:**
- Use `@dnd-kit/core` (DndContext, closestCenter, PointerSensor) and `@dnd-kit/sortable` (SortableContext, verticalListSortingStrategy, useSortable, arrayMove) — same imports as BatchList.tsx
- PointerSensor with `activationConstraint: { distance: 8 }` (matches BatchList pattern)
- Each option is a sortable item with:
  - Drag handle (6-dot grip icon, same SVG as BatchList's SortableQuestionCard)
  - Text input (matching QuestionForm option input style, adapted for light theme: `bg-gray-50 border border-gray-300 rounded-lg text-gray-900`)
  - Remove button (only if options.length > 2, matching QuestionForm's red "Remove" button: `text-red-500 hover:text-red-400`)
- Use array index as sortable ID (wrap in string: `option-${index}`)
- On drag end, use `arrayMove` to reorder the options array
- "Add Option" button below list (matches QuestionForm's `+ Add Option` style: `text-indigo-600 hover:text-indigo-500 font-medium text-sm`)
- Max 10 options (same limit as QuestionForm — `options.length < 10`)

**Validation (on save click):**
- Name must be non-empty after trim
- At least 2 non-empty options (filter out empty-after-trim options)
- No duplicate option text (case-sensitive, after trim)
- Show inline error message if validation fails (text-red-500 text-sm, same as QuestionForm pattern)

**Footer buttons:**
- Cancel button: `text-gray-600 hover:text-gray-800` (matches ConfirmDialog cancel style)
- Save button: `bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg` with disabled state during saving
- Save label: "Create Template" or "Save Changes" based on mode; "Saving..." when saving

**State management:**
- Local state for name and options array (initialized from template prop if editing, empty for create)
- Local state for validation error string
- Clear error on any input change

**Key details:**
- Admin theme is LIGHT (bg-white, text-gray-900) — do NOT use dark theme colors
- Modal should close on overlay click (call onCancel)
- Focus the name input on mount using useEffect + ref
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Component renders modal with name input, sortable options list, add/remove buttons, and save/cancel actions. Drag-and-drop imports match existing dnd-kit usage.</verify>
  <done>TemplateEditor modal component supports create and edit modes with drag-and-drop option reordering, validation (min 2 options, no duplicates, no empties), and consistent admin light theme styling.</done>
</task>

<task type="auto">
  <name>Task 2: ResponseTemplatePanel with full CRUD and AdminSession integration</name>
  <files>src/components/ResponseTemplatePanel.tsx, src/pages/AdminSession.tsx</files>
  <action>
**Part A: Create `src/components/ResponseTemplatePanel.tsx`**

This replaces the old localStorage-based TemplatePanel with a Supabase-backed template manager.

**State:**
- `editingTemplate: ResponseTemplate | null` — which template is being edited (null = not editing)
- `creating: boolean` — whether the create editor is open
- `saving: boolean` — async save in progress
- `saveError: string | null` — error from create/update
- `deleteConfirm: { template: ResponseTemplate; usageCount: number } | null` — delete confirmation state
- `editConfirm: { template: ResponseTemplate; name: string; options: string[] } | null` — edit propagation confirmation state
- `deleting: boolean` — delete in progress

**On mount:** Call `fetchTemplates()` from template-api.ts. Read templates from `useTemplateStore`.

**Template list UI (light theme — matches existing TemplatePanel card style):**
- Section wrapper: `bg-white rounded-lg p-6 space-y-4`
- Title: "Response Templates" (text-lg font-semibold text-gray-900)
- Subtitle helper text: "Reusable sets of response options for multiple choice questions" (text-sm text-gray-500)
- Each template row: `flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2`
  - Left: template name (text-sm font-medium text-gray-800) + options preview comma-joined (text-xs text-gray-500, truncated)
  - Right: Edit button (text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded) + Delete button (text-red-600 bg-red-50 hover:bg-red-100 rounded) — matches existing TemplatePanel button style
- Empty state: "No response templates yet. Create one to use across sessions." (text-sm text-gray-400)
- "+ Create Template" button at bottom: `px-3 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-500 rounded-lg`

**Create flow:**
1. Click "+ Create Template" → open TemplateEditor in create mode
2. TemplateEditor calls onSave(name, options)
3. onSave calls `createTemplate(name, options)` from template-api.ts
4. On success, close editor. On error (e.g., name conflict), pass error to TemplateEditor.

**Edit flow:**
1. Click "Edit" on template → set editingTemplate
2. Open TemplateEditor in edit mode (pre-filled)
3. On save:
   a. Check if options changed (compare arrays)
   b. If options changed, call `checkTemplateVotes(template.id)` — if true, set saveError to "Cannot edit options: linked questions have received votes" and block save
   c. If options changed and no votes, call `getTemplateUsageCount(template.id)` — if count > 0, show editConfirm dialog: "{count} question(s) will be updated with the new options."
   d. On confirm (or if count === 0), call `updateTemplate(template.id, { name, options })`
4. On success, close editor. On error, pass error to TemplateEditor.

**Delete flow:**
1. Click "Delete" on template → call `getTemplateUsageCount(template.id)`
2. Show ConfirmDialog:
   - If usageCount > 0: "This template is used by {usageCount} question(s). Deleting will detach those questions from the template."
   - If usageCount === 0: "Delete this template? This cannot be undone."
   - confirmLabel="Delete", confirmVariant="danger"
3. On confirm: call `deleteTemplate(template.id)`, close dialog
4. Pass `loading={deleting}` to ConfirmDialog

**Loading state:**
- While `useTemplateStore.loading` is true, show "Loading templates..." (text-sm text-gray-400)

**Part B: Update `src/pages/AdminSession.tsx`**

1. Replace the import of `TemplatePanel` with `ResponseTemplatePanel`:
   - Change: `import { TemplatePanel } from '../components/TemplatePanel';`
   - To: `import { ResponseTemplatePanel } from '../components/ResponseTemplatePanel';`

2. Replace the usage in the draft view JSX:
   - Change: `<TemplatePanel sessionId={session.session_id} />`
   - To: `<ResponseTemplatePanel />`
   (ResponseTemplatePanel does NOT need sessionId — templates are global)

That's it for AdminSession. The old TemplatePanel remains in the codebase but is no longer imported. Do NOT delete it (it may still be useful for v1.1 backward compatibility or reference).
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero errors
2. ResponseTemplatePanel renders in AdminSession draft view where TemplatePanel used to be
3. Create flow: clicking "+ Create Template" opens TemplateEditor, saving calls createTemplate
4. Edit flow: clicking "Edit" opens TemplateEditor with template data, options edits check for votes and linked questions
5. Delete flow: clicking "Delete" shows ConfirmDialog with usage count, confirming calls deleteTemplate
6. Run `npm test` — all existing tests pass (TemplatePanel.test.tsx may need import path check but existing tests should not break since the old component file still exists)
  </verify>
  <done>ResponseTemplatePanel provides complete template CRUD UI with list view, modal editor (create/edit with DnD), delete confirmation with usage count, edit propagation guards (vote check + linked question count), and is integrated into AdminSession draft view replacing the old TemplatePanel.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm test` — all existing tests pass
3. ResponseTemplatePanel appears in AdminSession draft view
4. TemplateEditor supports create and edit modes with drag-and-drop
5. Delete shows ConfirmDialog with usage count warning
6. Edit checks for votes on linked questions before allowing option changes
7. Edit shows propagation confirmation when linked questions exist
8. Validation: min 2 options, no duplicates, no empties, unique name (23505 error caught)
9. All UI uses admin light theme (white backgrounds, gray text)
</verification>

<success_criteria>
- Full template CRUD workflow functional: list, create, edit (with DnD reorder), delete
- Safety guards: vote check blocks option edits, propagation confirmation for linked questions, delete shows usage count
- Consistent admin UI: light theme, matches existing patterns from QuestionForm, ConfirmDialog, TemplatePanel
- No regressions: existing tests pass, old TemplatePanel not broken (just unused import)
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-database-crud/11-02-SUMMARY.md`
</output>

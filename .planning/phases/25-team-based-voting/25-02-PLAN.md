---
phase: 25-team-based-voting
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/pages/AdminSession.tsx
  - src/pages/ParticipantSession.tsx
  - src/components/TeamPicker.tsx
  - src/components/TeamBadge.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can add and remove team names in session draft view"
    - "Team editor is disabled/hidden when session is active or ended"
    - "Participant scanning general QR sees team picker when teams are configured"
    - "Participant scanning team-specific QR is auto-assigned (no picker shown)"
    - "Participant sees team badge during voting"
    - "Participant team_id is stored on votes when cast"
    - "Participant cannot switch teams after casting first vote"
  artifacts:
    - path: "src/components/TeamPicker.tsx"
      provides: "Dropdown team selector with Join button"
      exports: ["TeamPicker"]
    - path: "src/components/TeamBadge.tsx"
      provides: "Small badge showing participant's team name"
      exports: ["TeamBadge"]
    - path: "src/pages/AdminSession.tsx"
      provides: "Team configuration UI in draft mode"
      contains: "updateSessionTeams"
    - path: "src/pages/ParticipantSession.tsx"
      provides: "Team picker integration and auto-assign from URL param"
      contains: "TeamPicker"
  key_links:
    - from: "src/pages/AdminSession.tsx"
      to: "src/lib/team-api.ts"
      via: "updateSessionTeams call on team list change"
      pattern: "updateSessionTeams"
    - from: "src/pages/ParticipantSession.tsx"
      to: "src/components/TeamPicker.tsx"
      via: "Renders TeamPicker when session has teams and no auto-assign"
      pattern: "TeamPicker"
    - from: "src/pages/ParticipantSession.tsx"
      to: "supabase votes table"
      via: "team_id included in vote upsert payload"
      pattern: "team_id"
---

<objective>
Wire up the team configuration and joining flow: admin can manage team names in draft mode (TEAM-01), participants can self-select or auto-join teams (TEAM-02, partial TEAM-03), and team_id is stored with votes.

Purpose: Enables the human workflow of configuring teams and having participants join them.
Output: Team config UI in admin, TeamPicker and TeamBadge components, team-aware participant session
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-team-based-voting/25-CONTEXT.md
@.planning/phases/25-team-based-voting/25-RESEARCH.md
@.planning/phases/25-team-based-voting/25-01-SUMMARY.md
@src/types/database.ts
@src/lib/team-api.ts
@src/pages/AdminSession.tsx
@src/pages/ParticipantSession.tsx
@src/components/VoteAgreeDisagree.tsx
@src/components/VoteMultipleChoice.tsx
@src/components/BatchVotingCarousel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin team configuration UI and participant team picker components</name>
  <files>
    src/pages/AdminSession.tsx
    src/components/TeamPicker.tsx
    src/components/TeamBadge.tsx
  </files>
  <action>
    **TeamPicker.tsx** — Create dropdown component for participant team selection:
    - Props: `teams: string[]`, `onJoinTeam: (teamName: string) => void`
    - State: `selectedTeam` (string, initially empty)
    - UI: Dark theme (bg-gray-900) to match participant dark UI. Centered card with:
      - "Select Your Team" heading
      - Native `<select>` with placeholder "Choose a team..." and team options
      - "Join Team" button, disabled when no selection
    - On Join: calls `onJoinTeam(selectedTeam)`

    **TeamBadge.tsx** — Create small badge showing participant's team:
    - Props: `teamName: string`
    - UI: Fixed position top-right (top-4 right-4), small pill with team name
    - Use: `bg-indigo-600/80 text-white px-3 py-1 rounded-full text-sm font-medium z-40`
    - Must not overlap with ConnectionPill (which is at top-left) or vote buttons

    **AdminSession.tsx** — Add team configuration section in draft mode:
    - Import `updateSessionTeams`, `validateTeamList` from `team-api.ts`
    - Add state: `teamNames: string[]` (initialized from session.teams on load), `teamInput: string`, `teamError: string | null`
    - In the draft view section (where isDraft is true), add a "Teams" configuration card:
      - Text input + "Add Team" button to add a team name
      - List of current team names with "X" remove buttons
      - Show validation error below if present (e.g., duplicate name, max reached)
      - On add: validate with `validateTeamList`, if valid call `updateSessionTeams` and update local state
      - On remove: filter out team, call `updateSessionTeams`
      - Show count: "N of 5 teams" indicator
    - When session status is NOT 'draft', hide the team editor entirely (teams are locked after Go Live per user decision)
    - Populate `teamNames` from `session.teams` when session loads (teams column fetched from Supabase)
    - Ensure the session fetch in AdminSession includes the `teams` column (it uses `select('*')` so this should be automatic)
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    AdminSession renders team config section in draft mode.
    TeamPicker and TeamBadge components compile and export correctly.
  </verify>
  <done>
    Admin can add/remove team names via text input in draft mode.
    Team config section is hidden when session is active/ended.
    TeamPicker shows dropdown with Join button.
    TeamBadge renders team name pill in top-right.
  </done>
</task>

<task type="auto">
  <name>Task 2: Participant team joining flow with auto-assign and vote integration</name>
  <files>
    src/pages/ParticipantSession.tsx
  </files>
  <action>
    **Participant team state management:**
    - Add state: `participantTeam: string | null` (the team this participant is on), `teamLocked: boolean` (true once first vote is cast)
    - Read URL query param on mount: `const searchParams = new URLSearchParams(window.location.search); const autoAssignTeam = searchParams.get('team');`
    - Fetch session teams when session loads: read `session.teams` (available from the session data already fetched — Session type now includes `teams: string[]`)
    - If `autoAssignTeam` is non-null AND it exists in `session.teams`, auto-assign: set `participantTeam = autoAssignTeam` and skip the team picker. Show brief toast-like text ("Joined [team]") that fades after 2s.
    - If session has teams configured (`session.teams.length > 0`) AND no auto-assign AND `participantTeam` is null, show TeamPicker BEFORE the lobby/voting view. The team picker is a gate — participant must select a team before proceeding to lobby/voting.

    **Team picker gate logic:**
    - New view state or conditional: when `session.teams.length > 0 && !participantTeam && !autoAssignTeam`, render `<TeamPicker teams={session.teams} onJoinTeam={handleJoinTeam} />` instead of the current view.
    - `handleJoinTeam(teamName)`: set `participantTeam = teamName`, then proceed to the normal view derivation.
    - Store `participantTeam` in `sessionStorage` (key: `quickvote-team-${sessionId}`) so it persists across page refreshes within the same browser tab session.
    - On mount, check sessionStorage for existing team assignment before showing picker.

    **Team locking on first vote:**
    - Check if participant has any existing votes for this session (query votes table where `session_id = sessionId AND participant_id = participantId` with limit 1).
    - If votes exist, set `teamLocked = true` and read team_id from that vote to restore `participantTeam`.
    - When teamLocked is true, team picker is never shown (even if sessionStorage is cleared).

    **Team badge display:**
    - When `participantTeam` is set, render `<TeamBadge teamName={participantTeam} />` in all voting views (lobby, waiting, voting, batch-voting).
    - Place it as a fixed-position element so it's always visible but doesn't interfere with voting UI.

    **Vote submission with team_id:**
    - The vote upsert happens in VoteAgreeDisagree and VoteMultipleChoice components (and BatchVotingCarousel).
    - These components need a new optional prop: `teamId: string | null`.
    - Pass `participantTeam` as `teamId` prop to all vote components.
    - In each vote component's upsert call, include `team_id: teamId` in the payload.
    - NOTE: The vote components are in separate files. Since this task focuses on ParticipantSession, add the `teamId` prop threading here and update the vote component upsert calls to include team_id. This requires small modifications to VoteAgreeDisagree.tsx, VoteMultipleChoice.tsx, and BatchVotingCarousel.tsx to accept and pass through the teamId prop.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    ParticipantSession handles: auto-assign from URL param, team picker gate, team badge display, team_id in vote payloads.
  </verify>
  <done>
    Participant scanning general QR (no ?team param) sees team picker when session has teams.
    Participant scanning team-specific QR (?team=TeamA) is auto-assigned.
    Team badge visible during all voting views.
    Vote upserts include team_id field.
    Team is locked after first vote (no switching).
    Team persists in sessionStorage across refresh.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Admin draft view shows team configuration card with add/remove
3. Team editor hidden in active/ended sessions
4. TeamPicker renders with dropdown and Join button
5. TeamBadge renders small pill in top-right
6. Vote payloads include team_id when participant has a team
</verification>

<success_criteria>
- TEAM-01: Admin can configure team names in session draft view (add/remove, max 5, validated)
- TEAM-02: Participants can self-select team from dropdown OR be auto-assigned via URL param
- TEAM-02: Team badge visible during voting, team locked after first vote
- Vote submission includes team_id for downstream filtering
</success_criteria>

<output>
After completion, create `.planning/phases/25-team-based-voting/25-02-SUMMARY.md`
</output>

---
phase: 25-team-based-voting
plan: 03
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/lib/vote-aggregation.ts
  - src/components/TeamFilterTabs.tsx
  - src/components/PresentationControls.tsx
  - src/pages/PresentationView.tsx
  - src/components/BatchResultsProjection.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees horizontal tab bar (All | Team A | Team B...) in active session"
    - "Selecting a team tab filters displayed results to that team's votes only"
    - "Vote counts, percentages, and participation stats are scoped to selected team"
    - "Projection view mirrors admin's team filter selection in real time"
    - "Team filter resets to All on page reload"
  artifacts:
    - path: "src/components/TeamFilterTabs.tsx"
      provides: "Horizontal tab bar component for team filtering"
      exports: ["TeamFilterTabs"]
    - path: "src/lib/vote-aggregation.ts"
      provides: "Team-filtered vote aggregation"
      exports: ["aggregateVotes"]
    - path: "src/components/PresentationControls.tsx"
      provides: "Team filter tabs in admin's active session view"
      contains: "TeamFilterTabs"
    - path: "src/pages/PresentationView.tsx"
      provides: "Team filter tabs on projection, synced via broadcast"
      contains: "team_filter_changed"
  key_links:
    - from: "src/components/PresentationControls.tsx"
      to: "src/pages/PresentationView.tsx"
      via: "broadcast event team_filter_changed"
      pattern: "team_filter_changed"
    - from: "src/components/TeamFilterTabs.tsx"
      to: "src/lib/vote-aggregation.ts"
      via: "selected team passed as filter to aggregateVotes"
      pattern: "aggregateVotes.*team"
---

<objective>
Add team-based results filtering: a TeamFilterTabs component, enhanced vote aggregation with optional team parameter, and broadcast sync between admin and projection views.

Purpose: Enables TEAM-04 — admin can toggle results between all participants and specific teams, with projection mirroring the selection.
Output: TeamFilterTabs component, enhanced aggregateVotes, wired into PresentationControls and PresentationView
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-team-based-voting/25-CONTEXT.md
@.planning/phases/25-team-based-voting/25-RESEARCH.md
@.planning/phases/25-team-based-voting/25-01-SUMMARY.md
@src/lib/vote-aggregation.ts
@src/components/PresentationControls.tsx
@src/pages/PresentationView.tsx
@src/components/BatchResultsProjection.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team filter tabs component and enhanced vote aggregation</name>
  <files>
    src/components/TeamFilterTabs.tsx
    src/lib/vote-aggregation.ts
  </files>
  <action>
    **TeamFilterTabs.tsx** — Create horizontal tab bar component:
    - Props: `teams: string[]`, `selectedTeam: string | null`, `onTeamChange: (team: string | null) => void`
    - UI: Horizontal scrollable row of buttons. "All" tab always first, then one tab per team name.
    - Light theme styling (admin context): `border-b border-gray-200` container. Active tab: `border-b-2 border-blue-500 text-blue-600 font-medium`. Inactive: `text-gray-500 hover:text-gray-700`.
    - `selectedTeam === null` means "All" is active. Clicking "All" calls `onTeamChange(null)`.
    - Clicking a team calls `onTeamChange(teamName)`.
    - If `teams.length === 0`, return null (don't render).
    - Also export a dark-themed variant or accept a `theme: 'light' | 'dark'` prop for projection use. Dark variant: active tab `border-b-2 border-blue-400 text-blue-300`, inactive `text-gray-400 hover:text-gray-200`.

    **vote-aggregation.ts** — Enhance `aggregateVotes` with optional team filter:
    - Change signature: `aggregateVotes(votes: Vote[], teamFilter?: string | null): VoteCount[]`
    - Add filtering logic at the top: `const filteredVotes = teamFilter ? votes.filter(v => v.team_id === teamFilter) : votes;`
    - Use `filteredVotes` instead of `votes` for the rest of the function (total, counts).
    - This is backward-compatible — existing callers pass no second arg and get unfiltered results.
    - `buildConsistentBarData` does NOT need changes (it operates on already-aggregated VoteCount[]).

    Also add a helper for team-scoped participant count:
    ```typescript
    export function getTeamParticipantCount(votes: Vote[], teamFilter?: string | null): number {
      const filteredVotes = teamFilter ? votes.filter(v => v.team_id === teamFilter) : votes;
      return new Set(filteredVotes.map(v => v.participant_id)).size;
    }
    ```
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    aggregateVotes with teamFilter only counts votes matching that team.
    TeamFilterTabs renders All + team tabs with correct active state.
  </verify>
  <done>
    TeamFilterTabs renders horizontal tab bar with All and per-team buttons.
    aggregateVotes accepts optional teamFilter parameter, filters votes before counting.
    getTeamParticipantCount helper exported for team-scoped participant stats.
    Backward-compatible — existing callers unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire team filter into PresentationControls and PresentationView with broadcast sync</name>
  <files>
    src/components/PresentationControls.tsx
    src/pages/PresentationView.tsx
    src/components/BatchResultsProjection.tsx
  </files>
  <action>
    **PresentationControls.tsx** — Add team filter state and broadcast:
    - Add state: `selectedTeam: string | null` (default null = "All")
    - Read session teams from store: `const session = useSessionStore(s => s.session)` — access `session.teams`
    - Render `<TeamFilterTabs>` above the content area (below the top toolbar, above the slide/results content). Only render if `session.teams.length > 0`.
    - On team change: update `selectedTeam` state AND broadcast to projection:
      ```typescript
      channelRef.current?.send({
        type: 'broadcast',
        event: 'team_filter_changed',
        payload: { teamId: newTeam },
      });
      ```
    - Pass `selectedTeam` to all `aggregateVotes` calls as the second argument (team filter).
    - Pass `selectedTeam` to `BatchResultsProjection` as a new `teamFilter` prop.
    - When showing participant count in the results area, use `getTeamParticipantCount(allVotes, selectedTeam)` instead of raw count when a team filter is active.

    **PresentationView.tsx** — Listen for team filter broadcast and apply:
    - Add state: `selectedTeam: string | null` (default null)
    - In the channel setup callback, add listener:
      ```typescript
      channel.on('broadcast', { event: 'team_filter_changed' }, ({ payload }) => {
        setSelectedTeam(payload.teamId);
      });
      ```
    - Read session teams for rendering TeamFilterTabs (visual indicator of active filter on projection).
    - Render `<TeamFilterTabs>` (dark theme) on the projection view when teams are configured. This is a passive display — clicking tabs on the projection is a no-op or not rendered. Use a read-only visual indicator showing which team is selected.
    - Pass `selectedTeam` to all `aggregateVotes` calls and `BatchResultsProjection`.

    **BatchResultsProjection.tsx** — Accept and apply team filter:
    - Add optional prop: `teamFilter?: string | null`
    - Pass `teamFilter` to `aggregateVotes(questionVotes, teamFilter)` calls.
    - When `teamFilter` is set, show a small "Showing: [TeamName]" label near the batch name for clarity.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    PresentationControls renders team filter tabs when session has teams.
    Changing tab broadcasts `team_filter_changed` event.
    PresentationView listens for broadcast and updates its filter.
    Results display reflects filtered vote counts.
  </verify>
  <done>
    Admin sees team filter tabs in PresentationControls when teams configured.
    Selecting a team filters all displayed results (bar charts, percentages, counts).
    Projection view receives team_filter_changed broadcast and mirrors the filter.
    BatchResultsProjection applies team filter to vote aggregation.
    Team filter resets to "All" on reload (no persistence).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. TeamFilterTabs renders correctly with All + team buttons
3. aggregateVotes filters by team when parameter provided
4. Admin tab change triggers broadcast event
5. PresentationView receives broadcast and updates display
6. Results show team-scoped data when filter is active
</verification>

<success_criteria>
- TEAM-04: Admin can toggle results view between all participants and specific teams
- Projection follows admin's filter selection via broadcast sync
- Vote counts, percentages, and participation stats all scoped to selected team
- Filter resets to "All" on page reload (no URL persistence needed)
</success_criteria>

<output>
After completion, create `.planning/phases/25-team-based-voting/25-03-SUMMARY.md`
</output>

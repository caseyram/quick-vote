---
phase: 25-team-based-voting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260215_080_add_teams.sql
  - src/types/database.ts
  - src/lib/team-api.ts
autonomous: true

must_haves:
  truths:
    - "Sessions table has a teams JSONB column defaulting to empty array"
    - "Votes table has a team_id TEXT column (nullable)"
    - "Vote and Session TypeScript types include team fields"
    - "Team validation enforces max 5 unique non-empty names"
    - "Team CRUD operations update sessions.teams in Supabase"
  artifacts:
    - path: "supabase/migrations/20260215_080_add_teams.sql"
      provides: "Database schema for teams column and team_id column"
      contains: "ALTER TABLE sessions ADD COLUMN teams"
    - path: "src/types/database.ts"
      provides: "Updated Session and Vote types with team fields"
      contains: "team_id"
    - path: "src/lib/team-api.ts"
      provides: "Team CRUD and validation functions"
      exports: ["updateSessionTeams", "validateTeamList"]
  key_links:
    - from: "src/lib/team-api.ts"
      to: "supabase sessions table"
      via: "supabase.from('sessions').update({ teams })"
      pattern: "supabase.*sessions.*update.*teams"
    - from: "src/types/database.ts"
      to: "supabase/migrations/20260215_080_add_teams.sql"
      via: "TypeScript types mirror database schema"
      pattern: "teams.*string\\[\\]|team_id.*string"
---

<objective>
Create the database foundation for team-based voting: migration adding teams column to sessions and team_id to votes, updated TypeScript types, and a team API module with CRUD operations and Zod validation.

Purpose: All subsequent plans (admin config UI, participant join flow, filter tabs, QR grid, export) depend on these schema changes and API functions.
Output: Migration file, updated types, team-api.ts module
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-team-based-voting/25-CONTEXT.md
@.planning/phases/25-team-based-voting/25-RESEARCH.md
@src/types/database.ts
@src/lib/supabase.ts
@supabase/migrations/20260213_070_batch_cover_images.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript type updates</name>
  <files>
    supabase/migrations/20260215_080_add_teams.sql
    src/types/database.ts
  </files>
  <action>
    Create migration `supabase/migrations/20260215_080_add_teams.sql`:
    1. Add `teams JSONB DEFAULT '[]'::jsonb` column to sessions table
    2. Add constraint `max_5_teams CHECK (jsonb_array_length(teams) <= 5)` on sessions
    3. Add `team_id TEXT` column to votes table (nullable — participants without teams have NULL)
    4. Create index `idx_votes_team_id ON votes(team_id)` for efficient filtering
    5. Create composite index `idx_votes_session_team ON votes(session_id, team_id)` for session+team queries
    6. Add COMMENT on both new columns for documentation

    Update `src/types/database.ts`:
    1. Add `teams: string[];` to the Session interface (after `default_template_id`)
    2. Add `team_id: string | null;` to the Vote interface (after `display_name`)

    No RLS changes needed — team_id is a filter column, not an access control column. Existing policies allow reading votes.
  </action>
  <verify>
    Run `npx supabase db diff` or manually review that the migration SQL is syntactically valid.
    Run `npx tsc --noEmit` to verify TypeScript types compile without errors.
  </verify>
  <done>
    Migration file exists with teams column on sessions (JSONB, default '[]', max 5 constraint) and team_id on votes (TEXT, nullable, indexed).
    Session type has `teams: string[]` field.
    Vote type has `team_id: string | null` field.
    TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Team API module with CRUD and validation</name>
  <files>src/lib/team-api.ts</files>
  <action>
    Create `src/lib/team-api.ts` with:

    1. **Zod schema for team list validation:**
       ```typescript
       const TeamListSchema = z.array(z.string().trim().min(1, 'Team name cannot be empty').max(50, 'Team name too long'))
         .max(5, 'Maximum 5 teams allowed')
         .refine(
           (teams) => new Set(teams.map(t => t.toLowerCase())).size === teams.length,
           { message: 'Team names must be unique (case-insensitive)' }
         );
       ```

    2. **`validateTeamList(teams: string[])`** — Returns `{ valid: boolean; error?: string }`. Parses against TeamListSchema.

    3. **`updateSessionTeams(sessionId: string, teams: string[])`** — Validates with TeamListSchema, then updates sessions table:
       ```typescript
       const { error } = await supabase
         .from('sessions')
         .update({ teams })
         .eq('session_id', sessionId);
       ```
       Returns `{ success: boolean; error?: string }`.

    4. **`fetchSessionTeams(sessionId: string)`** — Fetches `teams` column from sessions table. Returns `string[]` (empty array if no teams configured).

    Import supabase from `../lib/supabase` and z from `zod`. Export all functions and the schema.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify the module compiles.
    Check that imports resolve correctly.
  </verify>
  <done>
    team-api.ts exports validateTeamList, updateSessionTeams, fetchSessionTeams.
    Validation enforces: non-empty names, max 50 chars, max 5 teams, unique names (case-insensitive).
    Update function calls supabase to persist teams on sessions table.
    All TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Migration file exists at expected path with correct SQL
3. Session and Vote types include new fields
4. team-api.ts exports all required functions
</verification>

<success_criteria>
- Database migration ready for deployment with teams + team_id columns
- TypeScript types updated to reflect new schema
- Team API module provides validated CRUD operations
- All existing code continues to compile (no breaking changes)
</success_criteria>

<output>
After completion, create `.planning/phases/25-team-based-voting/25-01-SUMMARY.md`
</output>

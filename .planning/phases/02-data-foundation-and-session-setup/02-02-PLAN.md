---
phase: 02-data-foundation-and-session-setup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/App.tsx
  - src/App.css
  - src/stores/session-store.ts
  - src/pages/Home.tsx
  - src/pages/AdminSession.tsx
  - src/pages/ParticipantSession.tsx
autonomous: true

must_haves:
  truths:
    - "Admin visits / and sees a Create Session button"
    - "Clicking Create Session inserts a row in Supabase sessions table and redirects to /admin/:adminToken"
    - "Admin page at /admin/:adminToken loads the session data by admin_token"
    - "Participant URL /session/:sessionId exists and does NOT expose admin_token"
    - "Navigating to a non-existent admin_token shows a 'session not found' message"
    - "Page refresh preserves auth session and reloads session data from Supabase"
  artifacts:
    - path: "src/App.tsx"
      provides: "React Router v7 setup with BrowserRouter, route definitions, auth gating"
      contains: "BrowserRouter"
    - path: "src/stores/session-store.ts"
      provides: "Zustand v5 store for session and questions state"
      exports: ["useSessionStore"]
    - path: "src/pages/Home.tsx"
      provides: "Landing page with Create Session button and session creation logic"
      contains: "createSession"
    - path: "src/pages/AdminSession.tsx"
      provides: "Admin session page that loads by admin_token, shows session title and question list area"
      contains: "adminToken"
    - path: "src/pages/ParticipantSession.tsx"
      provides: "Participant placeholder page that loads by session_id without admin_token"
      contains: "sessionId"
  key_links:
    - from: "src/pages/Home.tsx"
      to: "supabase sessions table"
      via: "supabase.from('sessions').insert() on Create Session click"
      pattern: "supabase.*from.*sessions.*insert"
    - from: "src/pages/Home.tsx"
      to: "src/App.tsx"
      via: "useNavigate() redirect to /admin/:adminToken after creation"
      pattern: "navigate.*admin"
    - from: "src/pages/AdminSession.tsx"
      to: "supabase sessions table"
      via: "supabase.from('sessions').select().eq('admin_token', adminToken) on mount"
      pattern: "eq.*admin_token"
    - from: "src/pages/AdminSession.tsx"
      to: "src/stores/session-store.ts"
      via: "useSessionStore for session/questions state"
      pattern: "useSessionStore"
    - from: "src/App.tsx"
      to: "src/hooks/use-auth.ts"
      via: "useAuth() gates rendering until auth is ready"
      pattern: "useAuth"
---

<objective>
Build the session creation flow end-to-end: React Router v7 routing, Zustand session store, Home page with "Create Session" CTA, AdminSession page that loads session by admin_token, and ParticipantSession placeholder. After this plan, an admin can create a session and land on its admin page.

Purpose: This is the core session lifecycle -- create, navigate, load. Without this, there is no session to add questions to (Plan 03).

Output: Working session creation flow from landing page to admin session page, with client-side routing and Zustand state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-foundation-and-session-setup/02-RESEARCH.md
@.planning/phases/02-data-foundation-and-session-setup/02-01-SUMMARY.md
@src/lib/supabase.ts
@src/types/database.ts
@src/hooks/use-auth.ts
@src/App.tsx
@src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand store and React Router setup</name>
  <files>
    src/stores/session-store.ts
    src/App.tsx
    src/App.css
  </files>
  <action>
    1. Create `src/stores/session-store.ts` with a Zustand v5 store:

       ```typescript
       import { create } from 'zustand';
       import type { Session, Question } from '../types/database';

       interface SessionState {
         session: Session | null;
         questions: Question[];
         loading: boolean;
         error: string | null;

         setSession: (session: Session | null) => void;
         setQuestions: (questions: Question[]) => void;
         addQuestion: (question: Question) => void;
         updateQuestion: (id: string, updates: Partial<Question>) => void;
         removeQuestion: (id: string) => void;
         reorderQuestions: (orderedIds: string[]) => void;
         setLoading: (loading: boolean) => void;
         setError: (error: string | null) => void;
         reset: () => void;
       }

       export const useSessionStore = create<SessionState>()((set) => ({
         session: null,
         questions: [],
         loading: false,
         error: null,

         setSession: (session) => set({ session }),
         setQuestions: (questions) =>
           set({ questions: [...questions].sort((a, b) => a.position - b.position) }),
         addQuestion: (question) =>
           set((state) => ({
             questions: [...state.questions, question].sort((a, b) => a.position - b.position),
           })),
         updateQuestion: (id, updates) =>
           set((state) => ({
             questions: state.questions.map((q) =>
               q.id === id ? { ...q, ...updates } : q
             ),
           })),
         removeQuestion: (id) =>
           set((state) => ({
             questions: state.questions.filter((q) => q.id !== id),
           })),
         reorderQuestions: (orderedIds) =>
           set((state) => ({
             questions: orderedIds
               .map((id, index) => {
                 const q = state.questions.find((q) => q.id === id);
                 return q ? { ...q, position: index } : null;
               })
               .filter((q): q is Question => q !== null),
           })),
         setLoading: (loading) => set({ loading }),
         setError: (error) => set({ error }),
         reset: () => set({ session: null, questions: [], loading: false, error: null }),
       }));
       ```

       CRITICAL: Use `create<SessionState>()((set) => ...)` with double parentheses (Zustand v5 TypeScript pattern).
       Include a `reset()` method to clear state when navigating away from a session.

    2. Rewrite `src/App.tsx` to set up React Router v7 with auth gating:

       ```typescript
       import { BrowserRouter, Routes, Route } from 'react-router';
       import { useAuth } from './hooks/use-auth';
       import Home from './pages/Home';
       import AdminSession from './pages/AdminSession';
       import ParticipantSession from './pages/ParticipantSession';

       function App() {
         const { ready } = useAuth();

         if (!ready) {
           return (
             <div className="min-h-screen bg-gray-950 flex items-center justify-center">
               <p className="text-gray-400 text-lg">Loading...</p>
             </div>
           );
         }

         return (
           <BrowserRouter>
             <Routes>
               <Route path="/" element={<Home />} />
               <Route path="/admin/:adminToken" element={<AdminSession />} />
               <Route path="/session/:sessionId" element={<ParticipantSession />} />
             </Routes>
           </BrowserRouter>
         );
       }

       export default App;
       ```

       CRITICAL: Import from `'react-router'` NOT `'react-router-dom'` (React Router v7).
       The `useAuth()` hook gates ALL rendering -- nothing renders until anonymous auth is ready.
       Keep the dark theme (bg-gray-950) consistent with Demo.tsx.

    3. Delete or empty `src/App.css` -- it's no longer needed (Tailwind handles all styling via index.css). If it has content, replace with an empty file or a comment.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (pages don't exist yet so this will fail -- verify after Task 2)
    - `src/stores/session-store.ts` exports `useSessionStore`
    - `src/App.tsx` imports from `'react-router'` (not `'react-router-dom'`)
    - `src/App.tsx` uses `useAuth()` to gate rendering
    - Three routes defined: `/`, `/admin/:adminToken`, `/session/:sessionId`
  </verify>
  <done>
    Zustand store created with full session/question state management. App.tsx rewired with React Router v7 declarative routing and anonymous auth gating. Three routes defined matching the frozen URL structure from research.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Home page with session creation and AdminSession/ParticipantSession pages</name>
  <files>
    src/pages/Home.tsx
    src/pages/AdminSession.tsx
    src/pages/ParticipantSession.tsx
  </files>
  <action>
    1. Create `src/pages/Home.tsx` -- Landing page with "Create Session" button:

       - Display the app name "QuickVote" as a heading
       - A text input for session title (optional, defaults to "Untitled Session")
       - A "Create Session" button
       - On click:
         a. Disable button, show loading state ("Creating..." text)
         b. Generate a nanoid: `import { nanoid } from 'nanoid'; const sessionId = nanoid();`
         c. Get current user: `const { data: { user } } = await supabase.auth.getUser();`
         d. Insert into sessions: `supabase.from('sessions').insert({ session_id: sessionId, title: title || 'Untitled Session', created_by: user?.id }).select('admin_token').single()`
         e. On success, redirect to `/admin/${data.admin_token}` using `useNavigate()` from `'react-router'`
         f. On error, show error message, re-enable button
       - Use a ref or state flag to prevent double-submission (pitfall 6 from research)
       - Style: dark theme (bg-gray-950), centered content, consistent with existing Demo.tsx aesthetic

    2. Create `src/pages/AdminSession.tsx` -- Admin session management page:

       - Get `adminToken` from URL: `const { adminToken } = useParams();` (from `'react-router'`)
       - On mount, load session: `supabase.from('sessions').select('*').eq('admin_token', adminToken).single()`
       - Also load questions: `supabase.from('questions').select('*').eq('session_id', session.session_id).order('position', { ascending: true })`
       - Store session and questions in Zustand: `useSessionStore`
       - Display states:
         a. Loading: "Loading session..." centered text
         b. Not found: "Session not found" message (invalid admin token)
         c. Loaded: Show session title, session status badge, participant link (copyable), and a placeholder area for questions ("Questions will appear here" or empty state)
       - Show the participant URL: `${window.location.origin}/session/${session.session_id}` with a "Copy Link" button that copies to clipboard
       - Do NOT show admin_token anywhere in the UI except the browser address bar
       - The question list area will be populated in Plan 03 -- for now show "No questions yet. Add your first question below." placeholder text
       - Style: dark theme, max-w-2xl centered layout

    3. Create `src/pages/ParticipantSession.tsx` -- Placeholder participant page:

       - Get `sessionId` from URL: `const { sessionId } = useParams();`
       - On mount, load session by session_id: `supabase.from('sessions').select('id, session_id, title, status, created_at').eq('session_id', sessionId).single()`
       - CRITICAL: Use explicit column list WITHOUT admin_token (security requirement)
       - Display states:
         a. Loading: "Loading session..."
         b. Not found: "Session not found"
         c. Loaded: Show session title and "Waiting for session to start..." placeholder
       - This is a placeholder -- full participant experience comes in Phase 3
       - Style: dark theme, centered

    IMPORTANT ANTI-PATTERNS TO AVOID:
    - Do NOT use `select('*')` in ParticipantSession -- always use explicit columns to exclude admin_token
    - Do NOT import `react-router-dom` -- use `react-router`
    - Do NOT forget to handle the case where adminToken/sessionId params are undefined
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - `npm run dev` starts, navigate to `/` -- see QuickVote heading and Create Session button
    - Click "Create Session" -- should redirect to `/admin/:someUUID`
    - Admin page shows session title, participant link, and empty questions area
    - Copy participant link, open in new tab -- shows session title and "Waiting for session to start"
    - Check Supabase Dashboard > Table Editor > sessions -- new row exists with session_id and admin_token
    - Navigate to `/admin/invalid-token` -- shows "Session not found"
  </verify>
  <done>
    Home page creates sessions and redirects to admin URL. AdminSession page loads session by admin_token and displays session info with participant link. ParticipantSession loads by session_id without exposing admin_token. The full session creation lifecycle works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Navigate to `/` -- see "QuickVote" heading and "Create Session" button
3. Enter a title and click "Create Session" -- redirected to `/admin/:adminToken` URL
4. Admin page shows: session title, status badge, copyable participant link, empty questions area
5. Open participant link in new tab -- shows session title, no admin_token visible anywhere
6. Supabase Dashboard > sessions table -- row exists with correct session_id, admin_token, title, created_by
7. Refresh admin page -- session data reloads from Supabase (persistence works)
8. Navigate to `/admin/00000000-0000-0000-0000-000000000000` -- shows "Session not found"
9. Navigate to `/session/nonexistent` -- shows "Session not found"
</verification>

<success_criteria>
- Session creation flow works: click button -> insert row -> redirect to admin URL
- Admin page loads session by admin_token and displays session info
- Participant page loads session by session_id WITHOUT admin_token
- Invalid tokens/IDs show "not found" state
- Data persists across page refresh
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-foundation-and-session-setup/02-02-SUMMARY.md`
</output>

---
phase: 02-data-foundation-and-session-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
  - src/types/database.ts
  - src/hooks/use-auth.ts
autonomous: false
user_setup:
  - service: supabase
    why: "Anonymous auth must be enabled in Dashboard (cannot be done via CLI/API)"
    dashboard_config:
      - task: "Enable Anonymous Sign-Ins"
        location: "Supabase Dashboard > Project Settings > Authentication > User Signups > Anonymous Sign-Ins > Enable"
  - service: supabase
    why: "Database schema must be created via SQL Editor (no Supabase CLI configured)"
    dashboard_config:
      - task: "Run schema SQL to create sessions, questions, votes tables with RLS policies"
        location: "Supabase Dashboard > SQL Editor > New Query"

must_haves:
  truths:
    - "Anonymous auth initializes on app load, giving every client a JWT with auth.uid()"
    - "sessions and questions tables exist in Supabase with correct columns and constraints"
    - "RLS policies enforce that only authenticated users can CRUD, and only creators can modify their sessions/questions"
    - "TypeScript types exist for Session, Question, VoteType, and SessionStatus"
  artifacts:
    - path: "src/types/database.ts"
      provides: "TypeScript interfaces for Session, Question, VoteType, SessionStatus"
      exports: ["Session", "Question", "VoteType", "SessionStatus", "QuestionStatus"]
    - path: "src/hooks/use-auth.ts"
      provides: "Anonymous auth initialization hook"
      exports: ["useAuth"]
    - path: "src/lib/supabase.ts"
      provides: "Typed Supabase client (updated)"
  key_links:
    - from: "src/hooks/use-auth.ts"
      to: "src/lib/supabase.ts"
      via: "imports supabase client for signInAnonymously()"
      pattern: "supabase\\.auth\\.signInAnonymously"
    - from: "src/hooks/use-auth.ts"
      to: "supabase auth system"
      via: "getSession() check before signInAnonymously()"
      pattern: "supabase\\.auth\\.getSession"
---

<objective>
Install Phase 2 dependencies, create the database schema (sessions, questions, votes tables with RLS policies and indexes), define TypeScript types for the data layer, and build the anonymous auth initialization hook.

Purpose: Establishes the complete data foundation that all subsequent Phase 2 plans build upon -- without tables, types, and auth, no session creation or question CRUD is possible.

Output: Database tables live in Supabase, TypeScript types in `src/types/database.ts`, auth hook in `src/hooks/use-auth.ts`, typed Supabase client in `src/lib/supabase.ts`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-foundation-and-session-setup/02-RESEARCH.md
@src/lib/supabase.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create TypeScript types</name>
  <files>
    package.json
    src/types/database.ts
  </files>
  <action>
    1. Install Phase 2 dependencies:
       ```bash
       npm install react-router zustand nanoid
       ```

    2. Create `src/types/database.ts` with these exact type definitions:

       ```typescript
       export type VoteType = 'agree_disagree' | 'multiple_choice';
       export type SessionStatus = 'draft' | 'lobby' | 'active' | 'ended';
       export type QuestionStatus = 'pending' | 'active' | 'closed' | 'revealed';

       export interface Session {
         id: string;
         session_id: string;
         admin_token: string;
         title: string;
         status: SessionStatus;
         created_by: string;
         created_at: string;
       }

       export interface Question {
         id: string;
         session_id: string;
         text: string;
         type: VoteType;
         options: string[] | null;
         position: number;
         anonymous: boolean;
         status: QuestionStatus;
         created_at: string;
       }

       export interface Vote {
         id: string;
         question_id: string;
         session_id: string;
         participant_id: string;
         value: string;
         display_name: string | null;
         locked_in: boolean;
         created_at: string;
         updated_at: string;
       }
       ```

    Note: Do NOT use Supabase generated types. Manually define types matching the schema from RESEARCH.md. The Vote type is defined now for completeness even though voting is Phase 3.
  </action>
  <verify>
    - `npm ls react-router zustand nanoid` shows all three installed
    - `npx tsc --noEmit` passes (no type errors)
    - `src/types/database.ts` exports Session, Question, Vote, VoteType, SessionStatus, QuestionStatus
  </verify>
  <done>
    react-router, zustand, and nanoid are installed. TypeScript type definitions exist for all database tables and are importable without errors.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Create database schema and enable anonymous auth in Supabase Dashboard</name>
  <action>
    The user must execute two actions in the Supabase Dashboard that cannot be automated:

    **Action A: Enable Anonymous Sign-Ins**
    1. Go to Supabase Dashboard > Project Settings (gear icon) > Authentication
    2. Scroll to "User Signups" section
    3. Toggle ON "Allow anonymous sign-ins"
    4. Click Save

    **Action B: Create database schema**
    1. Go to Supabase Dashboard > SQL Editor > New Query
    2. Paste and run the following SQL (provide this exact SQL to the user):

    ```sql
    -- ============================================
    -- QuickVote Phase 2: Database Schema
    -- ============================================

    -- Sessions table
    CREATE TABLE sessions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      session_id TEXT UNIQUE NOT NULL,
      admin_token UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),
      title TEXT NOT NULL DEFAULT 'Untitled Session',
      status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'lobby', 'active', 'ended')),
      created_by UUID REFERENCES auth.users(id),
      created_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    CREATE INDEX idx_sessions_session_id ON sessions(session_id);
    CREATE INDEX idx_sessions_admin_token ON sessions(admin_token);

    -- Questions table
    CREATE TABLE questions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      session_id TEXT NOT NULL REFERENCES sessions(session_id) ON DELETE CASCADE,
      text TEXT NOT NULL,
      type TEXT NOT NULL CHECK (type IN ('agree_disagree', 'multiple_choice')),
      options JSONB,
      position INTEGER NOT NULL DEFAULT 0,
      anonymous BOOLEAN NOT NULL DEFAULT true,
      status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'closed', 'revealed')),
      created_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    CREATE INDEX idx_questions_session_id ON questions(session_id);

    -- Votes table (schema only -- used in Phase 3)
    CREATE TABLE votes (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      question_id UUID NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
      session_id TEXT NOT NULL REFERENCES sessions(session_id) ON DELETE CASCADE,
      participant_id UUID NOT NULL,
      value TEXT NOT NULL,
      display_name TEXT,
      locked_in BOOLEAN NOT NULL DEFAULT false,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      UNIQUE(question_id, participant_id)
    );

    CREATE INDEX idx_votes_session_id ON votes(session_id);
    CREATE INDEX idx_votes_question_id ON votes(question_id);

    -- ============================================
    -- RLS Policies
    -- ============================================

    -- Sessions RLS
    ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Authenticated users can create sessions"
      ON sessions FOR INSERT TO authenticated
      WITH CHECK (true);

    CREATE POLICY "Anyone can read sessions"
      ON sessions FOR SELECT TO authenticated
      USING (true);

    CREATE POLICY "Creator can update own sessions"
      ON sessions FOR UPDATE TO authenticated
      USING ((select auth.uid()) = created_by);

    CREATE POLICY "Creator can delete own sessions"
      ON sessions FOR DELETE TO authenticated
      USING ((select auth.uid()) = created_by);

    -- Questions RLS
    ALTER TABLE questions ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Anyone can read questions"
      ON questions FOR SELECT TO authenticated
      USING (true);

    CREATE POLICY "Session creator can insert questions"
      ON questions FOR INSERT TO authenticated
      WITH CHECK (
        EXISTS (
          SELECT 1 FROM sessions
          WHERE sessions.session_id = questions.session_id
          AND sessions.created_by = (select auth.uid())
        )
      );

    CREATE POLICY "Session creator can update questions"
      ON questions FOR UPDATE TO authenticated
      USING (
        EXISTS (
          SELECT 1 FROM sessions
          WHERE sessions.session_id = questions.session_id
          AND sessions.created_by = (select auth.uid())
        )
      );

    CREATE POLICY "Session creator can delete questions"
      ON questions FOR DELETE TO authenticated
      USING (
        EXISTS (
          SELECT 1 FROM sessions
          WHERE sessions.session_id = questions.session_id
          AND sessions.created_by = (select auth.uid())
        )
      );

    -- Votes RLS
    ALTER TABLE votes ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Authenticated users can insert votes"
      ON votes FOR INSERT TO authenticated
      WITH CHECK ((select auth.uid()) = participant_id);

    CREATE POLICY "Anyone can read votes"
      ON votes FOR SELECT TO authenticated
      USING (true);

    CREATE POLICY "Users can update own votes"
      ON votes FOR UPDATE TO authenticated
      USING ((select auth.uid()) = participant_id);
    ```

    3. Verify the SQL ran without errors (green success message)
  </action>
  <how-to-verify>
    After running the SQL:
    1. Go to Table Editor in Supabase Dashboard -- sessions, questions, and votes tables should appear
    2. Click on "sessions" table -- columns should include session_id (text), admin_token (uuid), title, status, created_by, created_at
    3. Go to Authentication > Policies -- each table should have RLS enabled with policies listed
    4. Check Authentication > Settings > User Signups -- "Allow anonymous sign-ins" should be ON
  </how-to-verify>
  <resume-signal>Type "done" after both actions are complete</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create anonymous auth hook and update Supabase client</name>
  <files>
    src/hooks/use-auth.ts
    src/lib/supabase.ts
  </files>
  <action>
    1. Create `src/hooks/use-auth.ts`:

       ```typescript
       import { useEffect, useState } from 'react';
       import { supabase } from '../lib/supabase';

       export function useAuth() {
         const [ready, setReady] = useState(false);

         useEffect(() => {
           async function initAuth() {
             const { data: { session } } = await supabase.auth.getSession();
             if (!session) {
               await supabase.auth.signInAnonymously();
             }
             setReady(true);
           }
           initAuth();
         }, []);

         return { ready };
       }
       ```

       Key points:
       - Check for existing session FIRST (page refresh reuses session)
       - Only call signInAnonymously() if no session exists
       - `ready` flag gates the entire app rendering (nothing renders until auth is ready)
       - Do NOT add error handling that blocks rendering -- if auth fails, still set ready=true so the app loads (graceful degradation)

    2. Update `src/lib/supabase.ts` -- the existing file works fine as-is. Do NOT add Database generic type parameter yet (we're using manual types, not generated types). Leave the file unchanged unless there's a reason to modify it.

    Note: The `useAuth` hook does NOT use Zustand. It's a simple React hook because auth state is app-level and doesn't need the store pattern.
  </action>
  <verify>
    - `src/hooks/use-auth.ts` exists and exports `useAuth`
    - `npx tsc --noEmit` passes
    - The hook imports from `../lib/supabase` (correct relative path)
    - The hook calls `supabase.auth.getSession()` before `signInAnonymously()`
  </verify>
  <done>
    Anonymous auth hook exists at `src/hooks/use-auth.ts`, checks for existing session before signing in anonymously, and exposes a `ready` boolean that gates app rendering.
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-router zustand nanoid` -- all three dependencies installed
2. `npx tsc --noEmit` -- no TypeScript errors
3. `src/types/database.ts` -- exports Session, Question, Vote, VoteType, SessionStatus, QuestionStatus
4. `src/hooks/use-auth.ts` -- exports useAuth with ready state
5. Supabase Dashboard confirms: sessions, questions, votes tables exist with RLS policies
6. Supabase Dashboard confirms: anonymous sign-ins enabled
</verification>

<success_criteria>
- Three npm packages installed (react-router, zustand, nanoid)
- TypeScript types defined for all database entities
- Anonymous auth hook created and type-checks
- Database schema live in Supabase with RLS policies
- Anonymous auth enabled in Supabase Dashboard
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-foundation-and-session-setup/02-01-SUMMARY.md`
</output>

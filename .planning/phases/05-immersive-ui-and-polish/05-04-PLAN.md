---
phase: 05-immersive-ui-and-polish
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/pages/ParticipantSession.tsx
autonomous: false

must_haves:
  truths:
    - "Voting view takes over full screen with dark charcoal background, no header, no nav -- just question and vote buttons"
    - "Question transitions use slide-left animation (AnimatePresence) instead of CSS crossfade"
    - "ConnectionPill is visible in top-right corner during voting, replacing ConnectionBanner"
    - "Desktop participants see a centered card layout (max-w-2xl) instead of edge-to-edge"
    - "All participant views use h-dvh or min-h-dvh Tailwind classes instead of inline style minHeight 100dvh"
    - "Lobby, waiting, and results views remain dark-themed with updated styling"
  artifacts:
    - path: "src/pages/ParticipantSession.tsx"
      provides: "Full-screen immersive participant experience with slide transitions and ConnectionPill"
      min_lines: 300
  key_links:
    - from: "src/pages/ParticipantSession.tsx"
      to: "motion/react"
      via: "AnimatePresence and motion.div for slide transitions"
      pattern: "AnimatePresence"
    - from: "src/pages/ParticipantSession.tsx"
      to: "src/components/ConnectionPill.tsx"
      via: "ConnectionPill component import replacing ConnectionBanner"
      pattern: "ConnectionPill"
    - from: "src/pages/ParticipantSession.tsx"
      to: "src/components/VoteAgreeDisagree.tsx"
      via: "Vote component rendered inside AnimatePresence slide wrapper"
      pattern: "VoteAgreeDisagree"
---

<objective>
Refactor ParticipantSession to deliver the full-screen immersive voting experience: dark charcoal background, no header during voting, AnimatePresence slide-left question transitions, ConnectionPill instead of ConnectionBanner, responsive desktop card layout, and Tailwind h-dvh classes replacing inline 100dvh styles.

Purpose: This is the keystone of Phase 5. It combines all prior plan outputs (motion library, ConnectionPill, animated vote components) into the immersive participant experience that defines QuickVote's identity. Covers UIEX-01 (full-screen tactile) and UIEX-02 (responsive participant layout) and integrates UIEX-03 (ConnectionPill).
Output: ParticipantSession.tsx fully refactored with immersive UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-immersive-ui-and-polish/05-CONTEXT.md
@.planning/phases/05-immersive-ui-and-polish/05-RESEARCH.md
@.planning/phases/05-immersive-ui-and-polish/05-01-SUMMARY.md
@.planning/phases/05-immersive-ui-and-polish/05-02-SUMMARY.md

Key existing files:
@src/pages/ParticipantSession.tsx
@src/components/ConnectionPill.tsx
@src/components/ConnectionBanner.tsx (being replaced on participant side)
@src/components/VoteAgreeDisagree.tsx
@src/components/VoteMultipleChoice.tsx
@src/components/CountdownTimer.tsx
@src/components/ParticipantCount.tsx
@src/components/Lobby.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor ParticipantSession with full-screen immersive layout and slide transitions</name>
  <files>src/pages/ParticipantSession.tsx</files>
  <action>
This is a significant refactor of ParticipantSession.tsx. The component's state management, data fetching, broadcast listeners, and hooks remain UNCHANGED. Only the rendering layer and transition mechanism are being rewritten.

**1. Update imports:**
- Add: `import { motion, AnimatePresence } from "motion/react";`
- Add: `import { ConnectionPill } from '../components/ConnectionPill';`
- Remove: `import { ConnectionBanner } from '../components/ConnectionBanner';`
- Keep all other imports unchanged

**2. Remove CSS crossfade mechanism:**
- Remove the `contentVisible` state (`const [contentVisible, setContentVisible] = useState(true);`)
- Remove the `displayedQuestion` state (`const [displayedQuestion, setDisplayedQuestion] = useState<Question | null>(null);`)
- Remove the entire crossfade useEffect that watches `activeQuestion` and uses `setTimeout` for fade-out/swap/fade-in
- The `activeQuestion` state is now used directly for rendering (no intermediate `displayedQuestion` buffer)

**3. Define slide transition variants (at module scope, outside component):**
```typescript
const questionSlideVariants = {
  enter: { x: '100%', opacity: 0 },
  center: { x: 0, opacity: 1 },
  exit: { x: '-100%', opacity: 0 },
};

const questionTransition = {
  x: { type: 'spring' as const, stiffness: 300, damping: 30 },
  opacity: { duration: 0.2 },
};
```

**4. Replace all inline `style={{ minHeight: '100dvh' }}` with Tailwind classes:**
- Every view wrapper that has `min-h-screen` + `style={{ minHeight: '100dvh' }}` becomes just `min-h-dvh` (remove both the className `min-h-screen` AND the inline style)
- For the voting view specifically, use `h-dvh` (fixed height, not min-height) since it should be full-screen with no scroll on the outer container

**5. Refactor the VOTING view (the main visual change):**

Replace the current voting render with a full-screen takeover layout:

```tsx
// Voting state
if (view === 'voting' && activeQuestion && participantId) {
  // Name prompt overlay (keep existing, just update layout classes)
  if (namePromptVisible) {
    return (
      <div className="h-dvh bg-gray-950 flex items-center justify-center px-4">
        <ConnectionPill status={connectionStatus} />
        <div className="bg-gray-900 rounded-xl p-6 w-full max-w-sm space-y-4">
          {/* ... name prompt form unchanged ... */}
        </div>
      </div>
    );
  }

  // Full-screen voting takeover
  return (
    <div className="h-dvh bg-gray-950 flex flex-col overflow-hidden">
      {/* Connection pill - always visible in top-right */}
      <ConnectionPill status={connectionStatus} />

      {/* Minimal top bar - only timer when active, no header/nav */}
      {isRunning && (
        <div className="flex justify-center px-4 py-2">
          <CountdownTimer
            remainingSeconds={Math.ceil(remaining / 1000)}
            isRunning={isRunning}
          />
        </div>
      )}

      {/* Full-screen voting area with slide transitions */}
      <div className="flex-1 flex flex-col min-h-0">
        {/* Desktop: centered card. Mobile: edge-to-edge */}
        <div className="flex-1 flex flex-col lg:items-center lg:justify-center lg:p-8">
          <div className="flex-1 flex flex-col lg:flex-initial lg:w-full lg:max-w-2xl lg:rounded-2xl lg:bg-gray-900/50 lg:overflow-hidden">
            <AnimatePresence mode="wait" initial={false}>
              <motion.div
                key={activeQuestion.id}
                variants={questionSlideVariants}
                initial="enter"
                animate="center"
                exit="exit"
                transition={questionTransition}
                className="flex-1 flex flex-col"
              >
                {activeQuestion.type === 'agree_disagree' ? (
                  <VoteAgreeDisagree
                    question={activeQuestion}
                    sessionId={sessionId!}
                    participantId={participantId}
                    displayName={participantName || null}
                  />
                ) : (
                  <VoteMultipleChoice
                    question={activeQuestion}
                    sessionId={sessionId!}
                    participantId={participantId}
                    displayName={participantName || null}
                  />
                )}
              </motion.div>
            </AnimatePresence>
          </div>
        </div>
      </div>
    </div>
  );
}
```

Key layout decisions:
- `h-dvh` on outer container (full viewport, no scroll)
- `overflow-hidden` on outer container (prevent AnimatePresence slide from showing scrollbar)
- NO header, NO ParticipantCount in voting view (full-screen takeover per CONTEXT.md)
- Timer centered at top when running, otherwise nothing above the vote
- Desktop (lg breakpoint): centered card with max-w-2xl, rounded corners, subtle dark background
- Mobile: edge-to-edge, fills entire screen
- AnimatePresence with `mode="wait"` ensures old question exits before new enters
- `initial={false}` prevents entrance animation on first question load

**6. Refactor NON-VOTING views (lobby, waiting, results, loading, error):**

These views stay dark-themed but get minor polish:

Loading:
```tsx
<div className="min-h-dvh bg-gray-950 flex items-center justify-center">
  <p className="text-gray-400 text-lg">Loading session...</p>
</div>
```
(Replace `min-h-screen` + inline style with just `min-h-dvh`)

Error:
```tsx
<div className="min-h-dvh bg-gray-950 flex items-center justify-center">
  {/* ... same content, just min-h-dvh ... */}
</div>
```

Lobby:
```tsx
<div className="min-h-dvh bg-gray-950 flex flex-col">
  <ConnectionPill status={connectionStatus} />
  {/* ... same content ... */}
</div>
```
(Replace ConnectionBanner with ConnectionPill)

Waiting:
```tsx
<div className="min-h-dvh bg-gray-950 flex flex-col">
  <ConnectionPill status={connectionStatus} />
  {/* ... same content ... */}
</div>
```

Results:
```tsx
<div className="min-h-dvh bg-gray-950 flex flex-col">
  <ConnectionPill status={connectionStatus} />
  {/* ... same content ... */}
</div>
```

Fallback:
```tsx
<div className="min-h-dvh bg-gray-950 flex items-center justify-center">
  <p className="text-gray-400 text-lg">Loading...</p>
</div>
```

**7. Update voting view guard:**
- Change `if (view === 'voting' && displayedQuestion && participantId)` to `if (view === 'voting' && activeQuestion && participantId)` since displayedQuestion is removed

**Critical -- what NOT to change:**
- ALL state management (useState, useRef, viewRef, activeQuestionRef, hasConnectedOnce)
- ALL broadcast listener setup (setupChannel callback)
- ALL realtime hooks (useRealtimeChannel, usePresence, useCountdown)
- ALL data fetching (loadInitial, refetchState)
- ALL derived state logic (deriveView, shouldPromptName)
- Name prompt form logic and sessionStorage handling
- The reconnection re-fetch effect
- Cleanup on unmount effect

The ONLY things changing are:
1. Imports (add motion/AnimatePresence/ConnectionPill, remove ConnectionBanner)
2. Remove crossfade state and effect (contentVisible, displayedQuestion)
3. Slide variants defined at module scope
4. JSX rendering for each view (layout classes and ConnectionPill)
5. Voting view uses AnimatePresence instead of CSS crossfade
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors.
Grep for "ConnectionBanner" in ParticipantSession.tsx -- should find zero matches (replaced with ConnectionPill).
Grep for "ConnectionPill" in ParticipantSession.tsx -- should find matches.
Grep for "AnimatePresence" in ParticipantSession.tsx -- should find matches.
Grep for "displayedQuestion" in ParticipantSession.tsx -- should find zero matches (crossfade removed).
Grep for "contentVisible" in ParticipantSession.tsx -- should find zero matches (crossfade removed).
Grep for "min-h-screen" in ParticipantSession.tsx -- should find zero matches (replaced with min-h-dvh).
Grep for "minHeight.*100dvh" in ParticipantSession.tsx -- should find zero matches (inline styles removed).
  </verify>
  <done>
ParticipantSession voting view is full-screen dark takeover with no header. Question transitions use AnimatePresence slide-left animation. ConnectionPill replaces ConnectionBanner. Desktop participants see centered card layout. All views use Tailwind h-dvh/min-h-dvh instead of inline styles. CSS crossfade mechanism fully removed. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete immersive UI and polish for QuickVote -- Motion-animated vote buttons with color fill and pulse, AnimatePresence slide transitions between questions, full-screen dark participant voting experience, light-themed admin with projection-friendly results, floating ConnectionPill status indicator.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Create a new session from the home page

**Admin side (desktop browser):**
3. Verify the admin page has a LIGHT background (white/light gray, not dark)
4. Add 2-3 questions (mix of agree/disagree and multiple choice)
5. Start session -> Begin voting
6. Verify status badges are readable on light background
7. Activate a question -> verify BarChart results are large and readable

**Participant side (mobile browser or narrow window):**
8. Open the participant URL in a separate tab/device
9. Verify the lobby shows ConnectionPill (green dot, top-right corner) instead of a full-width banner
10. When question is activated, verify:
    - Full-screen dark takeover (no header, no navigation visible)
    - Vote buttons fill the screen with large tap targets
    - Tapping a vote option: button fills with color (blue for agree, orange for disagree) and pulses
    - Tapping again shows the whileTap scale-down feedback
    - Lock-in shows animated overlay with drawing checkmark
11. Activate a second question -> verify the slide-left transition (old question slides out left, new slides in from right)
12. If on desktop browser with wide window, verify participant sees a centered card (not edge-to-edge)
13. Verify countdown timer appears at top center when admin sets a timer

**Connection indicator:**
14. Verify green dot is always visible in top-right corner during all participant views (lobby, voting, waiting)

Type "approved" if the immersive experience looks and feels good, or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ParticipantSession imports ConnectionPill (not ConnectionBanner)
3. ParticipantSession uses AnimatePresence for question transitions
4. No inline `minHeight: '100dvh'` styles remain (all replaced with Tailwind h-dvh/min-h-dvh)
5. No `displayedQuestion` or `contentVisible` state (crossfade removed)
6. Voting view has no header/nav -- full-screen takeover
7. Desktop participant view has max-w-2xl centered card with rounded corners
8. Human verification confirms visual quality of animations and layout
</verification>

<success_criteria>
- Voting UI takes over the full screen on mobile with large tap targets and satisfying animations (UIEX-01)
- App works well on phone (participant voting edge-to-edge) and desktop (admin light theme, participant centered card) (UIEX-02)
- ConnectionPill shows green dot when connected, red pill with text when disconnected (UIEX-03)
- Question transitions slide left with spring physics
- All three UIEX requirements verified by human inspection
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-immersive-ui-and-polish/05-04-SUMMARY.md`
</output>

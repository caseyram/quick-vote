---
phase: 26-sequence-results-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-multi-select.ts
  - src/components/SequenceManager.tsx
  - src/components/SequenceItemCard.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can shift-click to select a range of sequence items"
    - "Admin can ctrl/cmd-click to toggle individual item selection"
    - "Selected items display a visible background tint"
    - "Admin can drag one selected item and all selected items move as a group"
    - "Escape key and clicking empty space both clear the selection"
    - "Selection clears after a successful group drag"
  artifacts:
    - path: "src/hooks/use-multi-select.ts"
      provides: "Multi-select state management with shift/ctrl-click support"
      exports: ["useMultiSelect"]
    - path: "src/components/SequenceManager.tsx"
      provides: "Multi-select integration with DnD context and group drag logic"
      contains: "useMultiSelect"
    - path: "src/components/SequenceItemCard.tsx"
      provides: "Visual selection state (isSelected prop) with background tint"
      contains: "isSelected"
  key_links:
    - from: "src/components/SequenceManager.tsx"
      to: "src/hooks/use-multi-select.ts"
      via: "useMultiSelect hook import"
      pattern: "useMultiSelect"
    - from: "src/components/SequenceManager.tsx"
      to: "src/components/SequenceItemCard.tsx"
      via: "isSelected prop"
      pattern: "isSelected=\\{"
---

<objective>
Implement multi-select rearrangement in the sequence sidebar so admins can select multiple items via shift-click and ctrl-click, then drag them as a group to reorder the sequence.

Purpose: Long sequences with many slides and batches are tedious to rearrange one item at a time. Group selection and drag enables efficient reorganization.
Output: Working multi-select with shift/ctrl-click selection, visual tinting, group drag, and deselection via Escape/click-empty.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-sequence-results-enhancements/26-RESEARCH.md

@src/components/SequenceManager.tsx
@src/components/SequenceItemCard.tsx
@src/hooks/use-sequence-navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMultiSelect hook and integrate selection into SequenceManager</name>
  <files>
    src/hooks/use-multi-select.ts
    src/components/SequenceManager.tsx
  </files>
  <action>
Create `src/hooks/use-multi-select.ts` — a custom React hook that manages multi-select state for a list of items.

**Hook API:**
```typescript
interface UseMultiSelectOptions {
  itemIds: string[];      // Current ordered list of item IDs
  enabled?: boolean;      // Disable selection (e.g., during drag)
}

interface UseMultiSelectReturn {
  selectedIds: Set<string>;
  lastSelectedId: string | null;
  handleItemClick: (itemId: string, event: React.MouseEvent) => void;
  handleContainerClick: (event: React.MouseEvent) => void;
  clearSelection: () => void;
  isSelected: (itemId: string) => boolean;
}
```

**Selection logic:**
- **Shift-click**: Range select from `lastSelectedId` to clicked item (inclusive). Supports bidirectional ranges. ADDS to existing selection (union with Set spread).
- **Ctrl/Meta-click**: Toggle individual item. If already selected, remove; otherwise add. Update `lastSelectedId` to clicked item.
- **Regular click (no modifier)**: Select only clicked item, deselect all others. Update `lastSelectedId`.
- **Escape key**: Clear all selection. Use `useEffect` with `window.addEventListener('keydown')`. Cleanup on unmount.
- Use `Set<string>` for O(1) lookups — not Array.includes.
- Track `lastSelectedId` in `useState` for shift-range anchoring.

**Prevent text selection during shift-click**: Add `onMouseDown` handler that calls `e.preventDefault()` when `e.shiftKey` is true. This must be applied to the container div.

**Integrate into SequenceManager.tsx (draft mode only — NOT live mode):**

1. Import and call `useMultiSelect({ itemIds: sortableIds })` in the draft mode branch.
2. Pass `isSelected={isSelected(item.id)}` and `onSelect={(e) => handleItemClick(item.id, e)}` to each `SequenceItemCard` in the draft mode list.
3. Add `onClick={handleContainerClick}` on the container div wrapping the sortable items (for click-empty-space deselection).
4. Add `onMouseDown` handler to that same container for shift-click text selection prevention.

**Modify `handleDragEnd` for group drag:**

When `handleDragEnd` fires, check if the dragged item (`active.id`) is in `selectedIds`:
- **If yes (group drag):** Extract all selected item IDs. Remove them from the current `sortableIds` array. Compute the target insertion index based on `over.id` position in the remaining items. Insert all selected items (preserving their original relative order) at the target index. Build position updates and persist via `reorderSessionItems`.
- **If no (single drag):** Use existing single-item logic unchanged.

After any successful drag, call `clearSelection()`.

**Modify `handleDragStart`:** When drag starts, if the dragged item is NOT in `selectedIds`, clear the selection (prevent dragging unselected items from moving selected ones).

**DragOverlay enhancement:** When multiple items are selected and dragging, show a count badge overlay instead of the single item preview:
```tsx
<DragOverlay>
  {activeItem && (
    <div className="bg-white border-2 border-indigo-400 rounded-lg p-3 shadow-lg opacity-90">
      <div className="flex items-center gap-2">
        {selectedIds.size > 1 ? (
          <span className="text-indigo-600 font-medium">{selectedIds.size} items</span>
        ) : (
          /* existing single-item preview */
        )}
      </div>
    </div>
  )}
</DragOverlay>
```
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Visually inspect: shift-click selects range, ctrl-click toggles, Escape clears, click-empty clears.
  </verify>
  <done>
useMultiSelect hook exports clean API. SequenceManager draft mode uses hook for selection state. Group drag reorders all selected items. DragOverlay shows count badge for multi-select. Selection clears after drag and on Escape/click-empty.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add selection visual state to SequenceItemCard</name>
  <files>
    src/components/SequenceItemCard.tsx
  </files>
  <action>
Extend `SequenceItemCardProps` with two new optional props:
- `isSelected?: boolean` — whether this item is part of the current multi-selection
- `onSelect?: (event: React.MouseEvent) => void` — click handler for selection (passes event for modifier key detection)

**Visual indicator for selected state:**
Update the `colorClasses` computation to add a selected state that takes precedence over the normal color but is overridden by `isActive`:
```typescript
const colorClasses = isActive
  ? 'bg-blue-100 border-blue-500'
  : isSelected
  ? 'bg-indigo-100 border-indigo-400'  // selection tint
  : isBatch
  ? 'bg-blue-50 border-blue-200 hover:border-blue-300'
  : 'bg-purple-50 border-purple-200 hover:border-purple-300';
```

**Click handling:**
- When `onSelect` is provided, wire the card's outer `onClick` to call `onSelect(event)` INSTEAD of the existing `onClick` prop. This ensures selection events carry the MouseEvent with modifier keys.
- When `onSelect` is NOT provided (live mode), keep existing `onClick` behavior unchanged.
- The drag handle's `onClick={(e) => e.stopPropagation()}` already prevents drag handle clicks from triggering card clicks — this stays.
- The batch expand button and delete button also have `e.stopPropagation()` — they remain unaffected by selection.

**Important:** The `onSelect` handler must NOT interfere with the drag handle's pointer sensor. The `PointerSensor` with `activationConstraint: { distance: 8 }` in SequenceManager handles the distinction between click and drag — clicks under 8px trigger selection, drags beyond 8px trigger DnD. No changes needed to sensor config.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Selected items show indigo background tint. Shift-click range works. Ctrl-click toggle works. Drag handle still initiates drag. Batch expand button and delete button still work without triggering selection.
  </verify>
  <done>
SequenceItemCard accepts isSelected and onSelect props. Selected items display indigo background tint. Click on card triggers selection with proper modifier key detection. Existing interactive elements (drag handle, expand, delete) remain functional.
  </done>
</task>

</tasks>

<verification>
1. Open a session in draft mode with 5+ sequence items (mix of batches and slides)
2. Click an item — only that item selected (indigo tint)
3. Ctrl-click another item — both selected
4. Ctrl-click first item again — deselected (only second remains)
5. Click item A, then shift-click item D — items A through D all selected
6. Press Escape — all deselected
7. Select 3 items, drag one of them — all 3 move as group, relative order preserved
8. After drop, selection cleared
9. Click empty space between items — selection cleared
10. In live mode (PresentationControls), verify no selection UI appears (selection is draft-only)
</verification>

<success_criteria>
- Multi-select via shift-click (range) and ctrl/cmd-click (toggle) works in draft mode
- Selected items show indigo background tint
- Group drag moves all selected items preserving relative order
- Escape and click-empty-space both clear selection
- Live mode (isLive) has no selection behavior
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-sequence-results-enhancements/26-01-SUMMARY.md`
</output>

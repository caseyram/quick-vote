---
phase: 22-template-foundation-authoring
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/editor/PreviewMode.tsx
  - src/components/editor/EditorToolbar.tsx
  - src/components/editor/SegmentedControl.tsx
  - src/components/shared/SlideLightbox.tsx
  - src/components/editor/SlideEditor.tsx
  - src/components/editor/EditorSidebar.tsx
  - src/pages/TemplateEditorPage.tsx
  - src/pages/Home.tsx
  - src/components/SessionTemplatePanel.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can toggle between Edit and Preview modes via segmented control in toolbar"
    - "Preview mode hides the sidebar and shows content full-width, stepping through sequence items one at a time"
    - "Preview mode has next/prev navigation to walk through the sequence like a live session"
    - "Admin can click a slide thumbnail (in sidebar or slide editor) to view full image in lightbox overlay"
    - "Admin can create a quick one-off session by clicking Create New on the home page, building content in the editor, and choosing Start Session"
    - "Admin can start a new session from an existing template (copy, original untouched)"
  artifacts:
    - path: "src/components/editor/PreviewMode.tsx"
      provides: "Preview mode component stepping through sequence items with next/prev navigation"
    - path: "src/components/editor/SegmentedControl.tsx"
      provides: "Reusable edit/preview toggle control"
    - path: "src/components/shared/SlideLightbox.tsx"
      provides: "Lightbox wrapper using yet-another-react-lightbox for full-size image viewing"
  key_links:
    - from: "src/components/editor/EditorToolbar.tsx"
      to: "src/components/editor/SegmentedControl.tsx"
      via: "SegmentedControl for edit/preview toggle"
      pattern: "SegmentedControl"
    - from: "src/pages/TemplateEditorPage.tsx"
      to: "src/components/editor/PreviewMode.tsx"
      via: "Conditionally renders PreviewMode when mode=preview, hiding sidebar"
      pattern: "PreviewMode"
    - from: "src/components/editor/SlideEditor.tsx"
      to: "src/components/shared/SlideLightbox.tsx"
      via: "Opens lightbox on image click"
      pattern: "SlideLightbox"
    - from: "src/pages/Home.tsx"
      to: "/templates/new"
      via: "Create New button navigates to template editor"
      pattern: "navigate.*templates"
---

<objective>
Implement edit/preview toggle, preview mode walkthrough, slide image lightbox, and quick session creation flow. This completes AUTH-02 (edit/preview), AUTH-07 (lightbox), and AUTH-08 (quick session).

Purpose: Enables admins to preview their template as it would appear live, view slide images at full size, and quickly create sessions from the template editor.

Output: Working preview mode with next/prev navigation, lightbox for slide images, and updated Home page with Create New / New from Template flows.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-template-foundation-authoring/22-CONTEXT.md
@.planning/phases/22-template-foundation-authoring/22-RESEARCH.md
@.planning/phases/22-template-foundation-authoring/22-01-SUMMARY.md
@src/pages/TemplateEditorPage.tsx
@src/stores/template-editor-store.ts
@src/components/editor/EditorToolbar.tsx
@src/components/editor/EditorSidebar.tsx
@src/components/editor/SlideEditor.tsx
@src/pages/Home.tsx
@src/components/SessionTemplatePanel.tsx
@src/lib/session-template-api.ts
@src/components/SlideDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Edit/Preview toggle and PreviewMode component</name>
  <files>
    src/components/editor/SegmentedControl.tsx
    src/components/editor/PreviewMode.tsx
    src/components/editor/EditorToolbar.tsx
    src/pages/TemplateEditorPage.tsx
    src/components/editor/EditorSidebar.tsx
  </files>
  <action>
Create `src/components/editor/SegmentedControl.tsx`:

- Reusable segmented control component
- Props: `options: { value: string; label: string }[]`, `value: string`, `onChange: (value: string) => void`
- Renders: inline-flex container with bg-gray-100 rounded-lg p-0.5. Each option is a button. Active option has bg-white shadow-sm rounded-md text-gray-900 font-medium. Inactive has text-gray-500 hover:text-gray-700.
- Keyboard accessible: Tab between options, Enter/Space to select
- Compact sizing: text-sm, px-3 py-1.5

Update `src/components/editor/EditorToolbar.tsx`:

- Replace the edit/preview toggle placeholder with `<SegmentedControl>` using options `[{ value: 'edit', label: 'Edit' }, { value: 'preview', label: 'Preview' }]`
- Toggle state managed via URL search param `?mode=preview` (per research recommendation): use `useSearchParams` from react-router. Default mode is 'edit' (no param). Toggle sets `?mode=preview` or removes the param.
- Export/expose the current mode so the parent TemplateEditorPage can read it

Update `src/pages/TemplateEditorPage.tsx`:

- Read `mode` from URL search params (default 'edit')
- When mode is 'edit': show sidebar + main area (current layout)
- When mode is 'preview': hide sidebar, render `<PreviewMode />` instead of sidebar + main area. PreviewMode takes full width.
- Transition: simple conditional rendering (no animation needed for Phase 22, per Claude's discretion)

Create `src/components/editor/PreviewMode.tsx`:

- Reads items from template-editor-store
- Maintains local `currentIndex` state (starts at 0)
- Renders the current sequence item full-width, one at a time:
  - For batch items: render a read-only batch preview showing batch name, question list with text and type badges, timer duration if set. Style to look like formatted content as it would appear live (use similar card styling to live session batch cards). Questions shown as a numbered list with their text and type.
  - For slide items: render the slide image full-screen width (max-height 70vh, object-contain, centered) with caption below. Use `getSlideImageUrl()` for the image source.
- Navigation bar at bottom: "Previous" and "Next" buttons + position indicator ("{current} of {total}")
- Previous disabled at index 0, Next disabled at last index
- Keyboard shortcuts: ArrowLeft for prev, ArrowRight for next (use useEffect with keydown listener, cleanup on unmount)
- Empty state: if no items, show "No items to preview. Add batches or slides in Edit mode."
- Background: bg-white for the preview content area, centered
- The preview does NOT simulate actual voting or timers — it shows formatted, read-only content representing how the sequence flows (per Phase 22 scope in context; Phase 23 extends with multi-view projection/control/participant simulation)
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. In the editor, click Preview toggle — sidebar hides, preview shows first item. Click Next/Previous — steps through items. Arrow keys work. Click Edit — sidebar returns.
  </verify>
  <done>
    SegmentedControl renders edit/preview toggle in toolbar. Preview mode hides sidebar and shows sequence items one at a time with next/prev navigation. Keyboard shortcuts (ArrowLeft/Right) work. URL updates with ?mode=preview for deep-linking. Preview shows formatted read-only content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slide lightbox and quick session flow</name>
  <files>
    src/components/shared/SlideLightbox.tsx
    src/components/editor/SlideEditor.tsx
    src/components/editor/SidebarSequenceItem.tsx
    src/pages/Home.tsx
    src/components/editor/EditorToolbar.tsx
    src/pages/TemplateEditorPage.tsx
  </files>
  <action>
**Lightbox (AUTH-07):**

Install yet-another-react-lightbox: `npm install yet-another-react-lightbox`

Create `src/components/shared/SlideLightbox.tsx`:

- Wrapper around yet-another-react-lightbox
- Props: `open: boolean`, `onClose: () => void`, `imageSrc: string`, `alt?: string`
- Imports: `import Lightbox from 'yet-another-react-lightbox'` and `import 'yet-another-react-lightbox/styles.css'`
- Renders `<Lightbox open={open} close={onClose} slides={[{ src: imageSrc }]} />` — single image lightbox
- Simple, minimal — just wraps the library for consistent usage across the app

Update `src/components/editor/SlideEditor.tsx`:

- Add state `lightboxOpen: boolean` (default false)
- When user clicks the slide image, set lightboxOpen to true
- Render `<SlideLightbox open={lightboxOpen} onClose={() => setLightboxOpen(false)} imageSrc={getSlideImageUrl(slide.image_path)} />`
- Add cursor-pointer and hover:opacity-90 transition to the image
- This fulfills AUTH-07: admin can click slide thumbnail to view full image in lightbox

Update `src/components/editor/SidebarSequenceItem.tsx`:

- For slide items with thumbnails, also make the thumbnail clickable to open lightbox
- Add local lightboxOpen state and SlideLightbox rendering
- Stop propagation on thumbnail click so it doesn't also select the item

**Quick Session Flow (AUTH-08):**

Update `src/pages/Home.tsx`:

- Restructure the "Create Session" area to offer two paths:
  1. **"Create New"** button — navigates to `/templates/new` (opens blank template editor). Admin builds content, then uses toolbar actions.
  2. **"Quick Session"** button — keeps existing behavior (creates session immediately in Supabase, navigates to /admin/:adminToken). This is the truly one-off flow where admin doesn't use the template editor at all.
- Also add a **"New from Template"** section below: show a small template list (fetch from session-template-store). Clicking a template navigates to `/templates/${templateId}/edit?from=template` — the editor loads a COPY of the template for review/tweaking.
- Keep the session title input for Quick Session. For Create New, the title is set in the template editor.
- Layout: Keep existing centered card layout. Add the template list below the main action buttons, with a subtle divider.

Update `src/pages/TemplateEditorPage.tsx`:

- Check for `?from=template` search param. If present, the editor loaded a copy from an existing template — don't update the original. When saving, always create a NEW template (even though we loaded from an existing one). Clear the `from` param after initial load.

Update `src/components/editor/EditorToolbar.tsx`:

- Add a **"Start Session"** button next to the Save button. This is the one-off session launch:
  1. Serialize current editor state to blueprint via `toBlueprint()`
  2. Create a new session in Supabase (same as Home.tsx createSession pattern: nanoid for session_id, insert into sessions table)
  3. Call `loadTemplateIntoSession(sessionId, blueprint)` to materialize the blueprint into real batches/questions/session_items
  4. Navigate to `/admin/${adminToken}` — the admin is now in a live session
  5. This is "Start Session" = one-off, no template saved. The session data persists but no template record is created.
- Show "Start Session" and "Save Template" as separate, clearly labeled buttons. "Save Template" saves for reuse, "Start Session" launches immediately.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Click slide image in editor — lightbox opens with full-size image. Click slide thumbnail in sidebar — lightbox opens. Home page shows Create New, Quick Session, and New from Template options. "Create New" opens blank editor. "Start Session" in editor creates session and navigates to admin view.
  </verify>
  <done>
    Lightbox opens on slide image click (editor and sidebar thumbnails) using yet-another-react-lightbox (AUTH-07). Home page offers Create New (template editor), Quick Session (direct), and New from Template (copy) flows (AUTH-08). Editor toolbar has "Start Session" button for one-off session launch without saving template. "New from Template" loads a copy that doesn't modify the original.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Toggle Edit/Preview — sidebar hides/shows, preview renders sequence items
3. Preview next/prev navigation works with buttons and arrow keys
4. Click slide image in editor — lightbox overlay shows full image
5. Click slide thumbnail in sidebar — lightbox opens
6. Home page: "Create New" → opens /templates/new
7. Home page: "Quick Session" → creates session directly (existing behavior)
8. Home page: "New from Template" → opens editor with template copy
9. Editor toolbar: "Start Session" → creates session from blueprint, navigates to admin view
10. Editor toolbar: "Save Template" → saves to Supabase (existing save behavior)
</verification>

<success_criteria>
- Edit/Preview toggle works via SegmentedControl with URL search param persistence
- Preview mode shows formatted sequence items one at a time with next/prev navigation
- Lightbox opens on slide image/thumbnail click using yet-another-react-lightbox
- Quick session flow: Create New, Quick Session, and New from Template all work from Home page
- Start Session in editor creates a one-off session without saving a template
</success_criteria>

<output>
After completion, create `.planning/phases/22-template-foundation-authoring/22-03-SUMMARY.md`
</output>

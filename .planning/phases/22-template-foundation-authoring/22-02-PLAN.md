---
phase: 22-template-foundation-authoring
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/editor/BatchEditor.tsx
  - src/components/editor/QuestionRow.tsx
  - src/components/shared/DurationInput.tsx
  - src/stores/template-editor-store.ts
  - src/components/editor/EditorMainArea.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can select a batch in sidebar and see its questions listed as collapsed compact rows in the main area"
    - "Admin can click a question row to expand it and edit all fields inline (text, response type, options, timer override)"
    - "Admin can drag-reorder questions within a batch via handles on collapsed rows"
    - "Admin can add a new question to a batch via Add Question button at the bottom"
    - "Admin can configure batch timer duration via free-form number input in the batch header"
    - "Inline edits immediately reflect in the store (sidebar shows updated question count, batch name updates)"
  artifacts:
    - path: "src/components/editor/BatchEditor.tsx"
      provides: "Batch detail view with question list, batch name editing, timer duration input"
    - path: "src/components/editor/QuestionRow.tsx"
      provides: "Collapsed/expanded question row with inline editing and drag handle"
    - path: "src/components/shared/DurationInput.tsx"
      provides: "Timer duration input component (number input in seconds)"
  key_links:
    - from: "src/components/editor/EditorMainArea.tsx"
      to: "src/components/editor/BatchEditor.tsx"
      via: "Renders BatchEditor when selected item is a batch"
      pattern: "BatchEditor"
    - from: "src/components/editor/BatchEditor.tsx"
      to: "src/components/editor/QuestionRow.tsx"
      via: "Maps batch questions to QuestionRow components inside SortableContext"
      pattern: "QuestionRow"
    - from: "src/components/editor/BatchEditor.tsx"
      to: "src/stores/template-editor-store.ts"
      via: "Updates questions via store.updateItem with modified batch data"
      pattern: "useTemplateEditorStore"
    - from: "src/components/editor/QuestionRow.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable for drag-reorder handles"
      pattern: "useSortable"
---

<objective>
Build inline batch question editing: collapsed/expanded question rows, drag-reorder within batch, add question, and batch timer duration input. This completes AUTH-06 (inline editing) and AUTH-09 (timer duration).

Purpose: The core editing experience — admins build batch content directly within the sequence by expanding and editing questions in place, without navigating to a separate panel.

Output: Working BatchEditor with collapsible QuestionRows, drag-reorder, and DurationInput for batch timer.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-template-foundation-authoring/22-CONTEXT.md
@.planning/phases/22-template-foundation-authoring/22-RESEARCH.md
@.planning/phases/22-template-foundation-authoring/22-01-SUMMARY.md
@src/stores/template-editor-store.ts
@src/components/editor/EditorMainArea.tsx
@src/types/database.ts
@src/components/SequenceManager.tsx
@src/components/TemplateEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: BatchEditor with collapsed QuestionRows and drag-reorder</name>
  <files>
    src/components/editor/BatchEditor.tsx
    src/components/editor/QuestionRow.tsx
    src/components/editor/EditorMainArea.tsx
  </files>
  <action>
Create `src/components/editor/BatchEditor.tsx`:

- Receives the selected EditorItem (batch type) from the store
- **Batch header section:**
  - Inline editable batch name (click to edit, Enter/Escape, updates store via `updateItem`)
  - Question count display: "{N} questions"
- **Question list:**
  - Uses DndContext + SortableContext (nested, independent from sidebar DndContext) with verticalListSortingStrategy
  - PointerSensor with distance: 8 activation constraint
  - Maps `item.batch.questions` to `<QuestionRow>` components
  - On drag end: reorder questions array within the batch, update store via `updateItem` with new questions array
  - **Critical per research:** Auto-collapse all expanded questions on drag start (via onDragStart callback setting a local `collapseAll` counter that QuestionRows observe). This prevents glitchy drag overlays from expanded rows.
- **Add question button:**
  - "Add Question" button at the bottom of the question list (styled: dashed border, text-indigo-600)
  - Creates new EditorQuestion with nanoid id, default text "", type "agree_disagree", options null, anonymous false, timer_duration null, template_id null
  - Appends to questions array via store update, auto-expands the new question
- **DragOverlay:**
  - Shows compact question summary during drag (question text truncated, type badge)

Create `src/components/editor/QuestionRow.tsx`:

- Uses `useSortable` hook for drag-and-drop integration
- **Collapsed state (default):**
  - Compact single row: drag handle (grip dots, only visible when collapsed per research) + question type badge (A/D or MC) + question text (truncated) + expand chevron
  - Click anywhere on the row (except drag handle) to expand
  - Row styling: bg-white rounded-lg border border-gray-200 p-3, hover:bg-gray-50
- **Expanded state:**
  - All editable fields visible inline:
    - Question text: textarea (auto-grow, auto-focus on expand via useRef + useEffect)
    - Response type: select dropdown (agree_disagree, multiple_choice)
    - Options: if multiple_choice, show ordered option inputs with add/remove (similar to existing TemplateEditor.tsx pattern but simpler — just text inputs). Show/hide based on type selection.
    - Anonymous toggle: checkbox with label
    - Timer override: `<DurationInput>` component for per-question timer (optional)
  - Keyboard handling: Escape collapses the row. Enter in single-line fields collapses.
  - All changes immediately update the parent batch's questions array in the store (pass onChange callback from BatchEditor)
  - Delete question button (red text, bottom-right of expanded area)
  - Collapse button (chevron up) at top-right
- **Important:** When expanded, drag handle is hidden to prevent drag-while-editing issues (per research pitfall #2)
- The component receives `onCollapse` signal (collapseAll counter from BatchEditor) and collapses when it changes (useEffect on counter)

Update `src/components/editor/EditorMainArea.tsx`:
- Replace the batch placeholder with `<BatchEditor>` component, passing the selected EditorItem
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Select a batch in sidebar — see question list. Click question to expand — all edit fields visible. Drag questions to reorder. Add new question.
  </verify>
  <done>
    BatchEditor renders questions as collapsed compact rows. Clicking expands inline with all editable fields. Questions are drag-reorderable. Add Question appends new question and auto-expands it. All edits immediately update the store (sidebar reflects changes). Expanded questions auto-collapse on drag start.
  </done>
</task>

<task type="auto">
  <name>Task 2: DurationInput component and timer duration wiring</name>
  <files>
    src/components/shared/DurationInput.tsx
    src/components/editor/BatchEditor.tsx
    src/stores/template-editor-store.ts
  </files>
  <action>
Create `src/components/shared/DurationInput.tsx`:

- A "free-form input" for timer duration per AUTH-09 and user decisions
- Implementation: number input for seconds with helper text
- Props: `value: number | null`, `onChange: (value: number | null) => void`, `label?: string`, `placeholder?: string`
- Renders: labeled number input with min=0, step=1
- Displays human-readable conversion below: if value > 0, show "= {minutes}m {seconds}s" (e.g., "90" shows "= 1m 30s")
- Empty/0 value means "no timer" (returns null via onChange)
- Input styling: same as other admin inputs (bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-gray-900)
- Small enough to sit inline in the batch header area

Update `src/components/editor/BatchEditor.tsx`:
- Add DurationInput in the batch header area, after the batch name
- Label: "Batch Timer (seconds)"
- Value comes from a new `timer_duration` field on the EditorItem batch data
- onChange updates the batch's timer_duration in the store

Update `src/stores/template-editor-store.ts`:
- Add `timer_duration: number | null` to the batch sub-object within EditorItem (default null)
- Ensure `toBlueprint()` includes timer_duration in the batch blueprint data. Extend SessionBlueprintItem.batch to include `timer_duration?: number | null` in the blueprint.
- Ensure `loadFromBlueprint()` reads timer_duration from blueprint items
- Note: The QuestionBlueprint already has timer_duration support via the EditorQuestion interface. The batch-level timer is an additional field on the batch itself (this is the "batch timer duration" from AUTH-09 — it applies to the entire batch, not per-question).

Also update the blueprint type in `src/types/database.ts`: add `timer_duration?: number | null` to the batch sub-object inside SessionBlueprintItem. This is backward-compatible (optional field, older blueprints just won't have it).
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Open a batch in the editor — see DurationInput in header. Enter "90" — shows "= 1m 30s" below. Save template — blueprint includes timer_duration. Load template — timer_duration restored.
  </verify>
  <done>
    DurationInput component renders number input with human-readable conversion. Batch header includes timer duration configuration. Timer duration persists in blueprint via toBlueprint/loadFromBlueprint. Blueprint type extended with backward-compatible timer_duration field.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Select batch in sidebar — BatchEditor renders with question list
3. Click question — expands with all editable fields (text, type, options, anonymous, timer)
4. Edit question text — sidebar still shows correct question count, changes persist
5. Drag question — reorders within batch, expanded questions auto-collapse during drag
6. Click "Add Question" — new question added and auto-expanded
7. DurationInput in batch header accepts number, shows human-readable format
8. Save and reload template — all question edits and timer duration preserved
</verification>

<success_criteria>
- Batch questions render as collapsed compact rows with type badge and truncated text
- Expanding a question reveals all editable fields inline (not in a separate panel)
- Questions are drag-reorderable within a batch
- New questions can be added at the bottom of the batch
- Batch timer duration is configurable via DurationInput (AUTH-09)
- All edits immediately update the store and persist through save/load cycle
</success_criteria>

<output>
After completion, create `.planning/phases/22-template-foundation-authoring/22-02-SUMMARY.md`
</output>

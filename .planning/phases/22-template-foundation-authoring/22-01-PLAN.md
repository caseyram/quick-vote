---
phase: 22-template-foundation-authoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/pages/TemplateEditorPage.tsx
  - src/stores/template-editor-store.ts
  - src/components/editor/EditorToolbar.tsx
  - src/components/editor/EditorSidebar.tsx
  - src/components/editor/SidebarSequenceItem.tsx
  - src/components/editor/EditorMainArea.tsx
  - src/components/editor/SlideEditor.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /templates/new and see the template editor with toolbar, sidebar, and main area"
    - "Admin can navigate to /templates/:id/edit and see an existing template loaded into the editor"
    - "Admin can edit template name inline in the toolbar"
    - "Admin can see sequence items in the sidebar with type icons, titles, and summaries"
    - "Admin can drag-and-drop sidebar items to reorder the sequence"
    - "Admin can add a new batch or slide via toolbar insert actions, inserted after the selected item"
    - "Admin can select a sidebar item and see its details in the main area"
    - "Admin can save the template to Supabase via the Save button"
  artifacts:
    - path: "src/pages/TemplateEditorPage.tsx"
      provides: "Full-page template editor at /templates/:id/edit and /templates/new"
    - path: "src/stores/template-editor-store.ts"
      provides: "Zustand store for editor state (blueprint items, selected item, dirty flag, mode)"
    - path: "src/components/editor/EditorToolbar.tsx"
      provides: "Top toolbar with back arrow, inline name, insert actions, save, edit/preview toggle placeholder"
    - path: "src/components/editor/EditorSidebar.tsx"
      provides: "Left sidebar with draggable sequence items"
    - path: "src/components/editor/SidebarSequenceItem.tsx"
      provides: "Individual draggable sidebar item with type icon, title, summary"
    - path: "src/components/editor/EditorMainArea.tsx"
      provides: "Right panel rendering selected item details (batch or slide)"
    - path: "src/components/editor/SlideEditor.tsx"
      provides: "Slide detail view with image and caption editing"
  key_links:
    - from: "src/App.tsx"
      to: "src/pages/TemplateEditorPage.tsx"
      via: "React Router route at /templates/:id/edit and /templates/new"
      pattern: "Route.*templates"
    - from: "src/pages/TemplateEditorPage.tsx"
      to: "src/stores/template-editor-store.ts"
      via: "useTemplateEditorStore hook"
      pattern: "useTemplateEditorStore"
    - from: "src/components/editor/EditorToolbar.tsx"
      to: "src/stores/template-editor-store.ts"
      via: "insert actions and save button call store actions"
      pattern: "useTemplateEditorStore"
    - from: "src/components/editor/EditorSidebar.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext + SortableContext for drag-reorder"
      pattern: "DndContext"
---

<objective>
Create the template editor shell: full-page route, zustand store for editor state, toolbar with inline name editing and insert actions, sidebar with draggable sequence items, main area rendering selected item details, and save functionality.

Purpose: Establishes the foundational editor layout and state management that all subsequent Phase 22 plans build upon. This is the structural skeleton for AUTH-01 (dedicated template editor).

Output: Working template editor at /templates/new and /templates/:id/edit with sidebar + toolbar + main area, drag-reorder, insert actions, and Supabase save.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-template-foundation-authoring/22-CONTEXT.md
@.planning/phases/22-template-foundation-authoring/22-RESEARCH.md
@src/App.tsx
@src/types/database.ts
@src/stores/session-template-store.ts
@src/lib/session-template-api.ts
@src/components/SequenceManager.tsx
@src/components/SequenceItemCard.tsx
@src/pages/Home.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template editor store, route, and page layout</name>
  <files>
    src/stores/template-editor-store.ts
    src/pages/TemplateEditorPage.tsx
    src/App.tsx
  </files>
  <action>
Create a new Zustand store at `src/stores/template-editor-store.ts` for the template editor. The store manages:

**State:**
- `templateId: string | null` — null for new template, string for editing existing
- `templateName: string` — editable template name (default "Untitled Template")
- `items: EditorItem[]` — the sequence items being edited (each has: id, item_type ('batch'|'slide'), batch data or slide data)
- `selectedItemId: string | null` — currently selected sidebar item
- `isDirty: boolean` — has unsaved changes
- `saving: boolean` — save in progress
- `loading: boolean` — initial load in progress

Define `EditorItem` interface: `{ id: string; item_type: 'batch' | 'slide'; batch?: { name: string; questions: EditorQuestion[] }; slide?: { image_path: string; caption: string | null } }`

Define `EditorQuestion` interface: `{ id: string; text: string; type: VoteType; options: string[] | null; anonymous: boolean; timer_duration: number | null; template_id: string | null }`

**Actions:**
- `setTemplateName(name: string)` — updates name, marks dirty
- `setItems(items: EditorItem[])` — replaces all items
- `addItem(item: EditorItem, afterItemId: string | null)` — inserts after specified item (or at end if null), selects new item, marks dirty
- `removeItem(id: string)` — removes item, selects adjacent, marks dirty
- `reorderItems(fromIndex: number, toIndex: number)` — uses arrayMove, marks dirty
- `updateItem(id: string, updates: Partial<EditorItem>)` — updates item, marks dirty
- `selectItem(id: string | null)` — sets selectedItemId
- `markClean()` — sets isDirty false
- `markDirty()` — sets isDirty true
- `setSaving(saving: boolean)`
- `setLoading(loading: boolean)`
- `reset()` — resets all state to defaults
- `loadFromBlueprint(templateId: string, name: string, blueprint: SessionBlueprint)` — converts blueprint items to EditorItems (generate UUIDs for each item and question), sets state, marks clean
- `toBlueprint(): SessionBlueprint` — converts current EditorItems back to SessionBlueprint format (assigns sequential positions)

For `loadFromBlueprint`, map SessionBlueprintItem to EditorItem: generate crypto.randomUUID() for each item and each question within batches. For `toBlueprint`, map EditorItems back assigning position 0, 1, 2... and questions get positions 0, 1, 2... within each batch.

Create `src/pages/TemplateEditorPage.tsx`:

- Uses `useParams()` to get `:id` parameter (undefined for /templates/new)
- On mount: if id is "new" or undefined, reset store and start fresh. If id exists, fetch the session template from Supabase (`session_templates` table by id), call `loadFromBlueprint`.
- Renders full-height flex column layout:
  - `<EditorToolbar />` at top (full width)
  - Below toolbar: flex row with `<EditorSidebar />` (left, w-72, border-right) and `<EditorMainArea />` (flex-1)
- Add `beforeunload` listener when isDirty to warn about unsaved changes
- Light theme: bg-gray-50 for the page, matching admin styling

Update `src/App.tsx`:
- Add routes: `<Route path="/templates/new" element={<TemplateEditorPage />} />` and `<Route path="/templates/:id/edit" element={<TemplateEditorPage />} />`
- Import TemplateEditorPage (lazy import is fine but not required)

Use nanoid for EditorItem/EditorQuestion IDs (consistent with project, already in dependencies).
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Visit /templates/new in browser — shows empty editor layout with toolbar, sidebar, and main area placeholders.
  </verify>
  <done>
    Template editor store exists with all state and actions. Route /templates/new and /templates/:id/edit render TemplateEditorPage with toolbar + sidebar + main area layout. beforeunload warns on unsaved changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Editor toolbar, sidebar with drag-reorder, and main area</name>
  <files>
    src/components/editor/EditorToolbar.tsx
    src/components/editor/EditorSidebar.tsx
    src/components/editor/SidebarSequenceItem.tsx
    src/components/editor/EditorMainArea.tsx
    src/components/editor/SlideEditor.tsx
  </files>
  <action>
Create `src/components/editor/EditorToolbar.tsx`:

- Full-width toolbar with bg-white border-b border-gray-200 px-4 py-2 flex items-center gap-3
- Left section: Back arrow button (navigates to /) + inline editable template name (click text to edit, Enter/Escape to confirm/cancel, uses `setTemplateName` from store)
- Center section: Insert actions — "Add Batch" button, "Add Slide" button. On click: create new EditorItem with unique id (nanoid), call `addItem(item, selectedItemId)` from store. New batch gets default name "Batch N" (count existing batches + 1), empty questions array. New slide gets empty image_path and null caption.
- Right section: Save button (calls save function — serialize store to blueprint via `toBlueprint()`, then call `saveSessionTemplate` for new or `overwriteSessionTemplate` for existing, using session-template-api). Show "Saving..." while saving, green checkmark briefly on success. If templateId is null (new), after save set templateId in store and update URL with navigate(`/templates/${newId}/edit`, { replace: true }). Disabled when !isDirty.
- Right section also: Edit/Preview toggle placeholder (just a segmented control with Edit/Preview labels — Preview mode handled in Plan 03, for now Preview shows alert or is disabled)
- Also add an "Upload Image" button next to "Add Slide" that triggers a hidden file input. On file select, compress with browser-image-compression (same pattern as ImageUploader.tsx), upload to Supabase storage using `uploadSlideImage`, then create a new slide EditorItem with the returned image_path. This enables inserting image slides directly from the toolbar.

Create `src/components/editor/EditorSidebar.tsx`:

- w-72 flex-shrink-0 bg-white border-r border-gray-200 overflow-y-auto p-3 space-y-1
- Uses DndContext + SortableContext from @dnd-kit (same pattern as SequenceManager.tsx) for drag reorder of items
- PointerSensor with distance: 8 activation constraint
- On drag end: call `reorderItems(oldIndex, newIndex)` on store
- Renders list of `<SidebarSequenceItem>` for each item in store
- Empty state: centered message "Add a batch or slide to get started" with "Add Batch" and "Add Slide" buttons that mirror toolbar insert actions
- Selected item highlighted with bg-indigo-50 border-indigo-300

Create `src/components/editor/SidebarSequenceItem.tsx`:

- Uses `useSortable` hook (same pattern as SequenceItemCard.tsx)
- Layout: drag handle (grip dots icon) + type icon (list icon for batch, image icon for slide) + content
- For batch: show batch name + "{N} questions" subtitle
- For slide: show small thumbnail (w-10 h-8 rounded, object-cover) if image_path exists, else placeholder icon + caption or "Untitled Slide"
- Click handler: call `selectItem(id)` on store
- Visual: selected state shows bg-indigo-50 with left border accent. Normal state shows bg-white hover:bg-gray-50.
- Delete button (small X icon) on hover, calls `removeItem(id)` on store

Create `src/components/editor/EditorMainArea.tsx`:

- flex-1 overflow-y-auto p-6 bg-gray-50
- Reads `selectedItemId` and `items` from store
- If no item selected: show centered guidance text "Select an item from the sidebar, or add a new batch or slide" with large "Add Batch" and "Add Slide" buttons
- If selected item is batch: render `<BatchEditor>` (placeholder div for now with batch name and "Questions will be edited here" — Plan 02 builds the real BatchEditor)
- If selected item is slide: render `<SlideEditor>`

Create `src/components/editor/SlideEditor.tsx`:

- Shows the slide image (full-width, max-height 400px, object-contain) from Supabase storage URL using `getSlideImageUrl()`
- If no image: show upload zone (dashed border area, click to upload). Use same compression + upload pattern as toolbar image upload.
- Caption input below image (text input, updates store via `updateItem`)
- "Change Image" button to replace image (same upload flow)
- Image click shows lightbox placeholder (actual lightbox in Plan 03)
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Visit /templates/new — can add batches and slides via toolbar, see them in sidebar, drag to reorder, select to view in main area. Save creates a new session_template in Supabase.
  </verify>
  <done>
    Toolbar has back arrow, inline editable name, Add Batch/Slide/Upload Image buttons, save button, and edit/preview toggle placeholder. Sidebar shows draggable sequence items with type icons and summaries. Main area shows selected item details. SlideEditor handles image upload and caption. Save persists template to Supabase.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Navigate to /templates/new — editor loads with empty state
3. Click "Add Batch" — batch appears in sidebar, selected, main area shows batch placeholder
4. Click "Add Slide" — slide appears in sidebar after selected item
5. Drag items in sidebar — order updates
6. Edit template name in toolbar — name updates
7. Click Save — template saved to Supabase, URL updates to /templates/:id/edit
8. Navigate to /templates/:id/edit — template loads from Supabase with items in sidebar
9. Close tab with unsaved changes — browser warns
</verification>

<success_criteria>
- Template editor route works at /templates/new and /templates/:id/edit
- Toolbar, sidebar, and main area render correctly in full-page layout
- Sequence items can be added, reordered via drag-and-drop, and deleted
- Template name is editable inline in toolbar
- Save persists template blueprint to Supabase session_templates table
- Unsaved changes trigger beforeunload warning
</success_criteria>

<output>
After completion, create `.planning/phases/22-template-foundation-authoring/22-01-SUMMARY.md`
</output>

---
phase: 03-join-flow-and-voting-mechanics
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/QRCode.tsx
  - src/components/AdminQuestionControl.tsx
  - src/components/SessionResults.tsx
  - src/pages/AdminSession.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees a QR code in the bottom-right corner that participants can scan to join"
    - "Admin can toggle QR code visibility on and off"
    - "Admin can activate a question for voting (status changes to active)"
    - "Activating a question automatically closes any previously active question"
    - "Admin can close voting on a question and see aggregated results"
    - "Admin sees vote count progress during an active question"
    - "Admin can transition session through draft -> lobby -> active -> ended states"
    - "Admin can toggle between live vote breakdown and simple count view"
    - "Session results show aggregated votes for all closed/revealed questions"
    - "Admin can configure per-question anonymous/named voting"
  artifacts:
    - path: "src/components/QRCode.tsx"
      provides: "Fixed-position toggleable QR code for participant join URL"
      exports: ["SessionQRCode"]
    - path: "src/components/AdminQuestionControl.tsx"
      provides: "Question activation, vote progress, and close voting controls"
      min_lines: 60
    - path: "src/components/SessionResults.tsx"
      provides: "Aggregated vote results for all questions in a session"
      min_lines: 40
    - path: "src/pages/AdminSession.tsx"
      provides: "Extended admin page with session state controls, QR code, and question activation"
      min_lines: 100
  key_links:
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/QRCode.tsx"
      via: "renders QR code with participant URL"
      pattern: "<SessionQRCode"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/AdminQuestionControl.tsx"
      via: "renders per-question activation controls"
      pattern: "<AdminQuestionControl"
    - from: "src/components/AdminQuestionControl.tsx"
      to: "supabase.from('questions').update"
      via: "question status transitions (pending->active->closed)"
      pattern: "\\.update.*status"
    - from: "src/components/AdminQuestionControl.tsx"
      to: "src/lib/vote-aggregation.ts"
      via: "aggregate votes when closing a question"
      pattern: "aggregateVotes"
    - from: "src/components/SessionResults.tsx"
      to: "src/lib/vote-aggregation.ts"
      via: "aggregate votes for all questions in results view"
      pattern: "aggregateVotes"
---

<objective>
Build the admin-side controls for running a voting session: QR code display, session state management (draft/lobby/active/ended), question activation and close voting, vote count progress, anonymous/named toggle, and the SessionResults component for aggregated vote display.

Purpose: The admin controls are what drive the participant experience -- activating questions, closing voting, and revealing results. This completes the admin side of the vote lifecycle and satisfies JOIN-01 (QR code), VOTE-04 (anonymous/named config), and the admin-facing parts of the overall voting flow.

Output: 3 new components + 1 significantly modified page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-join-flow-and-voting-mechanics/03-RESEARCH.md
@.planning/phases/03-join-flow-and-voting-mechanics/03-CONTEXT.md
@.planning/phases/03-join-flow-and-voting-mechanics/03-01-SUMMARY.md
@src/types/database.ts
@src/stores/session-store.ts
@src/lib/vote-aggregation.ts
@src/lib/supabase.ts
@src/pages/AdminSession.tsx
@src/components/QuestionList.tsx
@src/components/QuestionForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build QRCode, AdminQuestionControl, and SessionResults components</name>
  <files>
    src/components/QRCode.tsx
    src/components/AdminQuestionControl.tsx
    src/components/SessionResults.tsx
  </files>
  <action>
    **QRCode component** (`src/components/QRCode.tsx`):
    - Import `{ QRCodeSVG }` from `'qrcode.react'` (named export, NOT default import).
    - Export named component `SessionQRCode`.
    - Props: `{ url: string; visible: boolean }`.
    - If not visible, return null.
    - Render a fixed-position container: `fixed bottom-4 right-4 bg-white p-3 rounded-xl shadow-lg z-50`.
    - Inside: `<QRCodeSVG value={url} size={120} level="M" marginSize={1} />`.
    - Below QR code: small "Scan to join" text (`text-xs text-gray-600 text-center mt-1 font-medium`).
    - Do NOT use deprecated `includeMargin` prop -- use `marginSize` instead.

    **AdminQuestionControl component** (`src/components/AdminQuestionControl.tsx`):
    - Props: `{ question: Question; sessionId: string; isActive: boolean; isClosed: boolean }`.
    - Import `supabase`, `useSessionStore`, `aggregateVotes`, and `VoteCount` from vote-aggregation.
    - This component replaces/augments the simple question display in the admin list with activation controls.

    States and controls based on question status:
    - **pending**: Show a "Start" button. Clicking it:
      1. Close any currently active questions for this session: `supabase.from('questions').update({ status: 'closed' }).eq('session_id', sessionId).eq('status', 'active')`.
      2. Set this question to active: `supabase.from('questions').update({ status: 'active' }).eq('id', question.id)`.
      3. Update question in Zustand store.
    - **active**: Show vote count progress and a "Close Voting" button.
      - Fetch votes for this question: `supabase.from('votes').select('value, locked_in').eq('question_id', question.id)`.
      - Display toggleable view (local state boolean `showBreakdown`):
        - Simple count mode: "X votes cast" (total count).
        - Breakdown mode: Show aggregated vote counts per option using `aggregateVotes()`.
      - Toggle button: "Show breakdown" / "Show count".
      - Clicking "Close Voting":
        1. Update question status to 'closed': `supabase.from('questions').update({ status: 'closed' }).eq('id', question.id)`.
        2. Update store.
        3. Automatically show results (vote breakdown) for this question.
    - **closed/revealed**: Show aggregated results (always in breakdown mode).
      - Fetch votes and display using `aggregateVotes()`.
      - Show bar-style display: option name, count, percentage bar (Tailwind width percentage via inline style).
      - Each bar shows: `value | count | percentage%` with a colored background bar.

    Anonymous/named display:
    - Show a small badge indicating whether the question is anonymous or named.
    - For named questions with closed status, include voter names (display_name from votes) next to their choices if available.

    Vote progress polling for active questions:
    - When question is active, poll votes every 3 seconds to update the count display.
    - Use `useEffect` with `setInterval` and cleanup.
    - Stop polling when question is no longer active.

    **SessionResults component** (`src/components/SessionResults.tsx`):
    - Props: `{ sessionId: string }`.
    - Fetches all questions for the session: `supabase.from('questions').select('*').eq('session_id', sessionId).order('position')`.
    - For each question, fetches votes: `supabase.from('votes').select('*').eq('question_id', question.id)`.
    - Uses `aggregateVotes()` to compute results per question.
    - Renders a scrollable list of question result cards:
      - Question number and text.
      - Vote type badge (agree/disagree or multiple choice).
      - Bar chart results (same bar style as AdminQuestionControl closed state).
      - Total vote count.
    - Shows "Session Results" header at top.
    - Loading state while fetching.
    - Dark theme consistent with app (bg-gray-900 cards on bg-gray-950 background).
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - `npm run build` succeeds.
    - All three component files exist and export correctly.
  </verify>
  <done>
    - QRCode renders SVG QR code at fixed position with toggleable visibility
    - AdminQuestionControl handles pending/active/closed states with appropriate controls
    - AdminQuestionControl shows vote progress (count or breakdown) for active questions
    - AdminQuestionControl closes any active question before activating a new one
    - SessionResults shows aggregated results for all questions in a session
    - All components TypeScript clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend AdminSession page with session controls, QR code, and question activation</name>
  <files>
    src/pages/AdminSession.tsx
  </files>
  <action>
    Extend `src/pages/AdminSession.tsx` significantly. Keep existing functionality (session load, question list, question form, participant link) but add session state management and question activation controls.

    **New imports:** SessionQRCode, AdminQuestionControl, SessionResults.

    **Session state controls (new section above questions):**
    Add a session control bar with buttons that transition the session state:
    - **draft status**: Show "Start Session" button (transitions to 'lobby').
      - `supabase.from('sessions').update({ status: 'lobby' }).eq('session_id', session.session_id)`.
      - Update session in store.
    - **lobby status**: Show "Begin Voting" button (transitions to 'active').
      - The admin should then activate a question using AdminQuestionControl.
      - `supabase.from('sessions').update({ status: 'active' }).eq('session_id', session.session_id)`.
      - Update session in store.
    - **active status**: Show "End Session" button (transitions to 'ended').
      - Also close any active questions: `supabase.from('questions').update({ status: 'closed' }).eq('session_id', session.session_id).eq('status', 'active')`.
      - `supabase.from('sessions').update({ status: 'ended' }).eq('session_id', session.session_id)`.
      - Update session and questions in store.
    - **ended status**: Show "Session Ended" label (no more transitions). Optionally show SessionResults inline.

    **QR code integration:**
    - Add local state `showQR: boolean` (default true when session is lobby or active).
    - Render `<SessionQRCode url={participantUrl} visible={showQR} />`.
    - Add a small toggle button near the session header: "Hide QR" / "Show QR".

    **Question list with activation controls:**
    - When session is in 'lobby' or 'active' state, replace or augment the QuestionList with AdminQuestionControl per question.
    - In draft state, keep the existing QuestionList with edit/delete/reorder controls (question management).
    - In lobby/active state, show each question with its AdminQuestionControl (activation/voting controls). Also keep the question text and type badge visible.
    - The QuestionForm (add/edit) should only be available in draft state. In lobby/active/ended states, question management is disabled (the session is live).

    **Anonymous/named toggle:**
    - In draft state, add a small toggle next to each question in the QuestionList (or in the QuestionForm) to set `question.anonymous` (true/false).
    - Persist via `supabase.from('questions').update({ anonymous }).eq('id', question.id)`.
    - Update in store.
    - Default is true (anonymous). Show small icon/badge: lock icon for anonymous, eye icon for named.

    **Admin results view:**
    - When session status is 'ended', render `<SessionResults sessionId={session.session_id} />` in place of the question controls.

    **Session control polling:**
    - When session is active, poll questions every 3 seconds to keep the question list status up-to-date (in case of external changes or to sync with AdminQuestionControl).
    - Fetch questions with: `supabase.from('questions').select('*').eq('session_id', session.session_id).order('position')`.
    - Update store via `setQuestions`.

    **Layout considerations:**
    - Admin screen is the presentation screen (projected). Consider readability at distance.
    - Session title and status should be large and prominent.
    - Session control buttons should be visually distinct and large enough to click from a distance.
    - Keep the max-w-2xl container for question management in draft state but consider wider layout during active voting (the admin is showing this screen to the room).

    **Important constraints:**
    - Keep existing session load logic (admin_token lookup, cancelled flag pattern, etc.).
    - Keep existing participant link copy functionality.
    - The QuestionForm and QuestionList components from Phase 2 remain unchanged -- do not modify those files. Just conditionally show/hide them based on session state.
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - `npm run build` succeeds.
    - Open `/admin/{adminToken}` for a draft session -> sees question management + "Start Session" button.
    - Click "Start Session" -> session transitions to lobby, QR code visible.
    - Click "Begin Voting" -> session transitions to active, question activation controls appear.
  </verify>
  <done>
    - Admin can transition session through draft -> lobby -> active -> ended
    - QR code displayed and toggleable during lobby/active (JOIN-01)
    - Questions show activation controls (Start/Close Voting) during active session
    - Vote count/breakdown visible during active voting
    - Anonymous/named toggle available per question in draft state (VOTE-04)
    - Session results shown when session ends
    - Question management (add/edit/delete/reorder) only in draft state
    - Existing functionality preserved (session load, participant link copy)
    - TypeScript clean, build passes
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- `npx tsc --noEmit` passes
- Admin can create session (draft), start it (lobby), begin voting (active), end it (ended)
- QR code appears with correct participant URL and can be toggled
- Admin can activate a question -> it becomes active, previous active question auto-closes
- Admin sees vote count during active question
- Admin can close voting and see aggregated results
- Admin can toggle between vote count and breakdown view
- Anonymous/named badge visible per question
- Session results display all question results when session ended
- Existing question CRUD still works in draft state
</verification>

<success_criteria>
- JOIN-01: QR code displayed that participants can scan to join (SessionQRCode component)
- VOTE-04: Anonymous/named voting configurable per question (toggle in draft state)
- Admin session state machine: draft -> lobby -> active -> ended transitions work
- Question activation: one at a time, auto-closes previous
- Vote progress visible to admin during active voting
- Session results: aggregated bar chart display for all questions
- All existing Phase 2 admin functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-join-flow-and-voting-mechanics/03-03-SUMMARY.md`
</output>

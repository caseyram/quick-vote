---
phase: 03-join-flow-and-voting-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-double-tap.ts
  - src/hooks/use-haptic.ts
  - src/lib/vote-aggregation.ts
  - src/types/database.ts
  - src/stores/session-store.ts
  - .planning/phases/03-join-flow-and-voting-mechanics/moddatetime-trigger.sql
autonomous: true

must_haves:
  truths:
    - "useDoubleTap hook distinguishes single tap (select) from double tap on same option (lock-in)"
    - "useHaptic hook triggers vibration on supported devices and silently no-ops on unsupported ones"
    - "aggregateVotes transforms a Vote[] array into VoteCount[] with value, count, and percentage"
    - "Zustand store holds currentVote, questionVotes, and submitting state for the participant voting flow"
    - "VoteCount type is exported from database.ts for use in results display"
  artifacts:
    - path: "src/hooks/use-double-tap.ts"
      provides: "Double-tap detection hook with 400ms threshold"
      exports: ["useDoubleTap"]
    - path: "src/hooks/use-haptic.ts"
      provides: "Haptic feedback hook with tap and confirm patterns"
      exports: ["useHaptic"]
    - path: "src/lib/vote-aggregation.ts"
      provides: "Client-side vote counting utility"
      exports: ["aggregateVotes", "VoteCount"]
    - path: "src/types/database.ts"
      provides: "Extended types including VoteCount and ActiveQuestion helper"
    - path: "src/stores/session-store.ts"
      provides: "Extended Zustand store with voting state slice"
  key_links:
    - from: "src/hooks/use-double-tap.ts"
      to: "voting components (Plan 02)"
      via: "hook import"
      pattern: "useDoubleTap"
    - from: "src/stores/session-store.ts"
      to: "ParticipantSession (Plan 02)"
      via: "store subscription"
      pattern: "currentVote|questionVotes|submitting"
---

<objective>
Install qrcode.react dependency, create utility hooks (useDoubleTap, useHaptic), build the vote-aggregation helper, extend TypeScript types, extend the Zustand store with voting state, and produce the moddatetime trigger SQL for the votes table.

Purpose: All Phase 3 plans depend on these shared hooks, utilities, types, and store extensions. Building them first in isolation prevents duplication and ensures consistent patterns across the participant voting UI and admin controls.

Output: 5 new/modified source files + 1 SQL file + qrcode.react installed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-join-flow-and-voting-mechanics/03-RESEARCH.md
@src/types/database.ts
@src/stores/session-store.ts
@src/hooks/use-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode.react and create utility hooks + vote aggregation</name>
  <files>
    src/hooks/use-double-tap.ts
    src/hooks/use-haptic.ts
    src/lib/vote-aggregation.ts
  </files>
  <action>
    1. Install qrcode.react:
       ```
       npm install qrcode.react
       ```

    2. Create `src/hooks/use-double-tap.ts`:
       - Export `useDoubleTap(onSingleTap: (value: string) => void, onDoubleTap: (value: string) => void)` that returns a `handleTap(value: string)` callback.
       - Use `useRef` to track `{ value: string; time: number } | null` for the last tap.
       - 400ms threshold (forgiving for mobile).
       - Double-tap only fires if the SAME value is tapped twice within the threshold. Tapping Option A then Option B is a selection change, not lock-in.
       - Reset `lastTapRef.current` to null after double-tap fires.
       - Wrap `handleTap` in `useCallback` with `[onSingleTap, onDoubleTap]` deps.

    3. Create `src/hooks/use-haptic.ts`:
       - Export `useHaptic()` returning `{ tap: () => void, confirm: () => void }`.
       - Check `typeof navigator !== 'undefined' && 'vibrate' in navigator` once at hook init.
       - `tap()`: `navigator.vibrate(30)` -- short selection feedback.
       - `confirm()`: `navigator.vibrate([40, 30, 40])` -- distinct lock-in pattern.
       - Both silently no-op if vibration is not supported (iOS Safari, desktop).

    4. Create `src/lib/vote-aggregation.ts`:
       - Import `Vote` type from `../types/database`.
       - Export `VoteCount` interface: `{ value: string; count: number; percentage: number }`.
       - Export `aggregateVotes(votes: Vote[]): VoteCount[]` that uses `Array.reduce()` to count votes by value, then maps to VoteCount[] with percentage = `Math.round((count / total) * 100)`. Handle total=0 edge case (percentage = 0).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors.
    - `npm run build` succeeds.
    - All three files exist and export the expected functions.
  </verify>
  <done>
    - useDoubleTap hook exported and TypeScript clean
    - useHaptic hook exported and TypeScript clean
    - aggregateVotes + VoteCount exported and TypeScript clean
    - qrcode.react appears in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend types, extend Zustand store, create moddatetime trigger SQL</name>
  <files>
    src/types/database.ts
    src/stores/session-store.ts
    .planning/phases/03-join-flow-and-voting-mechanics/moddatetime-trigger.sql
  </files>
  <action>
    1. Extend `src/types/database.ts`:
       - Keep ALL existing types unchanged.
       - The `VoteCount` type is already in `vote-aggregation.ts`. No need to duplicate it here.
       - No new types needed in database.ts -- the existing Session, Question, Vote, VoteType, SessionStatus, QuestionStatus types already cover all Phase 3 needs.

    2. Extend `src/stores/session-store.ts`:
       - Keep ALL existing SessionState interface fields and implementations unchanged.
       - Add voting-related state to the same interface:
         ```
         currentVote: Vote | null;       // participant's vote on the active question
         questionVotes: Vote[];           // all votes for active question (admin aggregation)
         submitting: boolean;             // vote submission in progress

         setCurrentVote: (vote: Vote | null) => void;
         setQuestionVotes: (votes: Vote[]) => void;
         setSubmitting: (submitting: boolean) => void;
         ```
       - Import `Vote` from `../types/database` (add to existing import).
       - Update the `create<SessionState>()` call to include the new state fields and setters.
       - Update `reset()` to also reset: `currentVote: null, questionVotes: [], submitting: false`.
       - The store creation still uses `create<SessionState>()(...)` with the double-parentheses pattern.

    3. Create `.planning/phases/03-join-flow-and-voting-mechanics/moddatetime-trigger.sql`:
       - This SQL file is for the user to run in the Supabase SQL Editor during setup.
       - Contents:
         ```sql
         -- Enable moddatetime extension for auto-updating timestamps
         CREATE EXTENSION IF NOT EXISTS moddatetime SCHEMA extensions;

         -- Auto-update updated_at on vote changes (upsert conflict updates)
         CREATE TRIGGER handle_votes_updated_at
           BEFORE UPDATE ON votes
           FOR EACH ROW
           EXECUTE PROCEDURE moddatetime(updated_at);
         ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors.
    - `npm run build` succeeds.
    - The Zustand store still exports `useSessionStore` with all original methods (setSession, setQuestions, addQuestion, updateQuestion, removeQuestion, reorderQuestions, setLoading, setError, reset) PLUS new ones (setCurrentVote, setQuestionVotes, setSubmitting).
    - The moddatetime SQL file exists at the specified path.
  </verify>
  <done>
    - Zustand store extended with currentVote, questionVotes, submitting state and setters
    - reset() clears voting state alongside session state
    - moddatetime trigger SQL ready for user to run
    - All existing store functionality preserved (no regressions)
    - TypeScript clean, build passes
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- `npx tsc --noEmit` passes
- qrcode.react in package.json dependencies
- All 5 source files exist and export correctly
- Moddatetime trigger SQL file exists
- Existing app behavior unchanged (Home, AdminSession, ParticipantSession pages still work)
</verification>

<success_criteria>
- qrcode.react installed
- useDoubleTap hook: single-tap calls onSingleTap, double-tap on same value calls onDoubleTap, different value resets
- useHaptic hook: tap() and confirm() work on supported devices, no-op on unsupported
- aggregateVotes: correctly counts votes and calculates percentages
- Zustand store: extended with voting state, reset clears all state
- Moddatetime SQL file ready for manual execution
- Zero TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-join-flow-and-voting-mechanics/03-01-SUMMARY.md`
</output>

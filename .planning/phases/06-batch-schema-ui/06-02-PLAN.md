---
phase: 06-batch-schema-ui
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - package.json
  - src/components/BatchCard.tsx
  - src/components/BatchList.tsx
  - src/components/BatchQuestionItem.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see batches as expandable cards in the question list area"
    - "Only one batch can be expanded at a time (accordion behavior)"
    - "Questions within a batch can be dragged to reorder"
    - "Unbatched questions appear interleaved with batch cards by creation order"
  artifacts:
    - path: "src/components/BatchCard.tsx"
      provides: "Expandable batch card with accordion behavior"
      exports: ["BatchCard"]
      min_lines: 50
    - path: "src/components/BatchList.tsx"
      provides: "Container for batches and unbatched questions"
      exports: ["BatchList"]
      min_lines: 40
    - path: "src/components/BatchQuestionItem.tsx"
      provides: "Draggable question item within batch"
      exports: ["BatchQuestionItem"]
      min_lines: 30
  key_links:
    - from: "src/components/BatchList.tsx"
      to: "src/components/BatchCard.tsx"
      via: "renders BatchCard for each batch"
      pattern: "<BatchCard"
    - from: "src/components/BatchCard.tsx"
      to: "@dnd-kit/sortable"
      via: "uses SortableContext for question reordering"
      pattern: "SortableContext"
---

<objective>
Build the batch UI components with accordion behavior and drag-and-drop reordering.

Purpose: Create the visual building blocks for batch management. These components handle display, expansion, and in-batch reordering - but do NOT handle Supabase persistence (that's Plan 03).

Output: BatchCard, BatchList, and BatchQuestionItem components ready for integration.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-batch-schema-ui/06-CONTEXT.md
@.planning/phases/06-batch-schema-ui/06-RESEARCH.md
@.planning/phases/06-batch-schema-ui/06-01-SUMMARY.md
@src/types/database.ts
@src/stores/session-store.ts
@src/components/QuestionList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit dependencies</name>
  <files>package.json</files>
  <action>
Install dnd-kit packages for drag-and-drop functionality:

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

These provide:
- `@dnd-kit/core`: Core drag-and-drop primitives (DndContext, sensors)
- `@dnd-kit/sortable`: Sortable list preset (SortableContext, useSortable, arrayMove)
- `@dnd-kit/utilities`: CSS transform helpers

Do NOT install react-collapsed or any animation libraries - use CSS transitions for collapse/expand.
  </action>
  <verify>
Run `npm install` completes without errors.
Check package.json includes @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities in dependencies.
  </verify>
  <done>
dnd-kit packages installed and available for import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatchQuestionItem component</name>
  <files>src/components/BatchQuestionItem.tsx</files>
  <action>
Create a draggable question item component for use within batches.

Props:
- `question: Question` - the question to display
- `index: number` - position in list (for numbering display)
- `onEdit: (question: Question) => void` - callback when edit clicked
- `onDelete: (question: Question) => void` - callback when delete clicked

Implementation:
1. Use `useSortable` hook from @dnd-kit/sortable with question.id as the sortable id
2. Apply transform and transition styles from useSortable
3. Create a drag handle element that receives {...listeners} - use a grip icon (three horizontal lines)
4. Display question number, type badge, text, and options (if multiple choice)
5. Show Edit and Delete buttons (similar to existing QuestionList item styling)
6. Match the existing dark theme styling from QuestionList.tsx (bg-gray-800, border-gray-700, etc.)

Important: Apply {...listeners} ONLY to the drag handle element, NOT the entire card. This allows clicking Edit/Delete without triggering drag.

Use CSS.Transform.toString(transform) from @dnd-kit/utilities for the style.
  </action>
  <verify>
TypeScript compiles: `npm run build` or `npx tsc --noEmit`
Component renders without errors when imported.
  </verify>
  <done>
BatchQuestionItem component renders question with drag handle, type badge, text, and action buttons. Draggable via handle only.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BatchCard component</name>
  <files>src/components/BatchCard.tsx</files>
  <action>
Create an expandable batch card component with accordion behavior.

Props:
- `batch: Batch` - the batch data
- `questions: Question[]` - questions belonging to this batch (filtered by batch_id)
- `isExpanded: boolean` - whether this batch is currently expanded
- `onToggle: () => void` - callback to toggle expansion
- `onNameChange: (name: string) => void` - callback when batch name edited
- `onQuestionReorder: (questionIds: string[]) => void` - callback with new question order
- `onEditQuestion: (question: Question) => void` - callback to edit a question
- `onDeleteQuestion: (question: Question) => void` - callback to delete a question
- `onAddQuestion: () => void` - callback when "+ Add Question" clicked

Implementation:
1. Card header (always visible):
   - Click to toggle expansion (onToggle)
   - Editable batch name (click to edit inline, blur/enter to save via onNameChange)
   - Question count badge (e.g., "3 questions")
   - Chevron icon indicating expanded/collapsed state
   - When collapsed: show truncated preview of first 2-3 question texts (CSS line-clamp)

2. Card body (only when expanded):
   - Wrap questions in DndContext and SortableContext from @dnd-kit
   - Use PointerSensor and KeyboardSensor from @dnd-kit/core
   - Use verticalListSortingStrategy from @dnd-kit/sortable
   - Render BatchQuestionItem for each question
   - Handle onDragEnd: use arrayMove to reorder, call onQuestionReorder with new id order
   - "+ Add Question" button at bottom of question list

3. Styling:
   - Card: bg-gray-800 border border-gray-700 rounded-lg
   - Expand/collapse with CSS transition (max-height or conditional render)
   - Match admin theme (dark background, light text)

Empty state: When batch has no questions, show "No questions yet" message and "+ Add Question" button.
  </action>
  <verify>
TypeScript compiles: `npm run build` or `npx tsc --noEmit`
Component renders, expands/collapses, and drag-drop works within the component.
  </verify>
  <done>
BatchCard expands/collapses, shows batch name (editable inline), displays questions with drag-and-drop reordering, has "+ Add Question" button.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create BatchList component</name>
  <files>src/components/BatchList.tsx</files>
  <action>
Create a container component that renders batches and unbatched questions interleaved.

Props:
- `batches: Batch[]` - all batches for the session
- `questions: Question[]` - all questions for the session
- `onEditQuestion: (question: Question) => void` - callback to edit a question
- `onDeleteQuestion: (question: Question) => void` - callback to delete a question
- `onBatchNameChange: (batchId: string, name: string) => void` - callback for batch rename
- `onQuestionReorder: (batchId: string, questionIds: string[]) => void` - callback for reorder within batch
- `onAddQuestionToBatch: (batchId: string) => void` - callback when "+ Add Question" in batch clicked
- `onCreateBatch: () => void` - callback when "+ New Batch" clicked

Implementation:
1. Accordion state: `const [expandedBatchId, setExpandedBatchId] = useState<string | null>(null)`

2. Merge batches and unbatched questions into a unified list sorted by created_at:
   - Each batch becomes an item with type: 'batch'
   - Each unbatched question (batch_id === null) becomes an item with type: 'question'
   - Sort all items by created_at ascending (oldest first)

3. Render interleaved list:
   - For batch items: render BatchCard with isExpanded={expandedBatchId === batch.id}
   - For question items: render individual question display (simple card, not draggable - unbatched questions use existing reorder buttons)

4. "+ New Batch" button at the top or bottom of the list (calls onCreateBatch)

5. Empty state: If no batches and no questions, show helpful message.

Styling:
- Container with space-y-3 for vertical spacing
- Subtle visual differentiation between batch cards and standalone questions (e.g., batch cards have slight indent or border accent)
  </action>
  <verify>
TypeScript compiles: `npm run build` or `npx tsc --noEmit`
Component renders interleaved list with proper accordion behavior (one expanded at a time).
  </verify>
  <done>
BatchList renders batches and unbatched questions interleaved by creation order. Accordion state ensures only one batch expanded at a time. "+ New Batch" button visible.
  </done>
</task>

</tasks>

<verification>
1. `npm install` succeeds with dnd-kit packages
2. `npm run build` succeeds (all components compile)
3. BatchQuestionItem has drag handle that works independently from Edit/Delete buttons
4. BatchCard expands/collapses and shows/hides questions
5. BatchCard allows inline batch name editing
6. Drag-and-drop reorders questions within a batch (calls onQuestionReorder callback)
7. BatchList shows batches and unbatched questions in creation order
8. Only one batch can be expanded at a time
</verification>

<success_criteria>
- dnd-kit packages installed and importable
- BatchQuestionItem renders draggable question with handle
- BatchCard has accordion expand/collapse behavior
- BatchCard allows inline batch name editing
- Drag-and-drop reorders questions within expanded batch
- BatchList interleaves batches and unbatched questions by creation order
- All components match existing dark theme styling
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-schema-ui/06-02-SUMMARY.md`
</output>

---
phase: 06-batch-schema-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260128_add_batches.sql
  - src/types/database.ts
  - src/stores/session-store.ts
autonomous: true

must_haves:
  truths:
    - "Batches table exists in database with id, session_id, name, position, created_at columns"
    - "Questions table has nullable batch_id foreign key column"
    - "TypeScript Batch type is defined and exported"
    - "Session store has batches array and batch CRUD methods"
  artifacts:
    - path: "supabase/migrations/20260128_add_batches.sql"
      provides: "Database schema for batches"
      contains: "CREATE TABLE batches"
    - path: "src/types/database.ts"
      provides: "Batch type definition"
      exports: ["Batch"]
    - path: "src/stores/session-store.ts"
      provides: "Batch state management"
      contains: "batches:"
  key_links:
    - from: "src/types/database.ts"
      to: "src/stores/session-store.ts"
      via: "Batch type import"
      pattern: "import.*Batch.*from.*database"
---

<objective>
Create the database schema and TypeScript infrastructure for batches.

Purpose: Establish the data foundation that batch UI components will use. This must complete before any UI work can begin since components need types and store methods.

Output: Migration file, updated types, and store with batch state management.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-batch-schema-ui/06-CONTEXT.md
@.planning/phases/06-batch-schema-ui/06-RESEARCH.md
@src/types/database.ts
@src/stores/session-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batches table migration</name>
  <files>supabase/migrations/20260128_add_batches.sql</files>
  <action>
Create a SQL migration file that:

1. Creates the `batches` table:
   - `id` UUID PRIMARY KEY with gen_random_uuid() default
   - `session_id` TEXT NOT NULL with foreign key to sessions(session_id) ON DELETE CASCADE
   - `name` TEXT NOT NULL DEFAULT 'Untitled Batch'
   - `position` INTEGER NOT NULL DEFAULT 0
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()

2. Adds `batch_id` column to `questions` table:
   - UUID type, nullable (preserves unbatched questions for v1.0 compatibility)
   - Foreign key to batches(id) ON DELETE SET NULL (non-destructive: deleting batch unbatches questions)

3. Creates indexes (critical - PostgreSQL does NOT auto-index FKs):
   - `idx_questions_batch_id` on questions(batch_id)
   - `idx_batches_session_id` on batches(session_id)

4. Enables Row Level Security (RLS) on batches table with permissive policy (matches existing pattern)

Reference existing migrations in supabase/migrations/ for style consistency.
  </action>
  <verify>
Run `npx supabase db push` or verify migration syntax is valid SQL.
Check that migration file exists and contains CREATE TABLE batches, ALTER TABLE questions, and CREATE INDEX statements.
  </verify>
  <done>
Migration file creates batches table, adds batch_id to questions with proper FK constraints and indexes, enables RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Batch type to database types</name>
  <files>src/types/database.ts</files>
  <action>
Add the Batch interface to src/types/database.ts:

```typescript
export interface Batch {
  id: string;
  session_id: string;
  name: string;
  position: number;
  created_at: string;
}
```

Update the Question interface to add the optional batch_id field:

```typescript
export interface Question {
  // ... existing fields ...
  batch_id: string | null;  // Add this field
}
```

Keep existing types (VoteType, SessionStatus, QuestionStatus, Session, Vote) unchanged.
  </action>
  <verify>
TypeScript compiles without errors: `npm run build` or `npx tsc --noEmit`
  </verify>
  <done>
Batch type exported, Question type has nullable batch_id field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add batch state to session store</name>
  <files>src/stores/session-store.ts</files>
  <action>
Extend the session store with batch state and methods. Add to SessionState interface:

State:
- `batches: Batch[]` - array of batches for the session

Actions:
- `setBatches: (batches: Batch[]) => void` - set all batches (sorted by position)
- `addBatch: (batch: Batch) => void` - add a new batch
- `updateBatch: (id: string, updates: Partial<Batch>) => void` - update batch properties
- `removeBatch: (id: string) => void` - remove a batch from state

Implementation notes:
- Import `Batch` type from '../types/database'
- `setBatches` should sort batches by position (like setQuestions does)
- `addBatch` should add to array and re-sort by position
- `updateBatch` uses standard map pattern like existing updateQuestion
- `removeBatch` uses filter pattern like existing removeQuestion
- Add `batches: []` to initial state and reset()
- No nesting needed - batches array is flat, questions reference batch_id
  </action>
  <verify>
TypeScript compiles without errors: `npm run build` or `npx tsc --noEmit`
Existing tests pass: `npm test -- src/stores/session-store.test.ts`
  </verify>
  <done>
Session store has batches state with setBatches, addBatch, updateBatch, removeBatch methods. Reset clears batches.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260128_add_batches.sql
2. `npm run build` succeeds (TypeScript types are valid)
3. `npm test -- src/stores/session-store.test.ts` passes (existing store tests work)
4. Batch type is exported from src/types/database.ts
5. Question type includes batch_id: string | null
6. Session store has batches array and all four batch methods
</verification>

<success_criteria>
- Database migration creates batches table with all required columns
- Questions table has nullable batch_id column with ON DELETE SET NULL
- Foreign key indexes are created for query performance
- Batch TypeScript type matches database schema
- Question type updated with batch_id field
- Session store manages batch state with CRUD methods
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-schema-ui/06-01-SUMMARY.md`
</output>

---
phase: 20-session-templates
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/components/SessionTemplatePanel.tsx
  - src/pages/AdminSession.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can open a template panel sidebar within the session editing screen"
    - "Admin can save the current session as a named template with inline success state on the save button"
    - "Admin can see a list of saved templates showing name, last modified date, and item count"
    - "Admin can load a template into the current session with replace/append prompt and summary preview"
    - "Admin is warned if loaded template has missing response template references"
    - "Admin can rename a template inline (click name, edit, Enter to save, Esc to cancel)"
    - "Admin can delete a template after typing the template name to confirm (GitHub-style safety)"
    - "Admin sees a name collision prompt (overwrite or save as new) when saving with a duplicate name"
  artifacts:
    - path: "src/components/SessionTemplatePanel.tsx"
      provides: "Complete template management sidebar/drawer UI"
      min_lines: 150
    - path: "src/pages/AdminSession.tsx"
      provides: "SessionTemplatePanel integration in draft view"
      contains: "SessionTemplatePanel"
  key_links:
    - from: "src/components/SessionTemplatePanel.tsx"
      to: "src/lib/session-template-api.ts"
      via: "imports CRUD and serialization functions"
      pattern: "import.*from.*session-template-api"
    - from: "src/components/SessionTemplatePanel.tsx"
      to: "src/stores/session-template-store.ts"
      via: "reads template list from store"
      pattern: "useSessionTemplateStore"
    - from: "src/components/SessionTemplatePanel.tsx"
      to: "src/stores/session-store.ts"
      via: "reads sessionItems, batches, questions for serialization"
      pattern: "useSessionStore"
    - from: "src/pages/AdminSession.tsx"
      to: "src/components/SessionTemplatePanel.tsx"
      via: "renders panel in draft view"
      pattern: "SessionTemplatePanel"
---

<objective>
Build the SessionTemplatePanel UI component with save, load, rename, and delete functionality, and integrate it into the AdminSession draft view.

Purpose: Gives the admin a complete template management interface within the session editing screen. This is the user-facing feature that fulfills all STPL requirements.

Output: SessionTemplatePanel.tsx component and updated AdminSession.tsx with panel integration.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-session-templates/20-CONTEXT.md
@.planning/phases/20-session-templates/20-RESEARCH.md
@.planning/phases/20-session-templates/20-01-SUMMARY.md

Key files to reference:
@src/components/ResponseTemplatePanel.tsx -- Follow this panel pattern (layout, structure, bg-white, text-gray-900 light theme)
@src/components/ConfirmDialog.tsx -- Reuse for confirmations, but type-to-confirm delete needs custom dialog
@src/lib/session-template-api.ts -- Created in Plan 01, provides all CRUD + serialize/deserialize
@src/stores/session-template-store.ts -- Created in Plan 01, provides reactive template state
@src/stores/session-store.ts -- Read sessionItems, batches, questions for serialization
@src/types/database.ts -- SessionTemplate, SessionBlueprint types
@src/pages/AdminSession.tsx -- Integration point (draft view, near ResponseTemplatePanel)
@src/lib/slide-api.ts -- getSlideImageUrl for thumbnail previews
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionTemplatePanel component</name>
  <files>src/components/SessionTemplatePanel.tsx</files>
  <action>
    Create `src/components/SessionTemplatePanel.tsx` -- a self-contained panel component for session template management. Follow the ResponseTemplatePanel pattern for layout and styling.

    **Props:** `sessionId: string` (current session ID, needed for loadTemplateIntoSession)

    **Component structure:**

    1. **State management:**
       - Read templates from useSessionTemplateStore (templates, loading)
       - Read sessionItems, batches, questions from useSessionStore
       - Local state: panelOpen (boolean), saveName (string), saveStatus ('idle' | 'saving' | 'success' | 'error'), saveError (string | null), editingId (string | null), editValue (string), deleteTarget (SessionTemplate | null), deleteConfirmText (string), deleting (boolean), loadTarget (SessionTemplate | null), loadMode ('replace' | 'append' | null), loadingTemplate (boolean), nameCollision ({ name: string, blueprint: SessionBlueprint, itemCount: number } | null), missingTemplateWarning (number | null)

    2. **On mount:** Call fetchSessionTemplates() (similar to ResponseTemplatePanel's useEffect)

    3. **Save workflow:**
       - "Save as Template" button visible when panelOpen
       - Text input for template name (required, trim whitespace)
       - On submit:
         a. Check if name exists via checkTemplateNameExists(name)
         b. If exists: show inline prompt "Template 'X' exists. Overwrite or save as new?"
            - "Overwrite" -> call overwriteSessionTemplate(existingId, blueprint, itemCount) using the found template's ID. To get the ID, fetch the existing template by matching name from the store's templates array.
            - "Save as New" -> clear the name input so user can enter a new name
         c. If new: serialize session via serializeSession(sessionItems, batches, questions), call saveSessionTemplate(name, blueprint, sessionItems.length)
       - Save button states (inline success, NOT toast per CONTEXT.md):
         - Idle: "Save Template" (bg-indigo-600)
         - Saving: "Saving..." (disabled)
         - Success: checkmark + "Saved" (bg-green-600, reverts to idle after 2s)
         - Error: show error message in red text below button

    4. **Template list:**
       - Simple list of templates: name, last modified date (format as relative or short date), item count badge
       - Each row has: clickable name (for rename), "Load" button, delete icon button
       - Empty state: "No session templates yet. Save the current session to create one."
       - Loading state: "Loading templates..."

    5. **Inline rename:**
       - Click template name -> input appears with current name, autoFocus
       - Enter: save via renameSessionTemplate(id, newName.trim()), handle 23505 uniqueness error
       - Escape: cancel, revert to display mode
       - onBlur: save (same as Enter)
       - Prevent empty name (trim and check before saving)

    6. **Type-to-confirm delete (custom inline, NOT ConfirmDialog):**
       - Click delete icon -> expand delete confirmation area within the row (or below it)
       - Show: "Type '{templateName}' to delete" with text input
       - Delete button enabled only when input matches template name exactly
       - On confirm: call deleteSessionTemplate(id)
       - Loading state: "Deleting..." on button
       - Cancel button to dismiss

    7. **Load workflow:**
       - Click "Load" on a template row
       - Show summary preview overlay/section:
         - Template name
         - Item count, breakdown (N batches, M slides)
         - Total questions across batches
         - Small slide thumbnail previews if slides exist (use getSlideImageUrl)
       - If session has existing content (sessionItems.length > 0): show prompt "Replace current content or append template items?"
         - "Replace": clear all existing batches, questions, session_items for this session first, then load
         - "Append": load template items with positions after existing items
       - If session is empty: load directly without prompt
       - Call loadTemplateIntoSession(sessionId, blueprint) -- for append mode, adjust positions in the cloned blueprint before calling
       - After load: refresh session store (refetch batches, questions, session_items from Supabase)
       - If missingTemplateCount > 0: show warning "N response templates no longer exist -- questions loaded without assignments"

    **Replace implementation (when user selects Replace):**
    - Delete all questions for this session: supabase.from('questions').delete().eq('session_id', sessionId)
    - Delete all batches for this session: supabase.from('batches').delete().eq('session_id', sessionId)
    - Delete all session_items for this session: supabase.from('session_items').delete().eq('session_id', sessionId)
    - Then call loadTemplateIntoSession

    **Append implementation (when user selects Append):**
    - Get max position from current sessionItems
    - structuredClone the blueprint, offset all positions by maxPosition + 1
    - Call loadTemplateIntoSession with adjusted blueprint

    **Styling:** Light theme only (bg-white, text-gray-900). Follow ResponseTemplatePanel's card style (bg-white rounded-lg p-6 space-y-4). Admin theme is LIGHT per project MEMORY.

    **Panel toggle:** A button "Session Templates" that toggles panelOpen. When open, show the full panel content.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component exports SessionTemplatePanel
    - Component imports from session-template-api, session-template-store, session-store
    - Save workflow includes name collision handling (overwrite or save as new)
    - Delete uses type-to-confirm pattern
    - Load shows summary preview and replace/append prompt
    - All text uses light theme colors
  </verify>
  <done>
    SessionTemplatePanel renders a complete template management interface with: save (with inline success state and name collision handling), template list (name, date, item count), inline rename (Enter/Esc), type-to-confirm delete, and load (with preview, replace/append prompt, and missing template warning). All in light theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SessionTemplatePanel into AdminSession</name>
  <files>src/pages/AdminSession.tsx</files>
  <action>
    1. Add import at top of AdminSession.tsx:
       ```typescript
       import { SessionTemplatePanel } from '../components/SessionTemplatePanel';
       ```

    2. In the draft view section (isDraft block), add SessionTemplatePanel after the existing ResponseTemplatePanel and TemplatePanel, within the max-w-2xl container:
       ```tsx
       {/* Session Templates */}
       <SessionTemplatePanel sessionId={session.session_id} />
       ```

       Place it after the existing `<TemplatePanel sessionId={session.session_id} />` line (around line 1227), so the ordering in the draft view is:
       - Session Sequence (batches, slides, import/export)
       - Response Templates (ResponseTemplatePanel)
       - Template Panel (TemplatePanel - existing, for response template assignment)
       - Session Templates (SessionTemplatePanel - new)

    3. Also add a "load after template load" refresh handler. Since SessionTemplatePanel handles its own refresh internally (refetches batches, questions, session_items after load), no additional props are needed beyond sessionId.

    4. Verify the import doesn't conflict with existing imports (ResponseTemplatePanel is already imported on a separate line).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - AdminSession.tsx imports SessionTemplatePanel
    - SessionTemplatePanel appears in the draft view JSX
    - No duplicate imports or naming conflicts
    - Dev server shows the panel in the draft view (below existing panels)
  </verify>
  <done>
    SessionTemplatePanel is rendered in the AdminSession draft view. Admin can access template management from the session editing screen.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete session template management: save current session as named template, load templates into sessions (with replace/append), rename (inline), delete (type-to-confirm). Integrated into AdminSession draft view.
  </what-built>
  <how-to-verify>
    NOTE: Before testing, apply the migration SQL from `supabase/migrations/20250211_050_session_templates.sql` via Supabase Dashboard SQL Editor.

    1. Open a session in draft mode with at least 1 batch (with questions) and 1 slide
    2. Scroll to "Session Templates" panel section
    3. Save test:
       - Enter a name and click Save Template
       - Verify inline success state (green checkmark) appears briefly
       - Save again with the same name -> verify overwrite/save-as-new prompt appears
    4. List test:
       - Verify template appears in list with name, date, item count
    5. Rename test:
       - Click the template name -> verify it becomes an editable input
       - Change name, press Enter -> verify name updates
       - Try renaming to an existing name -> verify error
    6. Load test:
       - Create a new empty session, go to draft view
       - Click Load on the saved template
       - Verify summary preview shows (item count, batch/slide breakdown)
       - Load into the empty session -> verify batches, questions, slides appear
       - Load into a session with existing content -> verify replace/append prompt
    7. Delete test:
       - Click delete on a template
       - Verify type-to-confirm appears
       - Type wrong text -> verify Delete button stays disabled
       - Type correct name -> verify Delete button enables
       - Confirm delete -> verify template removed from list
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with all new files
- `npm run build` succeeds
- SessionTemplatePanel renders in AdminSession draft view
- Save/load/rename/delete workflows function correctly
- Light theme styling consistent with existing panels
- STPL-01: Admin can save session structure as named template (verified via save workflow)
- STPL-02: Admin can load template into new session (verified via load workflow with replace/append)
- STPL-03: Admin can list, rename, delete templates (verified via list + inline rename + type-to-confirm delete)
</verification>

<success_criteria>
- Admin can save current session (sequence, slides, batches, questions, response template assignments) as a named template
- Admin can load a saved template into a session with replace/append option
- Admin can list templates (name, date, item count), rename inline, delete with type-to-confirm
- Name collision on save shows overwrite/save-as-new prompt
- Missing response template references show warning on load
- Save confirmation uses inline button state (not toast)
- All UI follows light theme (bg-white, text-gray-900)
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-templates/20-02-SUMMARY.md`
</output>

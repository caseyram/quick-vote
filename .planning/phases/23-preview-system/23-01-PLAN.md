---
phase: 23-preview-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/editor/preview-mock-data.ts
  - src/components/editor/PreviewProjection.tsx
  - src/components/editor/SessionPreviewOverlay.tsx
  - src/components/editor/PreviewMode.tsx
  - src/components/editor/EditorToolbar.tsx
  - src/pages/TemplateEditorPage.tsx
autonomous: true

must_haves:
  truths:
    - "Full-page preview overlay opens over the editor when activated"
    - "Preview shows three labeled panels side-by-side (Projection View, Admin Controls, Participant View)"
    - "Projection panel displays crossfade-animated content matching the current sequence item"
    - "Pressing Escape closes the overlay and returns to the editor"
    - "Arrow keys advance/retreat through sequence items"
    - "'Preview All' starts at beginning, 'Preview from Here' starts at selected item"
  artifacts:
    - path: "src/components/editor/preview-mock-data.ts"
      provides: "Mock vote data generation and participant count"
    - path: "src/components/editor/PreviewProjection.tsx"
      provides: "Projection panel rendering slides and batch results with mock data"
    - path: "src/components/editor/SessionPreviewOverlay.tsx"
      provides: "Full-page overlay container with 3-panel layout, navigation state, keyboard handling"
    - path: "src/components/editor/EditorToolbar.tsx"
      provides: "Updated toolbar with Preview All/From Here entry points"
    - path: "src/pages/TemplateEditorPage.tsx"
      provides: "Overlay rendering, removal of old Edit/Preview toggle routing"
  key_links:
    - from: "src/components/editor/EditorToolbar.tsx"
      to: "SessionPreviewOverlay"
      via: "callback to open overlay with startIndex"
      pattern: "onPreview.*startIndex"
    - from: "src/components/editor/SessionPreviewOverlay.tsx"
      to: "PreviewProjection"
      via: "currentItem prop from shared navigation state"
      pattern: "PreviewProjection.*item="
    - from: "src/components/editor/PreviewProjection.tsx"
      to: "preview-mock-data.ts"
      via: "generateMockVotes import for batch result display"
      pattern: "generateMockVotes"
---

<objective>
Create the full-page session preview overlay with projection panel, mock data utilities, and toolbar entry points.

Purpose: Establish the preview infrastructure — the overlay shell, shared navigation state, keyboard handling, crossfade animations, and the projection panel showing what the live projection screen would look like. This replaces the existing simple Edit/Preview toggle with a proper multi-view preview experience.

Output: SessionPreviewOverlay with 3-panel skeleton, PreviewProjection component, mock data utilities, and toolbar integration with "Preview All" / "Preview from Here" options.
</objective>

<execution_context>
@C:/Users/cramo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cramo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-preview-system/23-RESEARCH.md
@.planning/phases/23-preview-system/23-CONTEXT.md
@.planning/phases/22-template-foundation-authoring/22-03-SUMMARY.md

Key source files:
@src/stores/template-editor-store.ts — EditorItem, EditorQuestion types
@src/components/editor/PreviewMode.tsx — BEING REPLACED (current simple preview)
@src/components/editor/EditorToolbar.tsx — SegmentedControl Edit/Preview toggle to replace
@src/components/editor/SegmentedControl.tsx — may be removed or repurposed
@src/pages/TemplateEditorPage.tsx — renders PreviewMode vs edit mode based on URL param
@src/pages/PresentationView.tsx — crossfadeVariants pattern to replicate
@src/components/BarChart.tsx — BarChart component with light theme support
@src/components/BatchResultsProjection.tsx — live batch results pattern to approximate
@src/lib/slide-api.ts — getSlideImageUrl for slide image URLs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mock data utilities and PreviewProjection component</name>
  <files>
    src/components/editor/preview-mock-data.ts
    src/components/editor/PreviewProjection.tsx
  </files>
  <action>
Create `preview-mock-data.ts` with mock data generation:
- `generateMockVotes(questionType: VoteType, options: string[] | null)` — returns BarChartData[] with fixed, deterministic vote distributions:
  - For agree_disagree: Agree 60% (15), Sometimes 16% (4), Disagree 24% (6) — total 25
  - For multiple_choice: distribute 25 votes across options with decreasing percentages (e.g., first option gets ~35%, second ~25%, decreasing). Use the option index to compute counts deterministically (no Math.random). Map colors from AGREE_DISAGREE_COLORS and MULTI_CHOICE_COLORS imported from BarChart.tsx.
- `MOCK_PARTICIPANT_COUNT = 12` — fixed constant
- `MOCK_TOTAL_VOTES = 25` — fixed constant

Create `PreviewProjection.tsx`:
- Props: `{ item: EditorItem }` — the current sequence item
- Renders in light theme (bg-white, dark text) matching a styled approximation of PresentationView:
  - **Slide items:** Render the slide image using `getSlideImageUrl(item.slide.image_path)` centered, with caption below. Use `object-contain` and max height constraint. If no image_path, show placeholder.
  - **Batch items:** Show batch name as heading, then for the first question in the batch, display the question text and a BarChart with `theme="light"` and `size="default"` using mock vote data from `generateMockVotes`. Show "Total: 25 votes" below. If batch has no questions, show "No questions in this batch" message.
  - **Empty/invalid:** Show "No content" placeholder.
- Use the existing BarChart component (import from `../BarChart`) with `theme="light"`.
- Wrap the content in AnimatePresence + motion.div with crossfade animation (opacity 0→1→0, duration 0.35s, ease easeInOut) keyed on `item.id` — matching the crossfadeVariants pattern from PresentationView.tsx.
  </action>
  <verify>
`npx tsc --noEmit` passes. Both files exist and export their functions/components.
  </verify>
  <done>
preview-mock-data.ts exports generateMockVotes and mock constants. PreviewProjection renders slide images or batch results with mock data and crossfade animation, all in light theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: SessionPreviewOverlay, toolbar entry points, and page integration</name>
  <files>
    src/components/editor/SessionPreviewOverlay.tsx
    src/components/editor/EditorToolbar.tsx
    src/pages/TemplateEditorPage.tsx
    src/components/editor/PreviewMode.tsx
  </files>
  <action>
Create `SessionPreviewOverlay.tsx`:
- Props: `{ isOpen: boolean; onClose: () => void; startIndex: number }`
- Full-page overlay using AnimatePresence + motion.div with `fixed inset-0 bg-gray-50 z-50 flex flex-col`. Fade in/out (opacity 0→1, duration 0.2s).
- **Header bar:** Compact top bar with "Session Preview" title on the left, navigation info center (`{currentIndex + 1} of {items.length}`), and a Close button (X icon) on the right. Use `bg-white border-b border-gray-200 px-4 py-2`.
- **Three-panel layout:** Below the header, `flex flex-1 gap-4 p-4 overflow-hidden`. Three panels:
  - Each panel is a `flex flex-col flex-1 min-w-0` container.
  - Each panel has a label header: small `text-xs font-semibold uppercase tracking-wider text-gray-500 mb-2` text reading "Projection View", "Admin Controls", or "Participant View".
  - Each panel body is `bg-white rounded-lg border border-gray-200 flex-1 overflow-hidden`.
  - Projection panel renders `<PreviewProjection item={currentItem} />`.
  - Admin Controls panel shows placeholder text "Controls — Plan 02" (will be replaced in next plan).
  - Participant View panel shows placeholder text "Participant — Plan 02" (will be replaced in next plan).
- **Navigation state:** `const [currentIndex, setCurrentIndex] = useState(startIndex)` with items from `useTemplateEditorStore`. Compute `currentItem = items[currentIndex]`. Provide `handleNext` and `handlePrev` functions. Reset currentIndex when startIndex changes (useEffect on startIndex).
- **Keyboard handler:** useEffect with keydown listener (following PresentationView pattern from research):
  - ArrowRight / ArrowDown → handleNext
  - ArrowLeft / ArrowUp → handlePrev
  - Escape → onClose
  - Skip if target is INPUT/TEXTAREA/SELECT
  - Skip if event.repeat
  - Include currentIndex, items.length, onClose in deps
- **Edge cases:** If items.length === 0, show empty state message "No items to preview" inside the overlay.

Update `EditorToolbar.tsx`:
- Remove the SegmentedControl import and the Edit/Preview toggle.
- Remove the `handleModeChange` function and `mode` variable (no longer needed for URL param toggling).
- Replace the SegmentedControl in the right section with a Preview button group:
  - A primary "Preview" button (outline style: `border border-gray-300 bg-white hover:bg-gray-50 text-gray-700`) that calls `onOpenPreview(0)` (preview all from beginning).
  - A small dropdown arrow button next to it that, on click, shows a tiny dropdown with two options: "Preview All" (starts at 0) and "Preview from Here" (starts at the index of selectedItemId, or 0 if none selected).
  - Use a simple `useState<boolean>` for dropdown visibility. Close dropdown on blur or after selection.
  - Disable both buttons when `items.length === 0`.
- Add prop `onOpenPreview: (startIndex: number) => void` to EditorToolbar (or, since EditorToolbar currently has no props, lift the preview state up — actually, add an `onOpenPreview` callback prop).
- Actually, since EditorToolbar reads from the store directly, a simpler approach: have EditorToolbar accept `onOpenPreview: (startIndex: number) => void` as a prop passed from TemplateEditorPage.

Update `TemplateEditorPage.tsx`:
- Remove the URL search param based `mode` variable and the `mode === 'preview'` conditional rendering of `<PreviewMode />`.
- Add state: `const [previewOpen, setPreviewOpen] = useState(false)` and `const [previewStartIndex, setPreviewStartIndex] = useState(0)`.
- Add `handleOpenPreview = (startIndex: number) => { setPreviewStartIndex(startIndex); setPreviewOpen(true); }`.
- Always render `<EditorSidebar />` + `<EditorMainArea />` (no more conditional).
- Render `<SessionPreviewOverlay isOpen={previewOpen} onClose={() => setPreviewOpen(false)} startIndex={previewStartIndex} />` after the main content.
- Pass `onOpenPreview={handleOpenPreview}` to `<EditorToolbar />`.
- Remove the PreviewMode import.
- Remove `useSearchParams` import if no longer needed (check if `fromTemplate` still uses it — yes it does, keep the import but remove `mode` usage).

Update `PreviewMode.tsx`:
- Keep the file for now but add a deprecation comment at the top: `// DEPRECATED: Replaced by SessionPreviewOverlay in Phase 23`. The file can be removed in a future cleanup. Or actually, since the plan says to replace it entirely, just delete the content and re-export nothing — no, better to leave it untouched since it's no longer imported. TemplateEditorPage will simply stop importing it. Leave PreviewMode.tsx as-is (dead code); it's not imported anymore.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors.
2. The TemplateEditorPage always shows sidebar + main area (no mode-based conditional).
3. SessionPreviewOverlay exists and renders 3 panels when isOpen is true.
4. EditorToolbar has Preview button(s) instead of the old Edit/Preview SegmentedControl.
  </verify>
  <done>
Full-page preview overlay renders over the editor with 3 labeled panels (projection with crossfade animations, two placeholder panels). Toolbar has Preview / Preview from Here buttons. Keyboard navigation works (arrows navigate, Escape closes). Old Edit/Preview URL param toggle removed.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors
2. Open template editor with items → click "Preview" → overlay appears with 3 panels
3. Projection panel shows slide images or batch results with mock vote bars
4. Arrow keys advance through items, projection crossfades between them
5. Escape key closes overlay and returns to editor
6. "Preview from Here" starts at the selected sidebar item
7. "Preview All" starts at the beginning
8. Editor sidebar and main area are always visible (no more mode switching)
</verification>

<success_criteria>
- SessionPreviewOverlay renders as full-page overlay with 3 labeled panels
- PreviewProjection shows light-themed slides and batch results with mock vote data
- Keyboard navigation (arrows, Escape) works correctly
- Preview entry points (all / from here) wired from toolbar
- Old Edit/Preview toggle removed; editor always shows edit view
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/23-preview-system/23-01-SUMMARY.md`
</output>

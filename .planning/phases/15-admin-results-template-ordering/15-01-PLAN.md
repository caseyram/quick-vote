---
phase: 15-admin-results-template-ordering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/AdminSession.tsx
  - src/components/SessionResults.tsx
autonomous: true

must_haves:
  truths:
    - "Admin 'Previous Results' grid shows bar chart columns in template-defined order"
    - "Admin ActiveQuestionHero live results show bar chart columns in template-defined order"
    - "Admin end-of-session SessionResults view shows bar chart columns in template-defined order"
    - "All three admin result views match participant view ordering for template-linked questions"
    - "Non-template questions continue working unchanged (backward compatible)"
  artifacts:
    - path: "src/pages/AdminSession.tsx"
      provides: "Template-aware bar data in Previous Results grid and ActiveQuestionHero"
      contains: "buildConsistentBarData"
    - path: "src/components/SessionResults.tsx"
      provides: "Template-aware bar data in end-of-session results"
      contains: "buildConsistentBarData"
  key_links:
    - from: "src/pages/AdminSession.tsx"
      to: "src/lib/vote-aggregation.ts"
      via: "buildConsistentBarData import and usage"
      pattern: "buildConsistentBarData\\(q,"
    - from: "src/pages/AdminSession.tsx"
      to: "src/lib/template-api.ts"
      via: "fetchTemplates import and useEffect call"
      pattern: "fetchTemplates\\(\\)"
    - from: "src/components/SessionResults.tsx"
      to: "src/lib/vote-aggregation.ts"
      via: "buildConsistentBarData import and usage"
      pattern: "buildConsistentBarData\\(result\\.question,"
    - from: "src/components/SessionResults.tsx"
      to: "src/stores/template-store.ts"
      via: "useTemplateStore import and template lookup"
      pattern: "useTemplateStore"
---

<objective>
Replace inline aggregated.map() bar data building with buildConsistentBarData() in all admin result views so bar chart columns respect template-defined ordering.

Purpose: Close tech debt item #1 from v1.2 milestone audit — admin result views currently show columns in arbitrary aggregation order instead of template-defined order, creating a mismatch with the participant view.

Output: AdminSession.tsx and SessionResults.tsx use the same buildConsistentBarData() pattern as SessionReview.tsx (the reference implementation).
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/SessionReview.tsx (reference implementation — correct pattern)
@src/lib/vote-aggregation.ts (buildConsistentBarData function)
@src/stores/template-store.ts (useTemplateStore)
@src/lib/template-api.ts (fetchTemplates)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AdminSession.tsx — template-aware bar data in both result views + explicit template loading</name>
  <files>src/pages/AdminSession.tsx</files>
  <action>
Three changes to AdminSession.tsx:

**1. Add imports** (line 8 area):
- Change `import { aggregateVotes } from '../lib/vote-aggregation';` to `import { aggregateVotes, buildConsistentBarData } from '../lib/vote-aggregation';`
- Add `import { fetchTemplates } from '../lib/template-api';` (new import, alongside existing `checkQuestionVotes` import from same module)

**2. Add explicit fetchTemplates() call** in the existing useEffect that runs on adminToken (tech debt #2). Inside the `loadSession()` function body (around line 69), add a fire-and-forget call:
```typescript
fetchTemplates().catch(console.error);
```
Place it at the start of loadSession(), before the session fetch, so templates load in parallel with session data.

**3a. Fix "Previous Results" grid** (around line 1306):
Replace:
```typescript
const barData = aggregated.map((vc, index) => {
```
With a pattern that uses buildConsistentBarData. The question variable here is `q` and templates are available from the outer component's `templates` destructure. Look up the template:
```typescript
const template = q.template_id ? templates.find(t => t.id === q.template_id) : null;
const ordered = buildConsistentBarData(q, aggregated, template?.options);
const barData = ordered.map((vc, index) => {
```
The rest of the map body (color assignment) stays identical — it already uses `index` for position-based colors.

**3b. Fix ActiveQuestionHero live results** (around line 1458-1476):
The ActiveQuestionHero component is a separate function at the bottom of AdminSession.tsx. It receives `question` as a prop but does NOT have access to the templates store. Two sub-steps:

First, add template store access inside ActiveQuestionHero:
```typescript
const templates = useTemplateStore(state => state.templates);
```

Then replace the barData useMemo:
```typescript
const barData = useMemo(() => {
  const template = question.template_id ? templates.find(t => t.id === question.template_id) : null;
  const ordered = buildConsistentBarData(question, aggregated, template?.options);
  return ordered.map((vc, index) => {
    // ... existing color logic unchanged ...
  });
}, [aggregated, question.type, question.template_id, templates]);
```

The useMemo dependency array gains `question.template_id` and `templates` (was `[aggregated, question.type]`).

**What NOT to do:**
- Do NOT modify the color assignment logic inside the map callbacks — only the data ordering changes
- Do NOT change the aggregateVotes() calls — those stay as-is
- Do NOT touch any other part of AdminSession.tsx
  </action>
  <verify>
Run `npx tsc --noEmit` from project root — no type errors.
Run `npx vitest run` — all existing tests pass (no new tests needed, this is a refactor).
Grep for `aggregated.map` in AdminSession.tsx — should return 0 matches (both replaced with `ordered.map`).
  </verify>
  <done>
AdminSession.tsx Previous Results grid and ActiveQuestionHero both use buildConsistentBarData() with template lookup. Templates load explicitly via fetchTemplates() in the session load useEffect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SessionResults.tsx — template-aware bar data with template store integration</name>
  <files>src/components/SessionResults.tsx</files>
  <action>
Three changes to SessionResults.tsx:

**1. Add imports** (line 1-5 area):
- Change `import { aggregateVotes, type VoteCount } from '../lib/vote-aggregation';` to `import { aggregateVotes, buildConsistentBarData, type VoteCount } from '../lib/vote-aggregation';`
- Add `import { useTemplateStore } from '../stores/template-store';` (new import)
- Add `import { fetchTemplates } from '../lib/template-api';` (new import)

**2. Update buildBarData function** (lines 18-34):
Change the function signature to accept template options:
```typescript
function buildBarData(result: QuestionResult, templates: { id: string; options: string[] }[]) {
  const template = result.question.template_id
    ? templates.find(t => t.id === result.question.template_id)
    : null;
  const ordered = buildConsistentBarData(result.question, result.aggregated, template?.options);
  return ordered.map((vc, index) => {
    // ... existing color logic unchanged ...
  });
}
```

**3. Update SessionResults component** (line 36 area):
- Add template store access at the top of the component:
```typescript
const { templates } = useTemplateStore();
```
- Add fetchTemplates call in the existing useEffect (or a new useEffect):
```typescript
useEffect(() => {
  fetchTemplates().catch(console.error);
}, []);
```
- Update all `buildBarData(result)` calls to `buildBarData(result, templates)` — there are 2 calls: line 152 and line 162.

**What NOT to do:**
- Do NOT change the color assignment logic — only the ordering
- Do NOT modify the Supabase query or data fetching logic
- Do NOT change the ReasonsSection component
  </action>
  <verify>
Run `npx tsc --noEmit` from project root — no type errors.
Run `npx vitest run` — all existing tests pass.
Grep for `result.aggregated.map` in SessionResults.tsx — should return 0 matches (replaced with `ordered.map` inside buildBarData).
  </verify>
  <done>
SessionResults.tsx buildBarData uses buildConsistentBarData() with template lookup from store. Templates load explicitly via fetchTemplates() in useEffect.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero type errors
2. `npx vitest run` — all tests pass (no regressions)
3. Grep confirmation: `grep -n "aggregated.map" src/pages/AdminSession.tsx src/components/SessionResults.tsx` returns zero matches
4. Grep confirmation: `grep -n "buildConsistentBarData" src/pages/AdminSession.tsx src/components/SessionResults.tsx` returns matches in both files
5. Grep confirmation: `grep -n "fetchTemplates" src/pages/AdminSession.tsx src/components/SessionResults.tsx` returns matches in both files
</verification>

<success_criteria>
- AdminSession.tsx "Previous Results" grid uses buildConsistentBarData with template options
- AdminSession.tsx ActiveQuestionHero uses buildConsistentBarData with template options
- SessionResults.tsx buildBarData uses buildConsistentBarData with template options
- Both files explicitly call fetchTemplates() for robust template loading
- All existing tests pass without modification
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-results-template-ordering/15-01-SUMMARY.md`
</output>

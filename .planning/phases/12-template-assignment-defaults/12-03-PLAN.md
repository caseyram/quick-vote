---
phase: 12-template-assignment-defaults
plan: 03
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - src/pages/AdminSession.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can set a session-level default template from the session settings panel"
    - "Default template auto-applies when creating new MC questions"
    - "Admin can clear the default template"
    - "Setting a default offers to apply to existing templateless MC questions"
    - "Bulk apply skips questions that have received votes"
    - "All ASGN and TMPL-05 requirements work end-to-end in browser"
  artifacts:
    - path: "src/pages/AdminSession.tsx"
      provides: "Default template UI in session settings"
      contains: "default_template_id"
  key_links:
    - from: "src/pages/AdminSession.tsx"
      to: "src/stores/session-store.ts"
      via: "setSessionDefaultTemplate for persisting default"
      pattern: "setSessionDefaultTemplate"
    - from: "src/pages/AdminSession.tsx"
      to: "src/stores/template-store.ts"
      via: "useTemplateStore for template list"
      pattern: "useTemplateStore"
    - from: "src/pages/AdminSession.tsx"
      to: "src/lib/template-api.ts"
      via: "checkQuestionVotes for bulk apply safety"
      pattern: "checkQuestionVotes"
---

<objective>
Add session-level default template UI to AdminSession settings, implement bulk apply with vote safety, apply database migration, and verify all Phase 12 requirements end-to-end.

Purpose: Completes Phase 12 by adding TMPL-05 (session defaults), applying the migration, and verifying all requirements work in the browser.
Output: Updated AdminSession with default template dropdown, migration applied, all requirements verified.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-template-assignment-defaults/12-CONTEXT.md
@.planning/phases/12-template-assignment-defaults/12-RESEARCH.md
@.planning/phases/12-template-assignment-defaults/12-01-SUMMARY.md
@.planning/phases/12-template-assignment-defaults/12-02-SUMMARY.md
@src/pages/AdminSession.tsx
@src/stores/session-store.ts
@src/stores/template-store.ts
@src/lib/template-api.ts
@src/components/TemplateSelector.tsx
@src/components/ConfirmDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Default template UI in AdminSession settings</name>
  <files>src/pages/AdminSession.tsx</files>
  <action>
    Add a "Default Template" dropdown to the existing Session Settings section in AdminSession's draft view.

    **New imports:**
    - `import { useTemplateStore } from '../stores/template-store';`
    - `import { TemplateSelector } from '../components/TemplateSelector';`
    - `import { checkQuestionVotes } from '../lib/template-api';`

    **New state in AdminSession:**
    - `const { templates } = useTemplateStore();`
    - `const [bulkApplyConfirm, setBulkApplyConfirm] = useState<{ templateId: string; questionCount: number; skippedCount: number } | null>(null);`
    - `const [bulkApplying, setBulkApplying] = useState(false);`

    **Default template change handler (`handleDefaultTemplateChange`):**
    1. Call `useSessionStore.getState().setSessionDefaultTemplate(templateId)` to persist
    2. If `templateId` is not null:
       - Find templateless MC questions: `questions.filter(q => q.type === 'multiple_choice' && !q.template_id)`
       - If there are templateless MC questions:
         - Check each for votes using `checkQuestionVotes`
         - Count safe-to-update vs skipped (have votes)
         - If safe count > 0, show bulk apply confirmation with counts
    3. If `templateId` is null: just clear the default, no bulk apply needed

    **Bulk apply confirm handler:**
    1. Get templateless MC questions without votes (re-check to be safe)
    2. For each safe question: `supabase.from('questions').update({ template_id: bulkApplyConfirm.templateId }).eq('id', q.id)`
    3. After all updates, refresh questions from database
    4. Update local store
    5. Clear confirmation

    **UI placement:** Inside the existing "Session Settings" `<div className="bg-white rounded-lg p-4 space-y-3">` block in the draft view, add after the Test Mode toggle:

    ```jsx
    {/* Default Template */}
    <div className="pt-3 border-t border-gray-200">
      <label className="block text-sm font-medium text-gray-700 mb-1">
        Default Template
      </label>
      <p className="text-xs text-gray-400 mb-2">
        Auto-applied to new multiple choice questions
      </p>
      <TemplateSelector
        value={session.default_template_id ?? null}
        onChange={handleDefaultTemplateChange}
        templates={templates}
      />
    </div>
    ```

    **Bulk apply ConfirmDialog:**
    - title: "Apply to existing questions?"
    - message: "{questionCount} multiple choice question(s) without a template will be assigned this template.{skippedCount > 0 ? ` ${skippedCount} question(s) with votes will be skipped.` : ''}"
    - confirmLabel: "Apply"
    - confirmVariant: "primary"
    - loading: bulkApplying
    - Render at the same level as other ConfirmDialogs in the component

    IMPORTANT: Admin theme is LIGHT. Use light theme colors for all new UI.
    IMPORTANT: Use spread merge in setSession calls to avoid overwriting session fields (Pitfall 4).
    IMPORTANT: After bulk apply, refresh questions via Supabase query and update store to reflect template_id changes.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vitest run` passes
    - Default template dropdown renders in session settings section
    - Setting a default persists to Supabase via setSessionDefaultTemplate
    - Clearing default (selecting "None") works
    - Bulk apply confirmation appears when templateless MC questions exist
    - Bulk apply skips questions with votes
  </verify>
  <done>
    Session-level default template (TMPL-05) complete. Admin can set, clear, and bulk apply default templates with vote safety.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Apply migration and verify all Phase 12 requirements</name>
  <what-built>
    Template assignment to questions (ASGN-01 through ASGN-05) and session default templates (TMPL-05). This includes:
    - TemplateSelector dropdown in QuestionForm for MC questions
    - Locked read-only options when template assigned
    - Detach with confirmation (fork pattern)
    - Template switching with replace confirmation
    - Vote guard preventing template changes on voted questions
    - Session default template dropdown in settings
    - Bulk apply with vote safety
  </what-built>
  <how-to-verify>
    **Step 0: Apply database migration**
    - Open Supabase Dashboard SQL Editor
    - Run contents of `supabase/migrations/20250209_020_session_default_template.sql`
    - Verify no errors

    **Step 1: ASGN-01 - Template dropdown on create**
    - Open a session in draft mode
    - Click to add a new question, select "Multiple Choice"
    - Verify a "Response Template" dropdown appears above the options
    - Verify it shows "None (custom options)" by default plus any existing templates

    **Step 2: ASGN-02 - Template auto-populates options**
    - Select a template from the dropdown
    - Verify the options area changes to show the template's options as read-only
    - Verify a "Template: [name]" badge appears

    **Step 3: ASGN-03 - Options locked while template assigned**
    - With template selected, verify options cannot be edited (no input fields)
    - Verify no drag handles, no delete buttons, no "Add Option" button
    - Verify helper text "Options are locked while template is assigned" appears

    **Step 4: ASGN-04 - Detach from template**
    - Click "Detach" link near the template badge (or select "None (custom options)" from dropdown)
    - Verify confirmation dialog appears: "Detach from template?"
    - Click "Detach"
    - Verify options become editable input fields with the same values from the template
    - Verify the template dropdown shows "None (custom options)"

    **Step 5: ASGN-05 - Switch template on existing question**
    - Create a question with a template, save it
    - Edit the question
    - Change the template to a different one
    - Verify options update to the new template's options
    - Save and verify the change persists

    **Step 6: Vote guard**
    - If you have a question with votes: edit it and verify template dropdown is disabled with "Template locked: question has received votes" message

    **Step 7: TMPL-05 - Session default template**
    - In Session Settings, find the "Default Template" dropdown
    - Select a template as default
    - If templateless MC questions exist, verify bulk apply confirmation appears
    - Create a new MC question - verify the default template is pre-selected
    - Clear the default (select "None") - verify new MC questions start with no template

    **Step 8: Verify saved data**
    - Reload the page
    - Verify template assignments persist
    - Verify default template setting persists
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- All 6 requirements verified in browser (ASGN-01 through ASGN-05 + TMPL-05)
- Database migration applied successfully
- Template assignments persist across page reloads
- Vote guard prevents data integrity issues
- Default template auto-applies to new MC questions
</verification>

<success_criteria>
- ASGN-01: Template dropdown visible when creating/editing MC questions
- ASGN-02: Template selection auto-populates options
- ASGN-03: Options locked while template assigned
- ASGN-04: Detach copies options as editable
- ASGN-05: Template switching works on existing questions
- TMPL-05: Session default template with bulk apply
- All data persists across page reloads
- Vote guard works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-template-assignment-defaults/12-03-SUMMARY.md`
</output>

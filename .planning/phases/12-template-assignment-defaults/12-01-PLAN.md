---
phase: 12-template-assignment-defaults
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20250209_020_session_default_template.sql
  - src/types/database.ts
  - src/lib/template-api.ts
  - src/stores/session-store.ts
autonomous: true

must_haves:
  truths:
    - "Session type includes default_template_id field"
    - "checkQuestionVotes helper returns true when question has votes, false otherwise"
    - "Session store can persist default_template_id to Supabase and update local state"
  artifacts:
    - path: "supabase/migrations/20250209_020_session_default_template.sql"
      provides: "default_template_id nullable FK on sessions table"
      contains: "default_template_id"
    - path: "src/types/database.ts"
      provides: "Session.default_template_id field"
      contains: "default_template_id"
    - path: "src/lib/template-api.ts"
      provides: "checkQuestionVotes helper function"
      exports: ["checkQuestionVotes"]
    - path: "src/stores/session-store.ts"
      provides: "setSessionDefaultTemplate store method"
      contains: "setSessionDefaultTemplate"
  key_links:
    - from: "src/lib/template-api.ts"
      to: "supabase votes table"
      via: "checkQuestionVotes query"
      pattern: "from\\('votes'\\).*eq\\('question_id'"
    - from: "src/stores/session-store.ts"
      to: "supabase sessions table"
      via: "setSessionDefaultTemplate update"
      pattern: "from\\('sessions'\\).*update.*default_template_id"
---

<objective>
Add the data layer for template assignment and session defaults: database migration for default_template_id on sessions, updated TypeScript types, checkQuestionVotes helper, and session store method for default template management.

Purpose: Provides the foundation types, API helpers, and state management that the UI plans (12-02, 12-03) depend on.
Output: Migration SQL file, updated types, new API helper, updated session store.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-template-assignment-defaults/12-CONTEXT.md
@.planning/phases/12-template-assignment-defaults/12-RESEARCH.md
@src/types/database.ts
@src/lib/template-api.ts
@src/stores/session-store.ts
@supabase/migrations/20250209_010_response_templates.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types</name>
  <files>
    supabase/migrations/20250209_020_session_default_template.sql
    src/types/database.ts
  </files>
  <action>
    1. Create migration file `supabase/migrations/20250209_020_session_default_template.sql`:
       - ALTER TABLE sessions ADD COLUMN default_template_id UUID REFERENCES response_templates(id) ON DELETE SET NULL;
       - CREATE INDEX idx_sessions_default_template_id ON sessions(default_template_id);
       - Add a comment explaining the purpose (session-level default template for new MC questions)

    2. Update `src/types/database.ts`:
       - Add `default_template_id: string | null;` to the Session interface, after the existing fields

    IMPORTANT: Do NOT use the moddatetime extension. This migration is simple (just an ALTER TABLE + index), no triggers needed.
    IMPORTANT: The migration will be applied manually via Supabase Dashboard SQL Editor (not via CLI).
  </action>
  <verify>
    - Migration file exists and contains valid SQL (ALTER TABLE, REFERENCES, ON DELETE SET NULL, index)
    - Session interface in database.ts includes default_template_id: string | null
    - `npx tsc --noEmit` passes (no type errors introduced)
  </verify>
  <done>
    Migration SQL ready for manual application. Session type includes default_template_id field. No type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: checkQuestionVotes helper and session store default template method</name>
  <files>
    src/lib/template-api.ts
    src/stores/session-store.ts
  </files>
  <action>
    1. Add `checkQuestionVotes` to `src/lib/template-api.ts`:
       - Extract from the existing `checkTemplateVotes` pattern
       - Signature: `export async function checkQuestionVotes(questionId: string): Promise<boolean>`
       - Query: `supabase.from('votes').select('id').eq('question_id', questionId).limit(1)`
       - Return true if votes exist, false otherwise
       - Add JSDoc: "Check if a question has received any votes. Used to prevent template changes on questions with votes."

    2. Add `setSessionDefaultTemplate` to `src/stores/session-store.ts`:
       - Add to SessionState interface: `setSessionDefaultTemplate: (templateId: string | null) => Promise<void>;`
       - Implementation:
         - Get current session from state, return early if null
         - Call `supabase.from('sessions').update({ default_template_id: templateId }).eq('id', session.id).select().single()`
         - On success, merge with existing session using spread: `set((state) => ({ session: state.session ? { ...state.session, ...data } : null }))`
         - On error, throw the error
       - IMPORTANT: Use spread merge pattern to avoid overwriting other session fields (Pitfall 4 from research)
       - Import supabase at top of session-store.ts: `import { supabase } from '../lib/supabase';`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - checkQuestionVotes function exists in template-api.ts and queries the votes table by question_id
    - setSessionDefaultTemplate method exists in session-store.ts, updates Supabase and merges state
    - Existing tests still pass: `npx vitest run`
  </verify>
  <done>
    checkQuestionVotes helper available for vote-checking in QuestionForm. Session store can set/clear default template with proper state merging. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npx vitest run` passes (existing tests unaffected)
- Migration SQL is valid and ready for manual application
- Session interface has default_template_id field
- checkQuestionVotes is exported from template-api.ts
- setSessionDefaultTemplate is a method on session store
</verification>

<success_criteria>
- Migration file exists with correct ALTER TABLE for default_template_id
- Session TypeScript type includes default_template_id: string | null
- checkQuestionVotes(questionId) helper exported and functional
- setSessionDefaultTemplate(templateId) in session store with Supabase persistence
- All existing tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-template-assignment-defaults/12-01-SUMMARY.md`
</output>

---
phase: 08-participant-batch-experience
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/components/BatchVotingCarousel.tsx
  - src/components/VoteAgreeDisagree.tsx
  - src/components/VoteMultipleChoice.tsx
autonomous: true

must_haves:
  truths:
    - "Participant can use arrow keys to navigate batch questions on desktop"
    - "Participant sees subtle pulse animation when answering each question"
    - "Keyboard navigation does not trigger when typing in reason textarea"
  artifacts:
    - path: "src/components/BatchVotingCarousel.tsx"
      provides: "Keyboard navigation with arrow keys"
      contains: "ArrowRight"
    - path: "src/components/VoteAgreeDisagree.tsx"
      provides: "onVoteSubmit callback for completion feedback"
      contains: "onVoteSubmit"
    - path: "src/components/VoteMultipleChoice.tsx"
      provides: "onVoteSubmit callback for completion feedback"
      contains: "onVoteSubmit"
  key_links:
    - from: "BatchVotingCarousel useEffect"
      to: "window.addEventListener('keydown')"
      via: "keyboard event listener with cleanup"
      pattern: "addEventListener.*keydown"
    - from: "VoteAgreeDisagree submitVote"
      to: "onVoteSubmit callback"
      via: "calls parent callback after successful vote"
      pattern: "onVoteSubmit\\?\\.(\\)"
---

<objective>
Add keyboard navigation and completion animation to batch voting experience

Purpose: Enable desktop users to navigate with arrow keys for faster workflow, and provide tactile feedback when answering questions via subtle pulse animation.
Output: Arrow key navigation in BatchVotingCarousel, onVoteSubmit callback in vote components for completion pulse
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-participant-batch-experience/08-CONTEXT.md
@.planning/phases/08-participant-batch-experience/08-RESEARCH.md
@src/components/BatchVotingCarousel.tsx
@src/components/VoteAgreeDisagree.tsx
@src/components/VoteMultipleChoice.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add keyboard navigation to BatchVotingCarousel</name>
  <files>src/components/BatchVotingCarousel.tsx</files>
  <action>
Add useEffect with keyboard event listener for arrow key navigation:

1. Import useEffect if not already imported

2. Add keyboard handler useEffect after currentIndex state:
```typescript
// Keyboard navigation (desktop only)
useEffect(() => {
  function handleKeyDown(event: KeyboardEvent) {
    // Don't navigate if user is typing in input/textarea
    if (
      event.target instanceof HTMLInputElement ||
      event.target instanceof HTMLTextAreaElement
    ) {
      return;
    }

    if (event.key === 'ArrowRight') {
      // Use functional update to avoid stale closure
      setCurrentIndex(prev => Math.min(prev + 1, questions.length - 1));
    } else if (event.key === 'ArrowLeft') {
      setCurrentIndex(prev => Math.max(prev - 1, 0));
    }
  }

  window.addEventListener('keydown', handleKeyDown);

  // Cleanup to prevent memory leaks
  return () => {
    window.removeEventListener('keydown', handleKeyDown);
  };
}, [questions.length]); // Re-attach if question count changes
```

Key implementation details:
- Check for input/textarea focus to prevent conflicts with reason field
- Use Math.min/max for bounds checking
- Use functional state updates to avoid stale closure
- Return cleanup function to remove listener on unmount
- Dependency on questions.length to re-attach if questions change
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Manual test: Press ArrowRight to navigate forward
3. Manual test: Press ArrowLeft to navigate backward
4. Manual test: Arrow keys don't work when typing in reason textarea
  </verify>
  <done>Arrow keys navigate between batch questions on desktop</done>
</task>

<task type="auto">
  <name>Task 2: Add onVoteSubmit callback to vote components</name>
  <files>src/components/VoteAgreeDisagree.tsx, src/components/VoteMultipleChoice.tsx</files>
  <action>
Modify both VoteAgreeDisagree.tsx and VoteMultipleChoice.tsx:

1. Add optional onVoteSubmit prop to interface:
```typescript
interface VoteAgreeDisagreeProps {  // or VoteMultipleChoiceProps
  // ... existing props
  onVoteSubmit?: () => void;
}
```

2. Accept onVoteSubmit in component destructuring:
```typescript
export default function VoteAgreeDisagree({
  // ... existing props
  onVoteSubmit,
}: VoteAgreeDisagreeProps) {
```

3. Call onVoteSubmit in submitVote callback after successful submission (after `setSubmitted(true)`):
```typescript
if (data) {
  setCurrentVote(data);
  setSubmitted(true);
  onVoteSubmit?.();  // Call callback for completion feedback
}
```

4. Add onVoteSubmit to the useCallback dependency array

The existing pulse animation in VoteAgreeDisagree (lines 110-121) already triggers on selection change. The onVoteSubmit callback is for parent components (like BatchVotingCarousel) to respond to vote submission if needed.

Note: Do NOT auto-advance on vote submit per CONTEXT.md - keep navigation explicit. The callback is for feedback purposes.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Manual test: Vote on a question, verify existing pulse animation still works
3. Console.log test: Add temporary console.log in onVoteSubmit to verify callback fires
  </verify>
  <done>Vote components have onVoteSubmit callback for parent notification</done>
</task>

<task type="auto">
  <name>Task 3: Wire completion feedback in BatchVotingCarousel</name>
  <files>src/components/BatchVotingCarousel.tsx</files>
  <action>
Add completion feedback handling when a vote is submitted:

1. Import useAnimate from motion/react:
```typescript
import { motion, AnimatePresence, useAnimate } from 'motion/react';
```

2. Add ref and animate function for progress indicator:
```typescript
const [progressRef, animateProgress] = useAnimate();
```

3. Create handleVoteSubmit callback that triggers subtle feedback:
```typescript
const handleVoteSubmit = useCallback(() => {
  // Subtle pulse on progress indicator as completion feedback
  if (progressRef.current) {
    animateProgress(
      progressRef.current,
      { scale: [1, 1.1, 1] },
      { duration: 0.3, ease: 'easeOut' }
    );
  }
}, [animateProgress, progressRef]);
```

4. Add ref to progress indicator div:
```typescript
<div ref={progressRef} className="px-4 py-3 text-center">
  <p className="text-gray-400 text-sm font-medium">
    Question {currentIndex + 1} of {questions.length}
  </p>
</div>
```

5. Pass handleVoteSubmit to vote components:
```typescript
<VoteAgreeDisagree
  // ... existing props
  onVoteSubmit={handleVoteSubmit}
/>
// and
<VoteMultipleChoice
  // ... existing props
  onVoteSubmit={handleVoteSubmit}
/>
```

This provides subtle visual feedback (progress indicator pulse) when the participant answers a question, per CONTEXT.md requirement for "completion animation per question answered".
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. `npm run build` succeeds
3. Manual test: Submit a vote, observe subtle pulse on progress indicator
  </verify>
  <done>Completion pulse animation triggers on each vote submission</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Vite dev server runs without warnings
3. ArrowRight navigates to next question (desktop)
4. ArrowLeft navigates to previous question (desktop)
5. Arrow keys have no effect when cursor is in reason textarea
6. No console errors when navigating after leaving batch view
7. Progress indicator pulses when vote is submitted
8. Existing vote component animations still work
</verification>

<success_criteria>
- BATCH-08: Arrow keys navigate batch questions on desktop
- BATCH-10: Completion animation (progress pulse) when answering each question
- Keyboard navigation properly checks for input focus
- Event listener cleanup prevents memory leaks
- No regressions in existing vote component behavior
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-batch-experience/08-03-SUMMARY.md`
</output>

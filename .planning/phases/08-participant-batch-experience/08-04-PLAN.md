---
phase: 08-participant-batch-experience
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/BatchVotingCarousel.tsx
  - src/components/BatchReviewScreen.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Participant sees visual answer review before final submit showing all their responses"
    - "Participant can confirm and complete the batch from review screen"
    - "Participant can go back to carousel to change answers before final submit"
  artifacts:
    - path: "src/components/BatchReviewScreen.tsx"
      provides: "Review screen showing all questions with answers"
      min_lines: 50
    - path: "src/components/BatchVotingCarousel.tsx"
      provides: "showReview state and transition logic"
      contains: "showReview"
  key_links:
    - from: "src/components/BatchVotingCarousel.tsx"
      to: "src/components/BatchReviewScreen.tsx"
      via: "conditional render when showReview is true"
      pattern: "showReview.*BatchReviewScreen"
    - from: "src/components/BatchReviewScreen.tsx"
      to: "supabase.from('votes')"
      via: "fetch all votes for participant"
      pattern: "from\\('votes'\\)"
---

<objective>
Add answer review screen before batch completion, closing the verification gap for Success Criteria #5.

Purpose: Participants must see all their responses before final submission to catch mistakes and feel confident in their answers.
Output: BatchReviewScreen component and updated BatchVotingCarousel with review flow.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-participant-batch-experience/08-VERIFICATION.md

# Source files to modify/reference
@src/components/BatchVotingCarousel.tsx
@src/components/VoteAgreeDisagree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchReviewScreen component</name>
  <files>src/components/BatchReviewScreen.tsx</files>
  <action>
Create a new component that displays all batch questions with the participant's answers.

Requirements:
1. Props: questions (Question[]), sessionId, participantId, onConfirm (() => void), onGoBack (() => void)
2. On mount, fetch all votes for the participant in this batch using supabase query:
   ```typescript
   const questionIds = questions.map(q => q.id);
   const { data: votes } = await supabase
     .from('votes')
     .select('*')
     .eq('participant_id', participantId)
     .in('question_id', questionIds);
   ```
3. Build a map of questionId -> vote for easy lookup
4. Render a scrollable list showing each question with:
   - Question text (truncated if long)
   - Answer badge showing the value (Agree/Sometimes/Disagree for agree_disagree, or the choice text for multiple_choice)
   - If no answer, show "Not answered" in gray
5. Use same dark theme as carousel (bg-gray-950, text-white)
6. Footer with two buttons:
   - "Go Back" (gray, left) - calls onGoBack
   - "Confirm & Complete" (green, right) - calls onConfirm
7. Header showing "Review Your Answers" and count like "5 of 8 answered"
8. Use motion/react for enter animation (fade in from bottom)

Style matching existing components:
- Same rounded-xl button style as carousel
- Same text sizing (text-lg for buttons, text-sm for labels)
- Same color scheme (green for confirm, gray for secondary)
  </action>
  <verify>
File exists at src/components/BatchReviewScreen.tsx with:
- Props interface defined
- useEffect fetching votes
- Question list rendering with answer display
- onConfirm and onGoBack buttons
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
BatchReviewScreen component renders all questions with participant's answers and has Confirm/Go Back buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire review flow into BatchVotingCarousel</name>
  <files>src/components/BatchVotingCarousel.tsx</files>
  <action>
Modify BatchVotingCarousel to show review screen before completion.

Changes:
1. Add state: `const [showReview, setShowReview] = useState(false);`
2. Change handleSubmitBatch to set review mode instead of completing:
   ```typescript
   const handleSubmitBatch = () => {
     setShowReview(true);
   };
   ```
3. Add handlers for review screen:
   ```typescript
   const handleConfirmComplete = () => {
     onComplete();
   };

   const handleGoBackFromReview = () => {
     setShowReview(false);
   };
   ```
4. Conditionally render BatchReviewScreen or carousel based on showReview:
   ```typescript
   if (showReview) {
     return (
       <BatchReviewScreen
         questions={questions}
         sessionId={sessionId}
         participantId={participantId}
         onConfirm={handleConfirmComplete}
         onGoBack={handleGoBackFromReview}
       />
     );
   }

   // ... existing carousel JSX
   ```
5. Import BatchReviewScreen at top of file

Do NOT change:
- Keyboard navigation logic
- Progress indicator animation
- Vote component rendering
- Slide transition animations
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File contains `showReview` state
3. File imports BatchReviewScreen
4. handleSubmitBatch sets showReview to true (not calling onComplete directly)
5. Conditional render for review screen exists
  </verify>
  <done>
"Complete Batch" button now shows review screen; "Confirm & Complete" on review screen calls onComplete().
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and build</name>
  <files>src/components/BatchVotingCarousel.tsx, src/components/BatchReviewScreen.tsx</files>
  <action>
Final verification that the gap is closed.

1. Run TypeScript check: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Verify the flow:
   - BatchVotingCarousel has showReview state
   - "Complete Batch" button calls handleSubmitBatch which sets showReview=true
   - When showReview=true, BatchReviewScreen is rendered
   - BatchReviewScreen fetches votes and displays all questions
   - "Go Back" sets showReview=false
   - "Confirm & Complete" calls onComplete

Fix any TypeScript errors or build issues discovered.
  </action>
  <verify>
1. `npx tsc --noEmit` exits with code 0
2. `npm run build` completes successfully
3. Grep confirms flow: `grep -n "showReview" src/components/BatchVotingCarousel.tsx`
  </verify>
  <done>
Build passes, review flow is wired correctly, gap "Participant sees visual answer review before final submit" is closed.
  </done>
</task>

</tasks>

<verification>
Gap closure verification:
1. BatchReviewScreen.tsx exists and has substantive implementation (50+ lines)
2. BatchVotingCarousel.tsx contains showReview state
3. "Complete Batch" button no longer directly calls onComplete()
4. Review screen shows questions with answers
5. "Confirm & Complete" button exists on review screen
6. TypeScript compiles without errors
7. Build succeeds

Commands:
```bash
npx tsc --noEmit
npm run build
grep -n "showReview" src/components/BatchVotingCarousel.tsx
grep -n "onConfirm" src/components/BatchReviewScreen.tsx
```
</verification>

<success_criteria>
1. Participant clicking "Complete Batch" sees review screen (not immediate completion)
2. Review screen shows all batch questions with participant's answers
3. Participant can go back to carousel from review screen
4. Participant can confirm and complete from review screen
5. Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-batch-experience/08-04-SUMMARY.md`
</output>

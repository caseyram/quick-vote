---
phase: 08-participant-batch-experience
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/BatchVotingCarousel.tsx
  - src/pages/ParticipantSession.tsx
autonomous: true

must_haves:
  truths:
    - "Participant can navigate between batch questions using Next/Previous buttons"
    - "Participant sees progress indicator showing current position"
    - "Participant answers persist when navigating between questions"
    - "Previous button is disabled on first question"
  artifacts:
    - path: "src/components/BatchVotingCarousel.tsx"
      provides: "Sequential navigation through batch questions"
      min_lines: 80
    - path: "src/pages/ParticipantSession.tsx"
      provides: "Renders BatchVotingCarousel in batch-voting view"
      contains: "BatchVotingCarousel"
  key_links:
    - from: "BatchVotingCarousel"
      to: "VoteAgreeDisagree/VoteMultipleChoice"
      via: "renders existing vote components"
      pattern: "VoteAgreeDisagree|VoteMultipleChoice"
    - from: "BatchVotingCarousel currentIndex"
      to: "questions[currentIndex]"
      via: "local state navigation"
      pattern: "questions\\[currentIndex\\]"
---

<objective>
Create BatchVotingCarousel component with Next/Previous navigation and progress indicator

Purpose: Enable participants to navigate through batch questions at their own pace using buttons, with a clear progress indicator showing position. Reuses existing vote components.
Output: BatchVotingCarousel.tsx component with full navigation UI, integrated into ParticipantSession
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-participant-batch-experience/08-CONTEXT.md
@.planning/phases/08-participant-batch-experience/08-RESEARCH.md
@src/pages/ParticipantSession.tsx
@src/components/VoteAgreeDisagree.tsx
@src/components/VoteMultipleChoice.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchVotingCarousel component</name>
  <files>src/components/BatchVotingCarousel.tsx</files>
  <action>
Create new component `src/components/BatchVotingCarousel.tsx`:

```typescript
import { useState } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import VoteAgreeDisagree from './VoteAgreeDisagree';
import VoteMultipleChoice from './VoteMultipleChoice';
import type { Question } from '../types/database';

interface BatchVotingCarouselProps {
  questions: Question[];
  sessionId: string;
  participantId: string;
  displayName: string | null;
  reasonsEnabled: boolean;
  onComplete: () => void;
}

// Slide transition variants matching ParticipantSession
const slideVariants = {
  enter: { x: '100%', opacity: 0 },
  center: { x: 0, opacity: 1 },
  exit: { x: '-100%', opacity: 0 },
};

const slideTransition = {
  x: { type: 'spring' as const, stiffness: 300, damping: 30 },
  opacity: { duration: 0.2 },
};

export function BatchVotingCarousel({
  questions,
  sessionId,
  participantId,
  displayName,
  reasonsEnabled,
  onComplete,
}: BatchVotingCarouselProps) {
  const [currentIndex, setCurrentIndex] = useState(0);

  const currentQuestion = questions[currentIndex];
  const isFirstQuestion = currentIndex === 0;
  const isLastQuestion = currentIndex === questions.length - 1;

  const handlePrevious = () => {
    if (currentIndex > 0) {
      setCurrentIndex(prev => prev - 1);
    }
  };

  const handleNext = () => {
    if (currentIndex < questions.length - 1) {
      setCurrentIndex(prev => prev + 1);
    }
  };

  const handleSubmitBatch = () => {
    onComplete();
  };

  if (!currentQuestion) {
    return null;
  }

  return (
    <div className="h-dvh bg-gray-950 flex flex-col overflow-hidden">
      {/* Progress indicator - text counter at top */}
      <div className="px-4 py-3 text-center">
        <p className="text-gray-400 text-sm font-medium">
          Question {currentIndex + 1} of {questions.length}
        </p>
      </div>

      {/* Question area with slide transitions */}
      <div className="flex-1 flex flex-col min-h-0">
        <div className="flex-1 flex flex-col lg:items-center lg:justify-center lg:p-8">
          <div className="flex-1 flex flex-col lg:flex-initial lg:w-full lg:max-w-2xl lg:rounded-2xl lg:bg-gray-900/50 lg:overflow-hidden">
            <AnimatePresence mode="wait" initial={false}>
              <motion.div
                key={currentQuestion.id}
                variants={slideVariants}
                initial="enter"
                animate="center"
                exit="exit"
                transition={slideTransition}
                className="flex-1 flex flex-col"
              >
                {currentQuestion.type === 'agree_disagree' ? (
                  <VoteAgreeDisagree
                    question={currentQuestion}
                    sessionId={sessionId}
                    participantId={participantId}
                    displayName={displayName}
                    reasonsEnabled={reasonsEnabled}
                  />
                ) : (
                  <VoteMultipleChoice
                    question={currentQuestion}
                    sessionId={sessionId}
                    participantId={participantId}
                    displayName={displayName}
                    reasonsEnabled={reasonsEnabled}
                  />
                )}
              </motion.div>
            </AnimatePresence>
          </div>
        </div>
      </div>

      {/* Navigation footer - fixed at bottom */}
      <div className="px-4 py-4 flex gap-3 bg-gray-950">
        <button
          onClick={handlePrevious}
          disabled={isFirstQuestion}
          className="px-6 py-3 rounded-xl font-semibold bg-gray-800 text-white disabled:opacity-30 disabled:cursor-not-allowed transition-opacity"
          aria-label={isFirstQuestion ? 'No previous question' : 'Go to previous question'}
        >
          Previous
        </button>

        {isLastQuestion ? (
          <button
            onClick={handleSubmitBatch}
            className="flex-1 px-6 py-3 rounded-xl font-bold text-lg bg-green-600 hover:bg-green-500 text-white transition-colors"
          >
            Complete Batch
          </button>
        ) : (
          <button
            onClick={handleNext}
            className="flex-1 px-6 py-3 rounded-xl font-semibold bg-indigo-600 hover:bg-indigo-500 text-white transition-colors"
          >
            Next
          </button>
        )}
      </div>
    </div>
  );
}
```

Key features:
- Local state `currentIndex` for position tracking (resets on unmount as desired)
- Reuses existing VoteAgreeDisagree and VoteMultipleChoice components
- AnimatePresence with slide transitions matching live mode
- Previous disabled on first question with opacity-30 and cursor-not-allowed
- Submit replaces Next on final question with distinct green styling
- Progress indicator "Question X of Y" at top
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>BatchVotingCarousel component exists with navigation and progress indicator</done>
</task>

<task type="auto">
  <name>Task 2: Integrate BatchVotingCarousel into ParticipantSession</name>
  <files>src/pages/ParticipantSession.tsx</files>
  <action>
1. Import BatchVotingCarousel:
```typescript
import { BatchVotingCarousel } from '../components/BatchVotingCarousel';
```

2. Import batchQuestions and activeBatchId from session store (update existing useSessionStore import)

3. Create handleBatchComplete callback:
```typescript
const handleBatchComplete = useCallback(() => {
  // Clear batch state
  setBatchQuestions([]);
  setActiveBatchId(null);
  // Transition to waiting screen
  setView('waiting');
  setWaitingMessage('Batch submitted! Waiting for results...');
}, [setBatchQuestions, setActiveBatchId]);
```

4. Replace the placeholder batch-voting render with actual BatchVotingCarousel:
```typescript
if (view === 'batch-voting' && batchQuestions.length > 0 && participantId) {
  return (
    <>
      <ConnectionPill status={connectionStatus} />
      <BatchVotingCarousel
        questions={batchQuestions}
        sessionId={sessionId!}
        participantId={participantId}
        displayName={participantName || null}
        reasonsEnabled={session?.reasons_enabled ?? false}
        onComplete={handleBatchComplete}
      />
    </>
  );
}
```

Note: ConnectionPill is rendered separately since BatchVotingCarousel is full-height. Check that the existing styles in ConnectionPill use fixed positioning (they do - it's position:fixed in the component).
  </action>
  <verify>
1. `npm run build` succeeds
2. Manual test: Navigate through batch questions with Next/Previous buttons
3. Manual test: Progress indicator updates correctly
4. Manual test: Answers persist when going back to previous question
  </verify>
  <done>ParticipantSession renders BatchVotingCarousel with full navigation in batch-voting view</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Vite dev server runs without warnings
3. Participant can navigate forward through all batch questions
4. Participant can navigate backward to previous questions
5. Previous button is disabled (30% opacity) on first question
6. Progress indicator shows "Question X of Y" and updates on navigation
7. Answers persist when navigating away and back (existing vote fetch on mount)
8. Complete Batch button appears on final question
</verification>

<success_criteria>
- BATCH-04: Next/Previous navigation works correctly
- BATCH-05: Progress indicator shows current position
- BATCH-06: Answers persist when navigating (via existing fetch on mount)
- Previous button has clear disabled state on first question
- Slide transitions match live voting mode
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-batch-experience/08-02-SUMMARY.md`
</output>

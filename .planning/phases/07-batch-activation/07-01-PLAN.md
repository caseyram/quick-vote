---
phase: 07-batch-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sql/add-batch-status.sql
  - src/types/database.ts
  - src/stores/session-store.ts
autonomous: true

must_haves:
  truths:
    - "Batch status can transition pending -> active -> closed"
    - "Store tracks which batch is currently active"
    - "Active batch ID is null when no batch is active"
  artifacts:
    - path: "sql/add-batch-status.sql"
      provides: "Migration to add status column to batches table"
      contains: "ALTER TABLE batches"
    - path: "src/types/database.ts"
      provides: "BatchStatus type and updated Batch interface"
      contains: "status: BatchStatus"
    - path: "src/stores/session-store.ts"
      provides: "activeBatchId state and setter"
      contains: "activeBatchId"
  key_links:
    - from: "src/stores/session-store.ts"
      to: "src/types/database.ts"
      via: "Batch type import"
      pattern: "import.*Batch"
---

<objective>
Add batch status tracking to database and Zustand store for activation state management.

Purpose: Foundation for batch activation - need status field to enforce one-time activation and store state to track active batch across components.
Output: Database migration, updated types, extended Zustand store with activeBatchId.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-batch-activation/07-CONTEXT.md
@.planning/phases/07-batch-activation/07-RESEARCH.md

Key files:
@src/types/database.ts
@src/stores/session-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch status migration and type</name>
  <files>sql/add-batch-status.sql, src/types/database.ts</files>
  <action>
1. Create `sql/add-batch-status.sql` with:
   - ALTER TABLE batches ADD COLUMN status TEXT DEFAULT 'pending'
   - CHECK constraint: status IN ('pending', 'active', 'closed')
   - Comment explaining one-time activation (pending -> active -> closed only)

2. Update `src/types/database.ts`:
   - Add: `export type BatchStatus = 'pending' | 'active' | 'closed';`
   - Update Batch interface to include: `status: BatchStatus;`

Note: Migration runs manually via Supabase SQL editor. The CHECK constraint enforces valid transitions at database level.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- BatchStatus type exists in database.ts
- Batch interface includes status field
  </verify>
  <done>Batch type includes status field with BatchStatus type. Migration SQL ready for execution.</done>
</task>

<task type="auto">
  <name>Task 2: Add activeBatchId to Zustand store</name>
  <files>src/stores/session-store.ts</files>
  <action>
1. Add to SessionState interface:
   - `activeBatchId: string | null;`
   - `setActiveBatchId: (id: string | null) => void;`

2. Add to initial state:
   - `activeBatchId: null,`

3. Add to store actions:
   - `setActiveBatchId: (id) => set({ activeBatchId: id }),`

4. Add to reset() function:
   - Include `activeBatchId: null,` in the reset state

Pattern matches existing `activeQuestionId` for consistency.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Store exports setActiveBatchId function
- Reset includes activeBatchId: null
  </verify>
  <done>Zustand store has activeBatchId state with getter/setter, cleared on reset.</done>
</task>

<task type="auto">
  <name>Task 3: Run database migration</name>
  <files>(none - Supabase dashboard)</files>
  <action>
Run the migration via Supabase SQL editor (npx supabase db execute or dashboard).

After migration, verify with quick query:
```sql
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'batches' AND column_name = 'status';
```

If local Supabase CLI is set up, use:
```bash
npx supabase db push
```

Otherwise, run SQL manually in Supabase dashboard SQL editor.
  </action>
  <verify>
- Query batches table: status column exists with default 'pending'
- Existing batches have status = 'pending' (or NULL if not backfilled)
  </verify>
  <done>Batches table has status column with CHECK constraint enforcing valid values.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (types are consistent)
2. BatchStatus type exists: 'pending' | 'active' | 'closed'
3. Batch interface has status: BatchStatus
4. session-store.ts has activeBatchId: string | null
5. setActiveBatchId function exists
6. Database batches table has status column
</verification>

<success_criteria>
- Database schema supports batch status with CHECK constraint
- TypeScript types updated for BatchStatus
- Zustand store tracks activeBatchId
- All existing code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-batch-activation/07-01-SUMMARY.md`
</output>

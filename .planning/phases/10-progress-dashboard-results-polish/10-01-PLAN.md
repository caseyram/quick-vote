---
phase: 10-progress-dashboard-results-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ProgressDashboard.tsx
  - src/pages/AdminSession.tsx
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "Admin sees count of participants who completed the batch"
    - "Admin sees count of participants in progress"
    - "Admin sees per-question response counts"
    - "Progress dashboard updates in real-time as participants answer"
  artifacts:
    - path: "src/components/ProgressDashboard.tsx"
      provides: "Inline progress dashboard component"
      min_lines: 80
    - path: "src/pages/AdminSession.tsx"
      provides: "Progress dashboard integration in active view"
      contains: "ProgressDashboard"
    - path: "src/index.css"
      provides: "Pulse animation keyframes"
      contains: "pulse-update"
  key_links:
    - from: "src/components/ProgressDashboard.tsx"
      to: "sessionVotes state"
      via: "props from AdminSession"
      pattern: "voteCounts.*Record"
    - from: "src/pages/AdminSession.tsx"
      to: "ProgressDashboard"
      via: "component rendering in active batch view"
      pattern: "<ProgressDashboard"
---

<objective>
Build real-time progress dashboard for admin to monitor batch completion during active voting.

Purpose: Enable admin to glance at batch progress like a live sports scoreboard â€” immediately knowing how many participants have completed, how many are in progress, and response counts per question.

Output: ProgressDashboard component integrated into AdminSession active view with real-time vote count updates and pulse animation feedback.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-progress-dashboard-results-polish/10-CONTEXT.md
@.planning/phases/10-progress-dashboard-results-polish/10-RESEARCH.md
@src/pages/AdminSession.tsx
@src/lib/vote-aggregation.ts
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProgressDashboard component with pulse animation</name>
  <files>
    src/components/ProgressDashboard.tsx
    src/index.css
  </files>
  <action>
Create `src/components/ProgressDashboard.tsx` with the following structure:

1. **Props interface:**
```typescript
interface ProgressDashboardProps {
  questionIds: string[];
  participantCount: number;
  voteCounts: Record<string, number>; // questionId -> vote count
}
```

2. **Component logic:**
- Calculate `completedParticipants` = number of unique participant_ids who have voted on ALL questions (use floor of totalVotes / questionIds.length as approximation)
- Calculate `inProgress` = participantCount - completedParticipants
- Calculate overall progress percentage

3. **Pulse animation state:**
- Track previous vote count totals using useRef
- When count increases, set `pulsing` state to true for 600ms
- Clear timeout on cleanup to prevent memory leaks

4. **Render structure:**
- Overall progress bar (horizontal bar showing completed/total ratio)
- Text display: "{completedParticipants}/{participantCount} complete"
- Secondary text: "Completed: X | In progress: Y"
- Per-question mini bars in a flex row (Q1, Q2, Q3...) each showing vote count

5. **Styling:**
- Container: `bg-white border-b border-gray-200 px-6 py-4`
- Progress bar: `h-3 bg-gray-200 rounded-full` with inner div `bg-blue-600 transition-all duration-300`
- Mini bars: `h-2 bg-gray-200 rounded-full` with inner `bg-indigo-500`
- Apply pulse animation class when pulsing: `animate-[pulse-update_0.6s_ease-out]`

Add to `src/index.css` in the @theme block:

```css
--animation-pulse-update: pulse-update 0.6s ease-out;
```

And add a new @keyframes block after @theme:

```css
@keyframes pulse-update {
  0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
  50% { box-shadow: 0 0 12px 4px rgba(59, 130, 246, 0.4); }
}
```
  </action>
  <verify>
Run `npm run build` - compiles without errors.
Check that ProgressDashboard.tsx exports a valid React component.
  </verify>
  <done>
ProgressDashboard component exists with:
- Props for questionIds, participantCount, voteCounts
- Overall progress bar + participant counts
- Per-question mini bars
- Pulse animation on count change
- CSS keyframes in index.css
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ProgressDashboard into AdminSession active batch view</name>
  <files>
    src/pages/AdminSession.tsx
  </files>
  <action>
In `src/pages/AdminSession.tsx`:

1. **Import ProgressDashboard:**
```typescript
import { ProgressDashboard } from '../components/ProgressDashboard';
```

2. **Derive vote counts for progress tracking:**
Add a useMemo after the existing sessionVotes state that computes voteCounts:
```typescript
const questionVoteCounts = useMemo(() => {
  const counts: Record<string, number> = {};
  for (const qId of Object.keys(sessionVotes)) {
    counts[qId] = sessionVotes[qId].length;
  }
  return counts;
}, [sessionVotes]);
```

3. **Get batch question IDs:**
When a batch is active (`activeBatchId` is set), get the question IDs:
```typescript
const activeBatchQuestionIds = useMemo(() => {
  if (!activeBatchId) return [];
  return questions.filter(q => q.batch_id === activeBatchId).map(q => q.id);
}, [activeBatchId, questions]);
```

4. **Render ProgressDashboard in active view:**
In the `{isActive && (` block, add the ProgressDashboard BEFORE the hero content, but ONLY when a batch is active:

```tsx
{/* Progress Dashboard - only during active batch */}
{activeBatchId && activeBatchQuestionIds.length > 0 && (
  <ProgressDashboard
    questionIds={activeBatchQuestionIds}
    participantCount={participantCount}
    voteCounts={questionVoteCounts}
  />
)}
```

Insert this immediately after the top header bar `<div className="border-b border-gray-200...">` and before the hero container `<div className="max-w-6xl mx-auto px-6"...>`.

5. **Keep dashboard visible after batch closes:**
The dashboard should remain visible with final stats after batch closes. When batch closes, `activeBatchId` becomes null but we want to show final stats. Add state to track this:

```typescript
const [lastActiveBatchId, setLastActiveBatchId] = useState<string | null>(null);
const [lastBatchQuestionIds, setLastBatchQuestionIds] = useState<string[]>([]);
```

Before closing a batch (in handleCloseBatch), capture the batch question IDs:
```typescript
// Capture for post-close display
setLastActiveBatchId(batchId);
setLastBatchQuestionIds(questions.filter(q => q.batch_id === batchId).map(q => q.id));
```

Update render condition:
```tsx
{(activeBatchId || lastActiveBatchId) && (
  <ProgressDashboard
    questionIds={activeBatchId ? activeBatchQuestionIds : lastBatchQuestionIds}
    participantCount={participantCount}
    voteCounts={questionVoteCounts}
  />
)}
```

Clear lastActiveBatchId when a new batch activates (in handleActivateBatch):
```typescript
setLastActiveBatchId(null);
setLastBatchQuestionIds([]);
```
  </action>
  <verify>
Run `npm run dev` and:
1. Create a session with a batch containing 2+ questions
2. Start session and go live
3. Activate the batch
4. Verify progress dashboard appears at top of active view
5. Cast votes from a participant tab - progress should update in real-time with pulse animation
6. Close batch - dashboard should remain with final stats
7. Activate a new batch - old dashboard should be replaced
  </verify>
  <done>
Progress dashboard integrated into AdminSession:
- Shows during active batch with real-time vote counts
- Persists with final stats after batch closes
- Clears when new batch activates
- Updates via existing postgres_changes + polling infrastructure
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Visual verification:
   - Progress dashboard visible during active batch
   - Overall progress bar fills as participants complete
   - Per-question mini bars show individual response counts
   - Pulse animation triggers on vote count increase
   - Dashboard persists after batch close with final stats
3. Real-time updates working (vote in participant tab, see update in admin)
</verification>

<success_criteria>
- PROG-01: Admin sees count of participants who completed the batch
- PROG-02: Admin sees count of participants in progress
- PROG-03: Admin sees per-question response counts
- PROG-04: Progress dashboard updates in real-time as participants answer
- Dashboard feels like a live sports scoreboard - glance and know status
</success_criteria>

<output>
After completion, create `.planning/phases/10-progress-dashboard-results-polish/10-01-SUMMARY.md`
</output>

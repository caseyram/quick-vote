---
phase: 16-image-slides
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20250210_030_session_items.sql
  - src/types/database.ts
  - src/lib/slide-api.ts
autonomous: false
user_setup:
  - service: supabase-storage
    why: "Image uploads require a Storage bucket and Storage RLS policies created via Supabase Dashboard"
    dashboard_config:
      - task: "Run the migration SQL in Dashboard SQL Editor to create session_items table and Storage RLS policies"
        location: "Supabase Dashboard -> SQL Editor -> New query -> paste migration content"
      - task: "Create 'session-images' Storage bucket via Dashboard"
        location: "Supabase Dashboard -> Storage -> New bucket -> name: session-images, Public: ON, Allowed MIME: image/jpeg,image/png,image/webp,image/gif, File size limit: 5MB"

must_haves:
  truths:
    - "session_items table exists in Supabase with correct columns, CHECK constraints, and RLS policies"
    - "session-images Storage bucket exists as a public bucket with upload/delete RLS policies for session creators"
    - "SessionItem and SessionItemType TypeScript types are defined and exported from database.ts"
    - "slide-api module exports functions for creating slides, deleting slides (with Storage cleanup), fetching session items, and constructing public image URLs"
  artifacts:
    - path: "supabase/migrations/20250210_030_session_items.sql"
      provides: "session_items table DDL, RLS policies, Storage RLS policies"
      contains: "CREATE TABLE session_items"
    - path: "src/types/database.ts"
      provides: "SessionItem and SessionItemType type definitions"
      contains: "SessionItemType"
    - path: "src/lib/slide-api.ts"
      provides: "Slide CRUD operations and Storage helpers"
      exports: ["createSlide", "deleteSlide", "fetchSessionItems", "getSlideImageUrl"]
  key_links:
    - from: "src/lib/slide-api.ts"
      to: "src/lib/supabase.ts"
      via: "imports supabase client for storage and database operations"
      pattern: "supabase\\.storage\\.from\\('session-images'\\)"
    - from: "src/lib/slide-api.ts"
      to: "src/types/database.ts"
      via: "imports SessionItem type"
      pattern: "import.*SessionItem.*from.*database"
---

<objective>
Create the database schema for session_items (unified sequence table with inline slide data), Storage bucket configuration, Storage RLS policies, TypeScript types, and the slide-api module with CRUD operations.

Purpose: Establish the data layer foundation that all image slide features depend on. Without the schema, bucket, and API module, no upload or display work can proceed.
Output: Migration SQL file, updated TypeScript types, and a slide-api module ready for use by the upload UI in Plan 16-02.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md

# Key source files to reference
@src/types/database.ts
@src/lib/supabase.ts
@src/lib/template-api.ts
@supabase/migrations/20250209_010_response_templates.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session_items migration and Storage RLS policies</name>
  <files>supabase/migrations/20250210_030_session_items.sql</files>
  <action>
Create a SQL migration file that includes:

**1. session_items table** (inline slide data, NOT a separate slides table):
```sql
CREATE TABLE session_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL REFERENCES sessions(session_id) ON DELETE CASCADE,
  item_type TEXT NOT NULL CHECK (item_type IN ('batch', 'slide')),
  position INTEGER NOT NULL DEFAULT 0,
  batch_id UUID REFERENCES batches(id) ON DELETE CASCADE,
  slide_image_path TEXT,
  slide_caption TEXT,
  CONSTRAINT valid_batch_item CHECK (
    item_type != 'batch' OR (batch_id IS NOT NULL AND slide_image_path IS NULL)
  ),
  CONSTRAINT valid_slide_item CHECK (
    item_type != 'slide' OR (batch_id IS NULL AND slide_image_path IS NOT NULL)
  ),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**2. Indexes:**
- `idx_session_items_session_id` on `session_id`
- `idx_session_items_position` on `(session_id, position)`

**3. RLS policies** (follow the exact pattern from `20250209_010_response_templates.sql` but with session-creator checks like batches/questions):
- Enable RLS
- SELECT: anyone authenticated can read
- INSERT: session creator can insert (EXISTS subquery on sessions.created_by = auth.uid())
- UPDATE: session creator can update (same check)
- DELETE: session creator can delete (same check)

**4. Storage RLS policies** for the `session-images` bucket on `storage.objects`:
```sql
CREATE POLICY "Anyone can view session images"
  ON storage.objects FOR SELECT TO authenticated
  USING (bucket_id = 'session-images');

CREATE POLICY "Session creators can upload images"
  ON storage.objects FOR INSERT TO authenticated
  WITH CHECK (
    bucket_id = 'session-images'
    AND EXISTS (
      SELECT 1 FROM public.sessions
      WHERE sessions.session_id = (storage.foldername(name))[1]
      AND sessions.created_by = (SELECT auth.uid())
    )
  );

CREATE POLICY "Session creators can delete images"
  ON storage.objects FOR DELETE TO authenticated
  USING (
    bucket_id = 'session-images'
    AND EXISTS (
      SELECT 1 FROM public.sessions
      WHERE sessions.session_id = (storage.foldername(name))[1]
      AND sessions.created_by = (SELECT auth.uid())
    )
  );
```

**CRITICAL decisions from research:**
- Do NOT add session_items to `supabase_realtime` publication (Pitfall 15: admin-only state, use Broadcast instead)
- Do NOT create a separate slides table (inline data is simpler for 2 fields)
- Storage path convention: `{session_id}/{uuid}.{ext}` -- the `storage.foldername(name)[1]` extracts session_id for ownership verification

Use the same migration file header pattern as `20250209_010_response_templates.sql`.
  </action>
  <verify>File exists at supabase/migrations/20250210_030_session_items.sql and contains CREATE TABLE session_items, all 4 RLS policies for session_items, and all 3 Storage RLS policies for session-images bucket.</verify>
  <done>Migration SQL file is complete with session_items table (CHECK constraints, indexes, RLS) and Storage RLS policies. Ready for manual application via Supabase Dashboard SQL Editor.</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types and create slide-api module</name>
  <files>src/types/database.ts, src/lib/slide-api.ts</files>
  <action>
**1. Update `src/types/database.ts`** -- add at the end of the file:
```typescript
export type SessionItemType = 'batch' | 'slide';

export interface SessionItem {
  id: string;
  session_id: string;
  item_type: SessionItemType;
  position: number;
  batch_id: string | null;
  slide_image_path: string | null;
  slide_caption: string | null;
  created_at: string;
}
```

**2. Create `src/lib/slide-api.ts`** -- follow the pattern from `template-api.ts` (separate API module):

The module should export these functions:

**`fetchSessionItems(sessionId: string): Promise<SessionItem[]>`**
- Query `session_items` table filtered by session_id, ordered by position ascending
- Return the array of SessionItem objects

**`createSlide(sessionId: string, imagePath: string, caption: string | null): Promise<SessionItem>`**
- Determine next position: query max position for session, add 1 (or 0 if none)
- Insert into session_items with item_type='slide', the imagePath as slide_image_path, caption as slide_caption
- Return the created SessionItem
- Throw on error

**`updateSlideCaption(itemId: string, caption: string | null): Promise<void>`**
- Update session_items row where id = itemId, set slide_caption = caption
- Throw on error

**`deleteSlide(itemId: string, imagePath: string): Promise<void>`**
- FIRST delete the Storage object: `supabase.storage.from('session-images').remove([imagePath])`
- THEN delete the session_items row
- This order prevents orphaned Storage files (Pitfall 1)
- If Storage delete fails, still attempt DB delete but log warning
- Throw on DB delete error

**`getSlideImageUrl(imagePath: string): string`**
- Use `supabase.storage.from('session-images').getPublicUrl(imagePath)`
- Return data.publicUrl
- This is a synchronous operation (constructs URL, no network call)

**`uploadSlideImage(sessionId: string, file: File): Promise<string>`**
- Generate unique filename: `${sessionId}/${crypto.randomUUID()}.${getExtension(file)}`
  - Helper: extract extension from file.name or derive from file.type (image/webp -> webp, image/jpeg -> jpg, image/png -> png, image/gif -> gif)
- Upload: `supabase.storage.from('session-images').upload(path, file, { cacheControl: '31536000', contentType: file.type, upsert: false })`
- Return the path string (NOT the full URL -- store relative paths per research)
- Throw on error with descriptive message

Import `supabase` from `../lib/supabase` and `SessionItem` from `../types/database`.
  </action>
  <verify>
Run: `npx tsc --noEmit` to verify TypeScript compilation succeeds with new types and module.
Verify `src/lib/slide-api.ts` exports all 6 functions.
Verify `src/types/database.ts` exports SessionItem and SessionItemType.
  </verify>
  <done>TypeScript types are defined, slide-api module compiles and exports all CRUD + Storage helper functions. The module follows the existing template-api.ts pattern.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Apply migration and create Storage bucket in Supabase Dashboard</name>
  <action>
The migration SQL and Storage bucket must be created manually via Supabase Dashboard (per MEMORY.md: migrations must be applied manually, supabase db push fails).
  </action>
  <instructions>
1. **Apply migration SQL:**
   - Open Supabase Dashboard -> SQL Editor -> New query
   - Paste the contents of `supabase/migrations/20250210_030_session_items.sql`
   - Run the query
   - Verify: "Success. No rows returned" (for DDL statements)

2. **Create Storage bucket:**
   - Open Supabase Dashboard -> Storage -> "New bucket"
   - Name: `session-images`
   - Public bucket: ON (toggle enabled)
   - Allowed MIME types: `image/jpeg, image/png, image/webp, image/gif`
   - File size limit: `5` MB
   - Click "Create bucket"

3. **Verify:**
   - In SQL Editor, run: `SELECT * FROM session_items LIMIT 1;` -- should return empty result (not error)
   - In SQL Editor, run: `SELECT id, name, public FROM storage.buckets WHERE id = 'session-images';` -- should show one row with public=true
   - In Storage, the `session-images` bucket should appear in the bucket list
  </instructions>
  <resume-signal>Type "applied" once migration is run and bucket is created, or describe any errors.</resume-signal>
</task>

</tasks>

<verification>
1. `supabase/migrations/20250210_030_session_items.sql` exists with session_items CREATE TABLE, CHECK constraints, indexes, RLS policies, and Storage RLS policies
2. `src/types/database.ts` exports SessionItem and SessionItemType types
3. `src/lib/slide-api.ts` exports fetchSessionItems, createSlide, updateSlideCaption, deleteSlide, getSlideImageUrl, uploadSlideImage
4. `npx tsc --noEmit` passes
5. Migration has been applied to Supabase and session-images bucket exists
</verification>

<success_criteria>
- session_items table schema is defined with inline slide data (NOT a separate slides table)
- Storage RLS policies enforce session-creator ownership for uploads and deletes
- TypeScript types match the SQL schema exactly
- slide-api module provides complete CRUD + Storage operations following template-api.ts patterns
- Migration applied to Supabase Dashboard, bucket created and public
</success_criteria>

<output>
After completion, create `.planning/phases/16-image-slides/16-01-SUMMARY.md`
</output>

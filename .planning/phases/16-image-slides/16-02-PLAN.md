---
phase: 16-image-slides
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/ImageUploader.tsx
  - src/components/SlideManager.tsx
  - src/components/AdminSession.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can click an upload button, select an image file, see it compressed client-side, and have it uploaded to Supabase Storage"
    - "Non-image files and files over 10MB are rejected with a clear error message before upload"
    - "Admin can see uploaded slides listed with thumbnail preview and optional caption"
    - "Admin can edit the caption/label on a slide and see it update"
    - "Admin can delete a slide and have the Storage file automatically removed"
    - "Admin can view an uploaded image displayed full-screen in a preview area with correct aspect ratio (object-contain, no cropping)"
  artifacts:
    - path: "src/components/ImageUploader.tsx"
      provides: "Reusable image upload component with compression, validation, and preview"
      min_lines: 80
    - path: "src/components/SlideManager.tsx"
      provides: "Slide list with create, edit caption, delete, and full-screen preview"
      min_lines: 100
    - path: "src/components/AdminSession.tsx"
      provides: "Integration of SlideManager into the admin draft view"
      contains: "SlideManager"
  key_links:
    - from: "src/components/ImageUploader.tsx"
      to: "src/lib/slide-api.ts"
      via: "calls uploadSlideImage for Storage upload"
      pattern: "uploadSlideImage"
    - from: "src/components/SlideManager.tsx"
      to: "src/lib/slide-api.ts"
      via: "calls createSlide, deleteSlide, updateSlideCaption, fetchSessionItems, getSlideImageUrl"
      pattern: "(createSlide|deleteSlide|fetchSessionItems)"
    - from: "src/components/AdminSession.tsx"
      to: "src/components/SlideManager.tsx"
      via: "renders SlideManager in draft view"
      pattern: "<SlideManager"
---

<objective>
Build the image upload pipeline with client-side compression and the slide management UI (create, list, edit caption, delete, full-screen preview) integrated into the admin session draft view.

Purpose: This is the user-facing feature that lets admins upload and manage image slides. It depends on the schema and API from Plan 16-01.
Output: Working ImageUploader component, SlideManager component, and integration into AdminSession.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
@.planning/phases/16-image-slides/16-01-SUMMARY.md

# Key source files to reference
@src/lib/slide-api.ts
@src/types/database.ts
@src/lib/supabase.ts
@src/components/AdminSession.tsx
@src/components/ResponseTemplatePanel.tsx
@src/components/TemplateEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install browser-image-compression and create ImageUploader component</name>
  <files>src/components/ImageUploader.tsx</files>
  <action>
**1. Install dependency:**
```bash
npm install browser-image-compression@^2.0.2
```

**2. Create `src/components/ImageUploader.tsx`:**

Props interface:
```typescript
interface ImageUploaderProps {
  sessionId: string;
  onUploaded: (imagePath: string) => void;
  disabled?: boolean;
}
```

**Component behavior:**

A. **File input** -- styled as a button or drop area:
   - `<input type="file" accept="image/jpeg,image/png,image/webp,image/gif">` (hidden, triggered by button click)
   - Button text: "Upload Image" with a camera/image icon
   - Admin light theme: bg-white border border-gray-300 rounded-lg, hover:border-blue-400

B. **Client-side validation** (before compression):
   - Check `file.type` is one of: `image/jpeg`, `image/png`, `image/webp`, `image/gif`
   - Reject SVG explicitly (Pitfall 5/10: SVG can contain scripts)
   - Check `file.size <= 10 * 1024 * 1024` (10MB raw -- will be compressed down)
   - If validation fails, show error message (red text below button) and do NOT proceed
   - Content check: load file into `new Image()` via `URL.createObjectURL()`. If `onerror` fires, reject as "File is not a valid image"

C. **Client-side compression** using browser-image-compression:
   ```typescript
   import imageCompression from 'browser-image-compression';

   const options = {
     maxSizeMB: 1,
     maxWidthOrHeight: 1920,
     useWebWorker: true,
     fileType: 'image/webp' as const,
     initialQuality: 0.85,
     preserveExif: false,
   };
   const compressed = await imageCompression(file, options);
   ```

D. **Upload** via slide-api:
   - Call `uploadSlideImage(sessionId, compressed)` from slide-api.ts
   - Show loading state during compression + upload (spinner or progress text: "Compressing...", "Uploading...")
   - Disable the upload button during upload to prevent duplicates (Pitfall 9)
   - On success: call `onUploaded(imagePath)` with the returned path
   - On error: show error message, re-enable button

E. **Preview** -- after selecting a file (before upload completes), show a small thumbnail preview using `URL.createObjectURL(file)`. Clean up with `URL.revokeObjectURL()` on unmount or when new file selected.

F. **States:** idle, validating, compressing, uploading, error. Use a single `status` state variable.

**Styling:** Admin light theme (bg-white, text-gray-900, border-gray-300). Follow the existing button/input patterns from QuestionForm or TemplateEditor.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- should pass with no errors.
Verify the component renders without crashes: check AdminSession integration in Task 3.
Check that `browser-image-compression` appears in package.json dependencies.
  </verify>
  <done>ImageUploader component validates file type/size/content, compresses with browser-image-compression, uploads to Supabase Storage via slide-api, shows progress states, and returns the image path on success.</done>
</task>

<task type="auto">
  <name>Task 2: Create SlideManager component with CRUD and preview</name>
  <files>src/components/SlideManager.tsx</files>
  <action>
Create `src/components/SlideManager.tsx` -- a panel that manages slides for a session.

**Props:**
```typescript
interface SlideManagerProps {
  sessionId: string;
}
```

**Component structure:**

```
SlideManager (card panel, similar to ResponseTemplatePanel layout)
  |-- Header: "Image Slides" with count badge
  |-- ImageUploader (for adding new slides)
  |-- Slide list (ordered by position)
  |     |-- Each slide row:
  |     |     |-- Thumbnail (48x48, object-cover, rounded)
  |     |     |-- Caption text (editable inline) or "No caption" placeholder
  |     |     |-- "Preview" button (opens full-screen preview)
  |     |     |-- "Delete" button (with confirm dialog)
  |-- Empty state: "No slides yet. Upload an image to get started."
  |-- Full-screen preview overlay (when preview is open)
```

**Behavior:**

A. **Load slides on mount:**
   - Call `fetchSessionItems(sessionId)` from slide-api
   - Filter to `item_type === 'slide'` items only
   - Store in local state `slides: SessionItem[]`

B. **Create slide (on ImageUploader upload complete):**
   - When `onUploaded` fires with imagePath, call `createSlide(sessionId, imagePath, null)`
   - Add the returned SessionItem to local state
   - Show brief success feedback

C. **Edit caption:**
   - Click on caption area to enter edit mode (inline text input)
   - On blur or Enter, call `updateSlideCaption(item.id, newCaption)`
   - Update local state
   - Keep it simple: single text input, not a modal

D. **Delete slide:**
   - Show confirm dialog: "Delete this slide? The image will be permanently removed."
   - Use the existing ConfirmDialog component pattern if available, or `window.confirm()`
   - On confirm, call `deleteSlide(item.id, item.slide_image_path!)` from slide-api
   - This handles Storage cleanup automatically (Pitfall 1: orphaned images)
   - Remove from local state

E. **Full-screen preview:**
   - Click "Preview" on a slide to open a full-screen overlay
   - Overlay: fixed inset-0, bg-black/90, flex items-center justify-center
   - Image: `object-contain` to maintain aspect ratio, max-w-full max-h-full (IMG-02 requirement)
   - Close button in top-right corner, also close on Escape key or overlay click
   - Caption displayed below image if present (small white text)

F. **Thumbnail display:**
   - Use `getSlideImageUrl(slide.slide_image_path!)` to construct the display URL
   - `<img>` with `object-cover` for list thumbnails, `object-contain` for full-screen preview
   - Add `loading="lazy"` for thumbnails
   - Fallback on error: show a gray placeholder with "Image not found" text

**Styling:** Admin light theme. Card layout with `bg-white rounded-lg shadow-sm border border-gray-200 p-4`. Similar layout to ResponseTemplatePanel (collapsible section in admin draft view). The panel should appear below the existing batch/question management area.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- should pass.
Visually verify the component renders a card with upload button and empty state (integration in Task 3).
  </verify>
  <done>SlideManager component displays a slide list with thumbnails, inline caption editing, delete with Storage cleanup, full-screen preview with object-contain, and integrates ImageUploader for adding new slides.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SlideManager into AdminSession draft view</name>
  <files>src/components/AdminSession.tsx</files>
  <action>
**1. Import and render SlideManager:**
- Import `SlideManager` from `./SlideManager`
- In the draft view section of AdminSession (where BatchList, ResponseTemplatePanel, TemplatePanel, etc. are rendered), add `<SlideManager sessionId={session.session_id} />`
- Place it AFTER the ResponseTemplatePanel section (or after TemplatePanel if that comes after)
- The SlideManager should appear as its own card/section in the admin draft view

**2. Conditional rendering:**
- Only show SlideManager when session status is 'draft' (same pattern as other edit components)
- Do NOT show in lobby, active, or ended views

**3. No state wiring needed yet:**
- SlideManager manages its own local state for slides
- The session_items store integration will come in Phase 17 (Unified Sequence)
- For now, SlideManager is a self-contained panel that reads/writes directly via slide-api

Keep changes minimal -- only add the import and render the component in the right location.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- should pass.
Run: `npm run dev` and navigate to an admin session in draft mode. The "Image Slides" panel should appear below the existing management sections.
  </verify>
  <done>SlideManager is rendered in the admin draft view. Admin can upload images, see slides listed, edit captions, delete slides, and preview images full-screen.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete image slide upload pipeline: client-side compression, Supabase Storage upload, slide CRUD (create, list, edit caption, delete with Storage cleanup), and full-screen preview in admin draft view.</what-built>
  <how-to-verify>
1. Open the app in dev mode (`npm run dev`)
2. Navigate to an admin session in draft mode
3. Scroll down to find the "Image Slides" panel
4. **Upload test:** Click "Upload Image", select a JPEG or PNG file (preferably 2MB+). Verify:
   - You see a compression/upload progress indicator
   - The image appears in the slide list with a thumbnail
   - Check Supabase Dashboard -> Storage -> session-images -- the file should be there
5. **Validation test:** Try uploading a .txt or .pdf file. Verify it is rejected with a clear error message.
6. **Caption test:** Click the caption area on a slide, type a caption, press Enter. Verify the caption persists after page refresh.
7. **Preview test:** Click "Preview" on a slide. Verify the image displays full-screen with correct aspect ratio (no stretching or cropping). Close the preview with Escape or clicking outside.
8. **Delete test:** Click "Delete" on a slide, confirm. Verify:
   - The slide disappears from the list
   - Check Supabase Dashboard -> Storage -> session-images -- the file should be removed
9. **Multiple slides:** Upload 2-3 images. Verify they all appear in order.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `browser-image-compression` is in package.json dependencies
2. ImageUploader validates type/size/content, compresses, uploads, shows progress
3. SlideManager displays slides with thumbnails, inline caption editing, delete with confirm, full-screen preview
4. SlideManager appears in AdminSession draft view
5. `npx tsc --noEmit` passes
6. Delete operation removes both DB row and Storage file
7. Full-screen preview uses object-contain for correct aspect ratio
</verification>

<success_criteria>
- Admin can upload an image, see it compressed and uploaded to Supabase Storage
- Non-image files and oversized files are rejected with clear error messages
- Admin can view, edit captions, preview full-screen, and delete slides
- Deleting a slide removes the Storage file (no orphaned images)
- Full-screen preview displays images with correct aspect ratio (object-contain)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-image-slides/16-02-SUMMARY.md`
</output>

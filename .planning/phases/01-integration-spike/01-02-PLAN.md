---
phase: 01-integration-spike
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/App.tsx
  - src/pages/Demo.tsx
autonomous: false

must_haves:
  truths:
    - "App reads rows from the Supabase test_messages table and displays them"
    - "App writes a new row to test_messages and it appears in the list"
    - "Opening two browser tabs, a Broadcast message sent from one appears in the other"
    - "Writing to test_messages in one tab triggers a Postgres Changes event visible in the other tab"
    - "The app is live on a Vercel URL and all four behaviors work there too"
  artifacts:
    - path: "src/pages/Demo.tsx"
      provides: "Integration PoC page with Supabase read/write, Broadcast, and Postgres Changes demos"
      min_lines: 80
    - path: "src/App.tsx"
      provides: "App entry point rendering the Demo page"
  key_links:
    - from: "src/pages/Demo.tsx"
      to: "src/lib/supabase.ts"
      via: "import { supabase }"
      pattern: "import.*supabase.*from.*lib/supabase"
    - from: "src/pages/Demo.tsx"
      to: "Supabase test_messages table"
      via: "supabase.from('test_messages')"
      pattern: "from\\(['\"]test_messages['\"]\\)"
    - from: "src/pages/Demo.tsx"
      to: "Supabase Realtime Broadcast"
      via: "channel.send({ type: 'broadcast' })"
      pattern: "type:\\s*['\"]broadcast['\"]"
    - from: "src/pages/Demo.tsx"
      to: "Supabase Realtime Postgres Changes"
      via: "channel.on('postgres_changes', ...)"
      pattern: "postgres_changes"
---

<objective>
Build an integration proof-of-concept page that validates all four Supabase capabilities (read, write, Broadcast realtime, Postgres Changes realtime), then deploy to Vercel and verify everything works on the live URL.

Purpose: Prove the full Vite+React+Supabase+Vercel pipeline works end-to-end before any feature code is written. This is the gate for proceeding to Phase 2.
Output: A live Vercel deployment with a working demo page that proves all integration points.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-integration-spike/01-CONTEXT.md
@.planning/phases/01-integration-spike/01-01-SUMMARY.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Supabase integration PoC page</name>
  <files>
    src/pages/Demo.tsx
    src/App.tsx
  </files>
  <action>
    Create `src/pages/Demo.tsx` -- a single page that demonstrates all four integration points. The page should have three clearly labeled sections with visual feedback:

    **Section 1: Database Read/Write**
    - On mount, fetch all rows from `test_messages` table using `supabase.from('test_messages').select('*').order('created_at', { ascending: false })`
    - Display them in a list (show content and created_at)
    - Provide a text input and "Add Message" button
    - On submit, insert a new row: `supabase.from('test_messages').insert({ content: inputValue })`
    - After successful insert, re-fetch or optimistically add to the list
    - Show a status indicator: "Connected" if the initial fetch succeeds, "Error" if it fails

    **Section 2: Broadcast (pub/sub) Realtime**
    - Subscribe to a Supabase Broadcast channel named `demo-broadcast`
    - Listen for event `test_ping` on the channel
    - Provide a "Send Broadcast" button that sends: `channel.send({ type: 'broadcast', event: 'test_ping', payload: { message: 'Hello from tab!', timestamp: new Date().toISOString() } })`
    - Display received broadcast messages in a log area
    - Show channel subscription status (subscribing, subscribed, error)
    - Instructions on the page: "Open this page in two tabs. Click 'Send Broadcast' in one tab -- the message should appear in the other tab."

    **Section 3: Postgres Changes Realtime**
    - Subscribe to Postgres Changes on the `test_messages` table: `channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'test_messages' }, callback)`
    - Display received change events in a log area (show the new row's content)
    - Instructions on the page: "Open this page in two tabs. Add a message in one tab -- the new row should appear in the other tab's Postgres Changes log automatically."

    **Implementation notes:**
    - Use a single Supabase channel for both Broadcast and Postgres Changes (multiplexed on one channel) to validate the pattern from ARCHITECTURE.md research
    - Channel name: `demo-room`
    - Clean up subscriptions on unmount (return cleanup function from useEffect)
    - Use Tailwind for layout: flex column, max-w-2xl centered, sections separated by borders or cards
    - Each section should have a heading, status indicator, and interaction area
    - Use React state (useState) for all local state -- no external state library needed for the PoC

    **Update `src/App.tsx`:**
    - Import and render the Demo page as the main content
    - Keep it simple -- no routing needed yet. Just render `<Demo />` directly.
  </action>
  <verify>
    - `npm run dev` shows the Demo page with all three sections
    - Section 1: Messages load from Supabase (or shows empty list if table is empty). Adding a message via the form inserts into DB and appears in the list.
    - Section 2: Broadcast channel shows "subscribed" status. (Two-tab test happens in checkpoint.)
    - Section 3: Postgres Changes subscription is active. (Two-tab test happens in checkpoint.)
    - `npm run build` succeeds without errors
    - No console errors related to Supabase connection
  </verify>
  <done>
    Demo page renders with three working sections. Database read/write works in a single tab. Realtime subscriptions are active and ready for multi-tab testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to Vercel</name>
  <files></files>
  <action>
    Deploy the project to Vercel. Try the following approach in order:

    1. **Preferred: Vercel CLI**
       - Run `npx vercel --yes` to deploy (auto-confirms defaults)
       - If this is the first deploy, it will prompt for project linking. Use defaults.
       - If the CLI is not authenticated, this will fail -- proceed to option 2.

    2. **Fallback: Git push to trigger Vercel auto-deploy**
       - The user's CONTEXT.md says "Auto-deploy on push to main branch"
       - Commit all project files: `git add -A && git commit -m "feat(01): scaffold Vite+React+TS project with Supabase client and integration PoC"`
       - Push to origin/main: `git push origin main`
       - The user will need to have connected the repo to Vercel (checkpoint handles this)

    **Important:** Environment variables (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY) must be configured in the Vercel dashboard for the production build to work. The checkpoint task handles this.

    After deployment, capture the Vercel URL from the CLI output or note that the user needs to find it in their Vercel dashboard.
  </action>
  <verify>
    - Deployment command completes (either Vercel CLI or git push)
    - If Vercel CLI: deployment URL is printed
    - `npm run build` succeeds locally (confirming the build Vercel will run also succeeds)
  </verify>
  <done>
    Code is deployed (or pushed for auto-deploy). Ready for user to configure Vercel env vars and verify the live URL.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end integration on live Vercel URL</name>
  <what-built>
    A demo page with three sections proving Supabase integration:
    1. Database read/write (fetch and insert test_messages)
    2. Broadcast realtime (pub/sub between tabs)
    3. Postgres Changes realtime (DB writes trigger events in other tabs)

    The app has been deployed to Vercel.
  </what-built>
  <how-to-verify>
    **Before testing -- Vercel environment setup:**
    If you haven't already:
    1. Go to your Vercel dashboard (https://vercel.com/dashboard)
    2. If the project isn't linked yet: Import the Git repository
    3. Go to Project Settings > Environment Variables
    4. Add: VITE_SUPABASE_URL = (your Supabase project URL)
    5. Add: VITE_SUPABASE_ANON_KEY = (your Supabase anon key)
    6. Redeploy if env vars were added after the initial deploy (Settings > Deployments > Redeploy)

    **Test 1: Database Read/Write**
    1. Open the live Vercel URL in your browser
    2. The Demo page should load with the "Database Read/Write" section showing "Connected"
    3. Type a message and click "Add Message"
    4. The message should appear in the list

    **Test 2: Broadcast Realtime**
    1. Open the Vercel URL in TWO browser tabs side by side
    2. Wait for both to show "subscribed" status on the Broadcast section
    3. In Tab 1, click "Send Broadcast"
    4. Tab 2 should show the received message in its Broadcast log (and vice versa)

    **Test 3: Postgres Changes Realtime**
    1. Keep both tabs open
    2. In Tab 1, add a new message via the Database section
    3. Tab 2's "Postgres Changes" log should show the new row automatically
    4. Try the reverse: add a message in Tab 2, see it in Tab 1's log

    **Test 4: Basic deployment health**
    1. Refresh the page -- it should reload cleanly (no 404)
    2. Navigate directly to the URL (paste it fresh) -- should load (vercel.json rewrite working)
  </how-to-verify>
  <resume-signal>
    Type "approved" if all four tests pass.
    If any test fails, describe which one and what you observed.
  </resume-signal>
</task>

</tasks>

<verification>
All five Phase 1 success criteria validated:
1. Vite + React + TypeScript project scaffolded with Tailwind CSS (Plan 01, Task 1)
2. Supabase project connected -- can read/write from test table (Plan 02, Task 1 + Task 3 Test 1)
3. Deployed to Vercel -- live URL works (Plan 02, Task 2 + Task 3 Test 4)
4. Supabase Realtime subscription works -- both Broadcast and Postgres Changes (Plan 02, Task 3 Tests 2-3)
5. Environment variables properly configured in Vercel (Plan 02, Task 3 setup steps)
</verification>

<success_criteria>
The live Vercel URL loads the QuickVote demo page. A user can add messages to the Supabase test table. Opening two tabs demonstrates both Broadcast (instant pub/sub) and Postgres Changes (DB-driven events) working in real time. The full Vite+React+Supabase+Vercel pipeline is proven.
</success_criteria>

<output>
After completion, create `.planning/phases/01-integration-spike/01-02-SUMMARY.md`
</output>

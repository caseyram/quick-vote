---
phase: 09.1-consolidate-batch-go-live
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/BatchVotingCarousel.tsx
autonomous: true

must_haves:
  truths:
    - "Participant navigates questions with Next button (no submission per question)"
    - "Participant sees Submit button on final question instead of Next"
    - "All votes are submitted together when Submit is clicked"
    - "Participant goes directly to waiting state after submit (no review screen)"
  artifacts:
    - path: "src/components/BatchVotingCarousel.tsx"
      provides: "Batch voting carousel with Submit All flow"
      contains: "handleSubmitAll"
  key_links:
    - from: "BatchVotingCarousel"
      to: "supabase.from('votes').upsert"
      via: "handleSubmitAll function"
      pattern: "upsert.*votes"
    - from: "Submit button"
      to: "onComplete callback"
      via: "handleSubmitAll -> onComplete"
      pattern: "onComplete\\(\\)"
---

<objective>
Verify and document the Submit All flow in BatchVotingCarousel.

Purpose: Ensure participants can navigate through batch questions without per-question submission, then submit all votes at once on the final question. No review screen - submission goes directly to waiting state.

Output: Verified batch carousel with Submit All functionality.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/BatchVotingCarousel.tsx
@src/pages/ParticipantSession.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify BatchVotingCarousel Submit All implementation</name>
  <files>src/components/BatchVotingCarousel.tsx</files>
  <action>
Read BatchVotingCarousel and verify Submit All flow:

1. Local state for pending votes:
   - `pendingVotes` Map<string, { value: string; reason?: string }>
   - Updates via `handleSelectionChange` callback

2. Navigation:
   - "Next" button navigates without submission (setCurrentIndex)
   - "Previous" button navigates backward
   - No auto-submission on selection

3. Final question behavior:
   - Shows "Submit" button instead of "Next" when isLastQuestion
   - "Submit" button calls handleSubmitAll()

4. handleSubmitAll implementation:
   - Builds array of vote payloads from pendingVotes
   - Upserts all votes in single supabase call
   - Calls onComplete() after submission (success or error)
   - No review screen step

5. Verify NO BatchReviewScreen import or usage exists.

Document findings. If any issues, fix them.
  </action>
  <verify>
Run: `grep -n "handleSubmitAll\|pendingVotes\|isLastQuestion\|Submit" src/components/BatchVotingCarousel.tsx`
Expect: All patterns present showing Submit All flow implementation.
  </verify>
  <done>
BatchVotingCarousel implements:
- pendingVotes Map for local vote tracking
- Next/Previous navigation without submission
- "Submit" button on last question
- handleSubmitAll that upserts all votes at once
- Direct transition to waiting state (no review screen)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify cleanup - no BatchReviewScreen</name>
  <files>src/components/</files>
  <action>
Verify BatchReviewScreen component does not exist:

1. Check for BatchReviewScreen.tsx file: `ls src/components/BatchReviewScreen.tsx`
2. Search for any BatchReviewScreen imports: `grep -r "BatchReviewScreen" src/`
3. Search for showReview state: `grep -r "showReview" src/components/BatchVotingCarousel.tsx`

If BatchReviewScreen.tsx exists, delete it.
If any imports reference it, remove those imports.
If showReview state exists, remove that logic.

The flow should be:
- User answers questions
- User clicks Submit on last question
- handleSubmitAll runs
- onComplete() is called
- Parent transitions to waiting/complete state
  </action>
  <verify>
Run: `ls src/components/BatchReviewScreen.tsx 2>/dev/null || echo "File does not exist (good)"`
Run: `grep -r "BatchReviewScreen" src/ || echo "No references found (good)"`
  </verify>
  <done>
- BatchReviewScreen.tsx does not exist
- No imports of BatchReviewScreen anywhere in codebase
- No showReview state in BatchVotingCarousel
- Submit goes directly to onComplete (waiting state)
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end manual test of batch Go Live flow</name>
  <files>N/A</files>
  <action>
Run the dev server and perform end-to-end test:

**Admin flow:**
1. Go to admin session
2. In active state, type question in input
3. Click "+ Batch" to add to pending batch
4. Add 2-3 more questions to batch
5. Click "Go Live" to activate batch

**Participant flow:**
1. Open participant URL
2. Verify batch carousel appears with first question
3. Make selection (verify no immediate submission)
4. Click "Next" to go to question 2
5. Make selection on question 2
6. Click "Previous" to go back to question 1
7. Verify previous selection is still shown
8. Navigate to last question
9. Verify "Submit" button appears (not "Next")
10. Click "Submit"
11. Verify transition to waiting/complete state
12. Check admin view shows votes arrived

Document any issues found during testing.
  </action>
  <verify>
Manual testing via `npm run dev` on localhost.
  </verify>
  <done>
End-to-end flow verified:
- Admin can build batch with "+ Batch" and activate with "Go Live"
- Participant navigates carousel with selections preserved
- Submit on last question sends all votes at once
- No review screen - direct to completion
  </done>
</task>

</tasks>

<verification>
1. BatchVotingCarousel has handleSubmitAll that upserts all votes
2. No BatchReviewScreen file or references exist
3. End-to-end flow works: build batch -> go live -> vote -> submit all
</verification>

<success_criteria>
- pendingVotes Map tracks selections locally
- "Next" button navigates without submission
- "Submit" button on last question calls handleSubmitAll
- handleSubmitAll upserts all votes in single request
- No review screen - onComplete called directly after submit
- BatchReviewScreen does not exist (cleanup verified)
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-consolidate-batch-go-live/09.1-02-SUMMARY.md`
</output>

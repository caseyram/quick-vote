---
phase: 14-export-import-integration
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/SessionImportExport.tsx
  - src/components/ImportSessionPanel.tsx
  - src/lib/session-import.test.ts
autonomous: true

must_haves:
  truths:
    - "Import success message includes template count: 'Imported N batches, M questions, K templates'"
    - "SessionImportExport export button passes templates to exportSessionData"
    - "ImportSessionPanel accepts templateCount in onImportComplete callback"
    - "Tests verify template fields in export schema and import schema backward compat"
    - "Old export files (pre-template) import successfully without template fields"
    - "Existing tests still pass (no regressions)"
  artifacts:
    - path: "src/components/SessionImportExport.tsx"
      provides: "Template-aware export (passes templates from store) and import callback with templateCount"
      contains: "templateCount"
    - path: "src/components/ImportSessionPanel.tsx"
      provides: "Updated onImportComplete type with templateCount"
      contains: "templateCount"
    - path: "src/lib/session-import.test.ts"
      provides: "Tests for template fields in exportSessionData and ImportSchema backward compat"
      contains: "template"
  key_links:
    - from: "src/components/SessionImportExport.tsx"
      to: "src/lib/session-import.ts"
      via: "exportSessionData call with templates parameter"
      pattern: "exportSessionData.*templates"
    - from: "src/components/SessionImportExport.tsx"
      to: "src/stores/template-store.ts"
      via: "useTemplateStore to get templates for export"
      pattern: "useTemplateStore"
---

<objective>
Wire template export/import into UI components and add tests for the new template functionality.

Purpose: The core logic from Plan 01 must be connected to the UI so that export actually includes templates and import displays template counts. Tests ensure the schema extensions work correctly and backward compatibility is preserved.

Output: Updated UI components with template-aware import/export, and test coverage for template schema fields.
</objective>

<execution_context>
@C:\Users\cramo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cramo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-export-import-integration/14-CONTEXT.md
@.planning/phases/14-export-import-integration/14-01-SUMMARY.md
@src/components/SessionImportExport.tsx
@src/components/ImportSessionPanel.tsx
@src/lib/session-import.test.ts
@src/stores/template-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update UI components for template-aware import/export</name>
  <files>
    src/components/SessionImportExport.tsx
    src/components/ImportSessionPanel.tsx
  </files>
  <action>
    **SessionImportExport.tsx:**

    1. Update the `onImportComplete` callback type in `SessionImportExportProps` to include `templateCount`:
       ```
       onImportComplete?: (result: { batchCount: number; questionCount: number; templateCount: number }) => void;
       ```

    2. Import `useTemplateStore` from `../stores/template-store`.

    3. In the component body, get templates from the store:
       ```
       const templates = useTemplateStore((s) => s.templates);
       ```

    4. Update `handleExport` to pass templates to `exportSessionData`:
       ```
       const json = exportSessionData(questions, batches, sessionName, templates);
       ```
       This passes the full template objects from the Zustand store. `exportSessionData` (modified in Plan 01) filters to only include templates referenced by questions and maps template_id UUIDs to names.

       Note on type compatibility: `exportSessionData` expects `Array<{ id: string; name: string; options: string[] }>`. The `ResponseTemplate` type from the store has these fields plus `created_at` and `updated_at`, which is structurally compatible since TypeScript allows extra properties in this direction. No type cast needed.

    5. Update the import preview message to include template count when available. In the `previewInfo` computation, also count templates from validated data:
       ```
       templates: validatedData.templates?.length ?? 0,
       ```
       Update the preview text to show template count if > 0:
       ```
       {previewInfo.templates > 0 ? `, ${previewInfo.templates} template${previewInfo.templates !== 1 ? 's' : ''}` : ''}
       ```

    6. The `handleImport` function already calls `importSessionData` and passes the result to `onImportComplete`. Since Plan 01 adds `templateCount` to the return, this will work automatically. No changes needed in handleImport.

    **ImportSessionPanel.tsx:**

    1. Update the `onImportComplete` callback type in `ImportSessionPanelProps`:
       ```
       onImportComplete?: (result: { batchCount: number; questionCount: number; templateCount: number }) => void;
       ```

    2. Update the preview info to include template count:
       ```
       templates: validatedData.templates?.length ?? 0,
       ```

    3. Update the preview text to show template count if > 0.

    **AdminSession.tsx (if needed):**
    Check if `onImportComplete` callback in AdminSession.tsx destructures the result. Since it uses `async () => { ... }` (line 1067) without using the result parameter at all, no changes needed there.

    Important details:
    - Per 14-CONTEXT.md: Success message includes template count: "Imported 3 batches, 12 questions, 2 templates"
    - Only show template count if > 0 (old imports without templates shouldn't show "0 templates")
    - Admin theme is LIGHT — do not use dark theme colors
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Run `npx vitest run src/components/SessionImportExport.test.tsx` to check existing component tests pass.
  </verify>
  <done>
    SessionImportExport passes templates to exportSessionData for export, preview shows template count, import callback type includes templateCount. ImportSessionPanel updated similarly. No type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for template export/import schemas and backward compatibility</name>
  <files>src/lib/session-import.test.ts</files>
  <action>
    Add the following test cases to the existing test file:

    **In `exportSessionData` describe block:**

    1. `it('includes template_id on questions when templates provided')`:
       - Create a question with `template_id: 't1'` and a template `{ id: 't1', name: 'Yes/No', options: ['Yes', 'No'] }`.
       - Call `exportSessionData(questions, batches, 'Test', [template])`.
       - Assert the exported question has `template_id: 'Yes/No'` (name, not UUID).
       - Assert the exported data has `templates` array with one entry `{ name: 'Yes/No', options: ['Yes', 'No'] }`.

    2. `it('exports template_id as null for questions without templates')`:
       - Create a question with `template_id: null`.
       - Call `exportSessionData(questions, batches, 'Test', [])`.
       - Assert question.template_id is null.
       - Assert templates array is empty.

    3. `it('exports without templates when no templates parameter provided')`:
       - Call `exportSessionData(questions, batches, 'Test')` (no 4th param).
       - Assert exported data has `templates: []` (empty array, not undefined).

    4. `it('only includes templates referenced by questions')`:
       - Create one question with `template_id: 't1'`.
       - Pass two templates: `t1` (Yes/No) and `t2` (Agree/Disagree).
       - `exportSessionData` should filter to only templates referenced by questions in the data. Assert only the `t1` template appears in the exported templates array, not `t2`.

    **In `ImportSchema` describe block:**

    5. `it('accepts data with templates field')`:
       - Parse data that includes `templates: [{ name: 'Yes/No', options: ['Yes', 'No'] }]`.
       - Assert validation succeeds.

    6. `it('accepts data without templates field (backward compat)')`:
       - Parse data without `templates` field (existing test data format).
       - Assert validation succeeds. This confirms backward compatibility.

    7. `it('accepts questions with template_id field')`:
       - Parse data where question includes `template_id: 'Yes/No'`.
       - Assert validation succeeds.

    8. `it('accepts questions without template_id field (backward compat)')`:
       - Parse data where question does NOT have `template_id`.
       - Assert validation succeeds. This confirms backward compatibility for old exports.

    Important details:
    - Use the existing test patterns (Question/Batch factory objects) from the file.
    - All questions in test data need `template_id: null` in their Question type (already present in existing tests from Phase 12).
    - These are pure schema/function tests — no Supabase mocking needed.
  </action>
  <verify>
    Run `npx vitest run src/lib/session-import.test.ts` — all tests (existing + new) must pass. Run the full test suite `npx vitest run` to check for regressions.
  </verify>
  <done>
    Test file has new tests covering: template_id in exported questions, template array in export, backward compat for ImportSchema without templates, backward compat for questions without template_id. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (no type errors)
2. `npx vitest run src/lib/session-import.test.ts` passes (all existing + new tests)
3. `npx vitest run src/components/SessionImportExport.test.tsx` passes (existing component tests)
4. `npx vitest run` — full test suite passes (no regressions beyond pre-existing failures)
5. Export from SessionImportExport includes templates from store
6. Import preview shows template count when templates are present in import data
</verification>

<success_criteria>
- SessionImportExport.tsx passes templates to export and shows template count in preview/result
- ImportSessionPanel.tsx accepts templateCount in callback type
- Tests verify template fields in export output and schema backward compatibility
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-export-import-integration/14-02-SUMMARY.md`
</output>
